<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Operartis | ABC-XYZ Analysis</title>

    <link rel="icon" type="image/png" href="./icononly_transparent_quadratic.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            gold: '#f59e0b',
                            dark: '#b45309',
                            gray: '#f8fafc',
                            border: '#e2e8f0',
                            slate: '#1e293b'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    },
                    fontSize: {
                        xxs: '0.65rem',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Roboto+Mono:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
        }

        .scroller {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark body {
            background: #0f172a;
        }

        /* Modal Backdrop Blur */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #f59e0b;
            cursor: pointer;
            margin-top: -6px;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }

        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #334155;
        }

        .dark input[type=range]::-webkit-slider-thumb {
            border: 2px solid #1e293b;
        }
    </style>

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.development.js"></script>
    <script crossorigin
        src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.1.12/Recharts.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
</head>

<body>

    <div id="root" class="h-full w-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, PieChart, Pie, Legend, LineChart, Line, ReferenceLine } = window.Recharts;
        const _ = window._;

        // --- ICONS ---
        const MenuIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></svg>;
        const XIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>;
        const SunIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></svg>;
        const MoonIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></svg>;
        const UploadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>;
        const RefreshIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /><path d="M16 21h5v-5" /></svg>;
        const GridIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></svg>;
        const ListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></svg>;
        const SettingsIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>;
        const PaletteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="13.5" cy="6.5" r=".5" /><circle cx="17.5" cy="10.5" r=".5" /><circle cx="8.5" cy="7.5" r=".5" /><circle cx="6.5" cy="12.5" r=".5" /><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" /></svg>;
        const InfoIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>;
        const SystemIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="3" rx="2" /><line x1="8" x2="16" y1="21" y2="21" /><line x1="12" x2="12" y1="17" y2="21" /></svg>;
        const ClockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg>;

        // --- UTILS ---
        const calculateStats = (numbers) => {
            if (!numbers || numbers.length === 0) return { sum: 0, mean: 0, stdDev: 0, cv: 0 };
            const sum = _.sum(numbers);
            const mean = sum / numbers.length;
            const variance = _.sum(numbers.map(n => Math.pow(n - mean, 2))) / numbers.length;
            const stdDev = Math.sqrt(variance);
            const cv = mean === 0 ? 0 : stdDev / mean;
            return { sum, mean, stdDev, cv };
        };

        const fmtCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
        const fmtNum = (val, d = 2) => new Intl.NumberFormat('en-US', { maximumFractionDigits: d }).format(val);

        // --- COMPONENTS ---

        // Custom Tooltip for Pareto Chart
        const CustomParetoTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-white/95 dark:bg-slate-800/95 p-3 border border-slate-200 dark:border-slate-700 rounded-lg shadow-xl backdrop-blur-sm">
                        <p className="text-[10px] uppercase font-bold text-slate-500 dark:text-slate-400 mb-1">
                            Position
                        </p>
                        <p className="text-sm font-bold text-slate-800 dark:text-slate-100 mb-2">
                            Top {fmtNum(label, 1)}% of SKUs
                        </p>
                        <div className="flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-brand-gold"></div>
                            <span className="text-xs text-slate-600 dark:text-slate-300">
                                Value: <span className="font-mono font-bold text-slate-900 dark:text-white">{fmtNum(payload[0].value, 2)}%</span>
                            </span>
                        </div>
                    </div>
                );
            }
            return null;
        };

        // Settings Modal Component
        const SettingsModal = ({ isOpen, onClose, theme, setTheme }) => {
            const [activeTab, setActiveTab] = useState("theme");

            useEffect(() => {
                if (isOpen) setActiveTab("theme");
            }, [isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 modal-backdrop transition-opacity" onClick={onClose}></div>
                    <div className="bg-white dark:bg-slate-900 w-full max-w-5xl h-[85vh] md:h-[80vh] rounded-xl shadow-2xl relative flex flex-col overflow-hidden animate-slide-up border border-slate-200 dark:border-slate-700">
                        {/* Header */}
                        <div className="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-slate-50/50 dark:bg-slate-950/50 shrink-0">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-brand-gold/10 rounded-lg text-brand-gold">
                                    <SettingsIcon />
                                </div>
                                <div>
                                    <h2 className="text-lg font-bold text-slate-800 dark:text-slate-100">Settings</h2>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">Configure application preferences.</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-400 transition-colors">
                                <XIcon />
                            </button>
                        </div>

                        {/* Body Layout */}
                        <div className="flex flex-1 overflow-hidden">
                            {/* Sidebar Nav */}
                            <div className="w-1/4 md:w-64 border-r border-slate-100 dark:border-slate-800 bg-slate-50/30 dark:bg-slate-950/30 p-4 flex flex-col gap-2 overflow-y-auto">
                                <button
                                    onClick={() => setActiveTab("theme")}
                                    className={`text-left px-4 py-3 rounded-lg text-xs font-bold uppercase tracking-wide flex items-center gap-3 transition-colors ${activeTab === 'theme' ? 'bg-brand-gold text-white shadow-md' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}`}
                                >
                                    <PaletteIcon /> Theme Mode
                                </button>
                                <button
                                    onClick={() => setActiveTab("about")}
                                    className={`text-left px-4 py-3 rounded-lg text-xs font-bold uppercase tracking-wide flex items-center gap-3 transition-colors ${activeTab === 'about' ? 'bg-brand-gold text-white shadow-md' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}`}
                                >
                                    <InfoIcon /> About Us
                                </button>
                            </div>

                            {/* Content Area */}
                            <div className="flex-1 overflow-y-auto scroller p-6 md:p-8 relative bg-white dark:bg-slate-900">
                                {activeTab === 'theme' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <div>
                                            <h3 className="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-4">Interface Appearance</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <button onClick={() => setTheme('light')} className={`p-4 rounded-lg border-2 flex flex-col items-center gap-3 transition-all ${theme === 'light' ? 'border-brand-gold bg-brand-gold/5 text-brand-dark' : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700 text-slate-500'}`}>
                                                    <div className="p-3 bg-white rounded-full shadow-sm"><SunIcon /></div>
                                                    <span className="text-sm font-bold">Light Mode</span>
                                                </button>
                                                <button onClick={() => setTheme('dark')} className={`p-4 rounded-lg border-2 flex flex-col items-center gap-3 transition-all ${theme === 'dark' ? 'border-brand-gold bg-brand-gold/5 text-brand-dark dark:text-brand-gold' : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700 text-slate-500'}`}>
                                                    <div className="p-3 bg-slate-800 text-white rounded-full shadow-sm"><MoonIcon /></div>
                                                    <span className="text-sm font-bold">Dark Mode</span>
                                                </button>
                                                <button onClick={() => setTheme('system')} className={`p-4 rounded-lg border-2 flex flex-col items-center gap-3 transition-all ${theme === 'system' ? 'border-brand-gold bg-brand-gold/5 text-brand-dark dark:text-brand-gold' : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700 text-slate-500'}`}>
                                                    <div className="p-3 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-full shadow-sm"><SystemIcon /></div>
                                                    <span className="text-sm font-bold">System Default</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'about' && (
                                    <div className="animate-fade-in space-y-8 max-w-3xl mx-auto">
                                        <div className="text-center space-y-2 mb-8">
                                            <div className="inline-block p-4 bg-brand-gold/10 rounded-full mb-2">
                                                <img src="./icononly_transparent_quadratic.png" className="w-12 h-12 object-contain mx-auto" onError={(e) => e.target.style.display = 'none'} />
                                            </div>
                                            <h2 className="text-2xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">About Operartis</h2>
                                            <p className="text-sm text-brand-gold font-medium uppercase tracking-widest">Optimizing today, Growing tomorrow.</p>
                                        </div>

                                        <div className="prose prose-sm dark:prose-invert max-w-none text-slate-600 dark:text-slate-300 leading-relaxed space-y-6">
                                            <p>
                                                Founded in 2025, Operartis is a specialized consulting and technology firm dedicated to helping enterprises streamline, optimize, and transform their operations. We combine deep expertise in supply chain, logistics, production, warehousing and manufacturing processes with advanced quantitative-optimization and simulation methods to deliver meaningful, measurable improvements.
                                            </p>
                                            <p>
                                                At Operartis, we understand that having data in an Enterprise Resource Planning (ERP) system is only the first step. True operational excellence requires turning that data into actionable planning, forecasting and scheduling insights. That’s why we focus on building, developing, and continuously improving a tailored Advanced Planning and Scheduling System (APS) — helping our clients leverage their data not just for record-keeping, but for real operational advantage.
                                            </p>

                                            <div className="grid md:grid-cols-2 gap-6 my-8">
                                                {/* What We Do Box */}
                                                <div className="bg-slate-50 dark:bg-slate-900/50 p-5 rounded-lg border border-slate-100 dark:border-slate-800 flex flex-col h-full">
                                                    <h3 className="text-sm font-bold text-brand-dark dark:text-brand-gold uppercase tracking-wider mb-3">What We Do</h3>
                                                    <div className="space-y-3 text-xs text-slate-600 dark:text-slate-300">
                                                        <p className="leading-relaxed">We consult with businesses to thoroughly analyze their supply chain, warehousing, logistics and production workflows — identifying inefficiencies, bottlenecks, and opportunities for optimization.</p>
                                                        <p className="leading-relaxed">We design and implement APS systems that integrate with existing ERPs (or, where needed, stand-alone), enabling advanced planning, simulation, demand forecasting, capacity planning and production scheduling.</p>
                                                        <p className="leading-relaxed">We support companies through all stages: from initial assessment and system design, to deployment, staff training, and continuous improvement — ensuring sustainable value over time.</p>
                                                    </div>
                                                </div>

                                                {/* Vision Box */}
                                                <div className="bg-slate-50 dark:bg-slate-900/50 p-5 rounded-lg border border-slate-100 dark:border-slate-800 flex flex-col h-full">
                                                    <h3 className="text-sm font-bold text-brand-dark dark:text-brand-gold uppercase tracking-wider mb-3">Our Vision & Philosophy</h3>
                                                    <div className="space-y-3 text-xs text-slate-600 dark:text-slate-300">
                                                        <p className="leading-relaxed">We believe that every enterprise — whether small, medium or large — deserves access to powerful tools and expert guidance at reasonable price levels.</p>
                                                        <p className="leading-relaxed">We envision a world in which companies can guarantee that their entire supply chain works efficiently and in an optimized manner — saving time, effort, and costs, while ensuring smooth operations and high customer satisfaction.</p>
                                                        <p className="leading-relaxed">By embedding advanced optimization methods into an all-in-one APS system, Operartis helps unlock hidden potential in operational data — transforming raw information into strategic advantage, sustainable growth, and robust competitiveness.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Column Mapping Modal
        const MappingModal = ({ headers, isOpen, onClose, onConfirm }) => {
            const [skuCol, setSkuCol] = useState('');
            const [costCol, setCostCol] = useState('');
            const [dataCols, setDataCols] = useState([]);

            useEffect(() => {
                if (isOpen && headers.length > 0) {
                    // Smart Defaults
                    const skuPotential = headers.find(h => /sku|id|code|item|part/i.test(h));
                    const costPotential = headers.find(h => /cost|price|value|eur|usd/i.test(h));

                    setSkuCol(skuPotential || headers[0]);
                    setCostCol(costPotential || headers[1]);
                    // Default data cols are all except sku and cost (simplified)
                    setDataCols([]);
                }
            }, [isOpen, headers]);

            const toggleDataCol = (col) => {
                if (dataCols.includes(col)) setDataCols(dataCols.filter(c => c !== col));
                else setDataCols([...dataCols, col]);
            };

            const selectAllData = () => {
                const nonMeta = headers.filter(h => h !== skuCol && h !== costCol);
                setDataCols(nonMeta);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh] border border-slate-200 dark:border-slate-700">
                        {/* Header */}
                        <div className="p-6 border-b border-slate-200 dark:border-slate-800">
                            <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100">Map Your Data Columns</h2>
                            <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">Select which columns represent what data.</p>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-6">
                            <div className="grid grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-xs font-bold uppercase text-slate-500 mb-2">Item ID / SKU Column</label>
                                    <select value={skuCol} onChange={e => setSkuCol(e.target.value)} className="w-full p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 text-slate-800 dark:text-slate-200 text-sm">
                                        {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold uppercase text-slate-500 mb-2">Unit Cost Column</label>
                                    <select value={costCol} onChange={e => setCostCol(e.target.value)} className="w-full p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 text-slate-800 dark:text-slate-200 text-sm">
                                        {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                    </select>
                                </div>
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-xs font-bold uppercase text-slate-500">Demand Data Columns (Select all that apply)</label>
                                    <button onClick={selectAllData} className="text-xs text-brand-gold hover:underline">Select All Remaining</button>
                                </div>
                                <div className="grid grid-cols-3 sm:grid-cols-4 gap-2 border p-3 rounded bg-slate-50 dark:bg-slate-800/50 dark:border-slate-700 max-h-48 overflow-y-auto">
                                    {headers.map(h => (
                                        <button
                                            key={h}
                                            onClick={() => toggleDataCol(h)}
                                            className={`text-xs px-2 py-1.5 rounded text-left truncate transition-colors ${dataCols.includes(h)
                                                ? 'bg-brand-gold text-white shadow-sm'
                                                : (h === skuCol || h === costCol)
                                                    ? 'bg-slate-200 dark:bg-slate-700 text-slate-400 cursor-not-allowed opacity-50'
                                                    : 'bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:border-brand-gold'
                                                }`}
                                            disabled={h === skuCol || h === costCol}
                                        >
                                            {h}
                                        </button>
                                    ))}
                                </div>
                                <p className="text-xs text-slate-400 mt-2">
                                    *Selected: {dataCols.length} columns. These will be summed to calculate total demand.
                                </p>
                            </div>
                        </div>
                        <div className="p-4 border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 flex justify-end gap-3 rounded-b-xl">
                            <button onClick={onClose} className="px-4 py-2 text-sm text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200">Cancel</button>
                            <button
                                onClick={() => onConfirm(skuCol, costCol, dataCols)}
                                disabled={!skuCol || !costCol || dataCols.length === 0}
                                className="px-6 py-2 bg-brand-gold hover:bg-brand-dark text-white text-sm font-bold rounded shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                Analyze Data
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const MainApp = () => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'system');
            const [file, setFile] = useState(null);
            const [rawJson, setRawJson] = useState([]);
            const [headers, setHeaders] = useState([]);
            const [isMappingOpen, setIsMappingOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [time, setTime] = useState(new Date());
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);

            // Configuration State
            const [abcThresholds, setAbcThresholds] = useState({ a: 80, b: 95 }); // A: 0-80, B: 80-95, C: >95
            const [xyzThresholds, setXyzThresholds] = useState({ x: 0.5, y: 1.0 }); // X: <0.5, Y: 0.5-1.0, Z: >1.0

            // Processed Data
            const [analysisData, setAnalysisData] = useState([]);
            const [matrix, setMatrix] = useState({});
            const [summary, setSummary] = useState({});

            // UI State
            const [activeTab, setActiveTab] = useState('dashboard'); // dashboard, list
            const [searchTerm, setSearchTerm] = useState('');
            const [filterClass, setFilterClass] = useState(null);
            const fileInputRef = useRef(null);

            // Clock Effect
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // Theme Effect
            useEffect(() => {
                const applyTheme = () => {
                    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    let effectiveDark = false;
                    if (theme === 'dark') effectiveDark = true;
                    else if (theme === 'light') effectiveDark = false;
                    else effectiveDark = systemPrefersDark;

                    if (effectiveDark) { document.documentElement.classList.add('dark'); }
                    else { document.documentElement.classList.remove('dark'); }
                    localStorage.setItem('theme', theme);
                };
                applyTheme();
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const handleSystemChange = () => { if (theme === 'system') applyTheme(); };
                mediaQuery.addEventListener('change', handleSystemChange);
                return () => mediaQuery.removeEventListener('change', handleSystemChange);
            }, [theme]);

            // File Handler
            const handleFileUpload = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary', cellDates: true });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];

                    // Pass 1: Get Headers with formatting (preserves dates like "Jan 25")
                    const formattedData = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });

                    // Pass 2: Get Data with raw values (for numbers/math)
                    const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });

                    if (rawData.length > 1) {
                        setHeaders(formattedData[0]); // UI gets nice headers
                        setRawJson(rawData.slice(1)); // Logic gets raw numbers
                        setFile(f);
                        setIsMappingOpen(true);
                    }
                };
                reader.readAsBinaryString(f);
            };

            const processAnalysis = (skuCol, costCol, dataCols) => {
                setIsMappingOpen(false);
                const skuIdx = headers.indexOf(skuCol);
                const costIdx = headers.indexOf(costCol);
                const dataIndices = dataCols.map(c => headers.indexOf(c));

                let processed = rawJson.map(row => {
                    const sku = row[skuIdx] || 'Unknown';
                    const cost = parseFloat(row[costIdx]) || 0;
                    const demandValues = dataIndices.map(i => parseFloat(row[i]) || 0);
                    const stats = calculateStats(demandValues);
                    const totalValue = stats.sum * cost;

                    return {
                        sku,
                        cost,
                        demandHistory: demandValues,
                        totalQty: stats.sum,
                        totalValue,
                        avgDemand: stats.mean,
                        cv: stats.cv
                    };
                });

                // Sort for ABC
                processed.sort((a, b) => b.totalValue - a.totalValue);
                const grandTotalValue = _.sumBy(processed, 'totalValue');

                let runningValue = 0;
                processed = processed.map((item, index) => {
                    runningValue += item.totalValue;
                    const cumPct = (runningValue / grandTotalValue) * 100;
                    item.cumPct = cumPct;
                    item.itemPct = ((index + 1) / processed.length) * 100; // Track item % rank for Pareto Chart X-Axis
                    return item;
                });

                setAnalysisData(processed);
            };

            const handleReset = () => {
                setFile(null);
                setRawJson([]);
                setHeaders([]);
                setIsMappingOpen(false);
                setAbcThresholds({ a: 80, b: 95 });
                setXyzThresholds({ x: 0.5, y: 1.0 });
                setAnalysisData([]);
                setMatrix({});
                setSummary({});
                setActiveTab('dashboard');
                setSearchTerm('');
                if (fileInputRef.current) fileInputRef.current.value = "";
                setIsSidebarOpen(false);
            };

            const handleExport = () => {
                if (analysisData.length === 0) return;

                const ws = XLSX.utils.aoa_to_sheet([]);
                const wb = XLSX.utils.book_new();

                // --- STYLES ---
                const titleStyle = { font: { name: "Arial", sz: 24, bold: true, color: { rgb: "E38800" } }, alignment: { horizontal: "left" } };
                const subtitleStyle = { font: { name: "Arial", sz: 12, italic: true, color: { rgb: "E38800" } } };
                const headerStyle = { fill: { fgColor: { rgb: "FFFFFF" } }, font: { name: "Arial", sz: 10, bold: true }, border: { top: { style: "thick" }, bottom: { style: "thick" }, left: { style: "thick" }, right: { style: "thick" } } };
                const labelStyle = { fill: { fgColor: { rgb: "EFEFEF" } }, font: { name: "Arial", sz: 10, bold: true }, border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } } };
                const valueStyle = { font: { name: "Arial", sz: 10 }, border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } } };
                const tableHeaderStyle = { fill: { fgColor: { rgb: "101f3a" } }, font: { name: "Arial", sz: 11, bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };

                // --- CONTENT ---
                // 1. Logo & Title Area (Logo Placeholder)
                XLSX.utils.sheet_add_aoa(ws, [
                    ["OPERARTIS ANALYTICS REPORT"],
                    ["Optimizing Today, Growing Tomorrow."]
                ], { origin: "C2" });

                // 2. Metadata Box
                const metaStartRow = 5;
                XLSX.utils.sheet_add_aoa(ws, [
                    ["Report By:", "Operartis Analytics", "", "Report Date:", new Date().toLocaleString()],
                    ["Report For:", "ABC-XYZ Analysis", "", "Total SKUs:", summary.totalSkus],
                    ["Version:", "1.0", "", "Total Value:", fmtCurrency(summary.totalValue)]
                ], { origin: `B${metaStartRow}` });

                // 3. Matrix Summary
                const matrixStartRow = 10;
                XLSX.utils.sheet_add_aoa(ws, [["MATRIX SUMMARY"]], { origin: `B${matrixStartRow}` });

                const matrixHeader = ["", "X (Low Var)", "Y (Med Var)", "Z (High Var)"];
                const matrixRows = [
                    ["A (High Val)", matrix['AX']?.count || 0, matrix['AY']?.count || 0, matrix['AZ']?.count || 0],
                    ["B (Med Val)", matrix['BX']?.count || 0, matrix['BY']?.count || 0, matrix['BZ']?.count || 0],
                    ["C (Low Val)", matrix['CX']?.count || 0, matrix['CY']?.count || 0, matrix['CZ']?.count || 0]
                ];

                XLSX.utils.sheet_add_aoa(ws, [matrixHeader, ...matrixRows], { origin: `B${matrixStartRow + 1}` });

                // 4. Detailed Item Table
                const tableStartRow = 17;
                const columns = ["Class", "SKU", "Total Value", "Total Qty", "Avg Demand", "CV", "ABC", "XYZ"];
                const tableData = analysisData.map(item => [
                    item.class,
                    item.sku,
                    item.totalValue,
                    item.totalQty,
                    item.avgDemand,
                    item.cv,
                    item.abc,
                    item.xyz
                ]);

                XLSX.utils.sheet_add_aoa(ws, [columns, ...tableData], { origin: `B${tableStartRow}` });

                // --- FORMATTING APPLIED ---
                // Apply styles to cells manually loop

                // Title
                ws["C2"].s = titleStyle;
                ws["C3"].s = subtitleStyle;

                // Metadata Box Formatting
                for (let r = 0; r < 3; r++) {
                    const R = metaStartRow + r;
                    // Labels
                    if (!ws[`B${R}`]) ws[`B${R}`] = { v: "" }; ws[`B${R}`].s = labelStyle;
                    if (!ws[`E${R}`]) ws[`E${R}`] = { v: "" }; ws[`E${R}`].s = labelStyle;
                    // Values
                    if (!ws[`C${R}`]) ws[`C${R}`] = { v: "" }; ws[`C${R}`].s = valueStyle;
                    if (!ws[`F${R}`]) ws[`F${R}`] = { v: "" }; ws[`F${R}`].s = valueStyle;
                }

                // Table Header
                for (let c = 0; c < columns.length; c++) {
                    const cellRef = XLSX.utils.encode_cell({ r: tableStartRow - 1, c: c + 1 }); // Col B is index 1
                    if (!ws[cellRef]) ws[cellRef] = { v: "" };
                    ws[cellRef].s = tableHeaderStyle;
                }

                // Table Data Border & Conditional Formats
                tableData.forEach((row, ri) => {
                    row.forEach((val, ci) => {
                        const cellRef = XLSX.utils.encode_cell({ r: tableStartRow + ri, c: ci + 1 });
                        if (!ws[cellRef]) ws[cellRef] = { v: val };
                        ws[cellRef].s = {
                            border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } },
                            numFmt: (ci === 2) ? '"$"#,##0' : (ci === 3 || ci === 4) ? '#,##0.0' : (ci === 5) ? '0.00' : undefined
                        };

                        // Color Coding for Class Column (Index 0)
                        if (ci === 0) {
                            let bg = "FFFFFF";
                            if (val.startsWith('A')) bg = (val.endsWith('X') ? "D1FAE5" : val.endsWith('Y') ? "FEF3C7" : "FFE4E6"); // Emerald-100 / Amber-100 / Rose-100
                            else if (val.startsWith('B')) bg = (val.endsWith('X') ? "DBEAFE" : val.endsWith('Y') ? "FEF3C7" : "FFE4E6");
                            else if (val.startsWith('C')) bg = "F1F5F9"; // Slate-100

                            ws[cellRef].s.fill = { fgColor: { rgb: bg } };
                            ws[cellRef].s.font = { bold: true };
                        }
                    });
                });

                // Column Widths
                ws['!cols'] = [
                    { wch: 2 },  // A (Margin)
                    { wch: 10 }, // B (Class)
                    { wch: 20 }, // C (SKU)
                    { wch: 15 }, // D (Val)
                    { wch: 15 }, // E (Qty)
                    { wch: 15 }, // F (Avg)
                    { wch: 10 }, // G (CV)
                    { wch: 8 },  // H (A)
                    { wch: 8 }   // I (X)
                ];

                XLSX.utils.book_append_sheet(wb, ws, "Analysis Report");
                XLSX.writeFile(wb, "Operartis_ABC_Activity_Report.xlsx");
            };

            // Recalculate Classes whenever sliders or data change
            useEffect(() => {
                if (analysisData.length === 0) return;

                const classified = analysisData.map(item => {
                    // ABC Logic
                    let abcClass = 'C';
                    if (item.cumPct <= abcThresholds.a) abcClass = 'A';
                    else if (item.cumPct <= abcThresholds.b) abcClass = 'B';

                    // XYZ Logic
                    let xyzClass = 'Z';
                    if (item.cv <= xyzThresholds.x) xyzClass = 'X';
                    else if (item.cv <= xyzThresholds.y) xyzClass = 'Y';

                    return { ...item, class: `${abcClass}${xyzClass}`, abc: abcClass, xyz: xyzClass };
                });

                // Generate Matrix & Summary
                const grp = _.groupBy(classified, 'class');
                const classes = ['AX', 'AY', 'AZ', 'BX', 'BY', 'BZ', 'CX', 'CY', 'CZ'];

                const matrixData = {};
                classes.forEach(c => {
                    const items = grp[c] || [];
                    matrixData[c] = {
                        count: items.length,
                        value: _.sumBy(items, 'totalValue'),
                        pctCount: (items.length / classified.length) * 100,
                        pctValue: (_.sumBy(items, 'totalValue') / _.sumBy(classified, 'totalValue')) * 100
                    };
                });

                setMatrix(matrixData);
                setAnalysisData(classified); // Update with classes
                setSummary({
                    totalSkus: classified.length,
                    totalValue: _.sumBy(classified, 'totalValue'),
                    topItem: classified[0].sku
                });

            }, [abcThresholds, xyzThresholds, analysisData.length]);



            return (
                <div className="flex h-full bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 transition-colors duration-300">

                    {/* SIDEBAR - Responsive */}
                    <aside className={`fixed md:relative inset-y-0 left-0 z-50 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shrink-0 shadow-2xl md:shadow-none transform transition-transform duration-300 ease-in-out ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'} w-64`}>
                        <div className="h-16 flex items-center px-4 border-b border-slate-200 dark:border-slate-800 shrink-0 gap-3 justify-center">
                            <a href="https://operartis.vercel.app/terminal.html" className="hover:opacity-80 transition-opacity">
                                <img src="./icononly_transparent_quadratic.png" className="h-10 w-10" onError={(e) => e.target.style.display = 'none'} />
                            </a>
                            <span className="font-bold text-lg tracking-tight truncate">OPERARTIS</span>
                            <button onClick={() => setIsSidebarOpen(false)} className="md:hidden absolute right-4 text-slate-400 hover:text-red-500">
                                <XIcon />
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto px-2 py-4 scroller relative flex flex-col">

                            {/* File Upload Section */}
                            <div className="flex items-center gap-2 mb-2 mt-2 px-1">
                                <h3 className="text-xxs font-bold text-amber-600 dark:text-amber-500 uppercase tracking-widest whitespace-nowrap">Data Import</h3>
                                <div className="h-px flex-1 bg-amber-600 dark:bg-amber-500"></div>
                            </div>

                            <div className="px-1 mb-4">
                                <div
                                    onClick={() => fileInputRef.current.click()}
                                    className={`border-2 border-dashed rounded-xl p-4 mx-2 text-center cursor-pointer transition-all hover:scale-[1.02] ${file ? 'border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20' : 'border-slate-300 dark:border-slate-700 hover:border-brand-gold'}`}
                                >
                                    <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" accept=".xlsx,.xls,.csv" />
                                    <div className="flex flex-col items-center gap-2">
                                        <div className="text-slate-400">{file ? <RefreshIcon /> : <UploadIcon />}</div>
                                        <p className="text-xs font-bold text-slate-600 dark:text-slate-300 truncate w-full">
                                            {file ? file.name : "Upload Data"}
                                        </p>
                                        {file && <span className="text-[10px] font-bold text-emerald-600 bg-emerald-100 dark:bg-emerald-900 px-2 py-0.5 rounded-full">Loaded</span>}
                                    </div>
                                </div>
                            </div>

                            {/* Configuration Section */}
                            {analysisData.length > 0 && (
                                <div className="animate-fade-in">
                                    <div className="flex items-center gap-2 mb-2 mt-6 px-1">
                                        <h3 className="text-xxs font-bold text-amber-600 dark:text-amber-500 uppercase tracking-widest whitespace-nowrap">Configuration</h3>
                                        <div className="h-px flex-1 bg-amber-600 dark:bg-amber-500"></div>
                                    </div>

                                    <div className="px-1 space-y-4">

                                        {/* ABC Settings */}
                                        <div className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-800">
                                            <div className="flex justify-between items-center mb-3">
                                                <h3 className="text-xxs font-bold text-slate-500 dark:text-slate-400 uppercase">ABC Class (Pareto)</h3>
                                            </div>
                                            <div className="space-y-4">
                                                <div>
                                                    <div className="flex justify-between text-xxs font-bold mb-1">
                                                        <span className="text-emerald-500">A</span>
                                                        <span className="text-slate-600 dark:text-slate-300">Top {abcThresholds.a}%</span>
                                                    </div>
                                                    <input
                                                        type="range" min="10" max="90" step="1"
                                                        value={abcThresholds.a}
                                                        onChange={e => setAbcThresholds({ ...abcThresholds, a: parseInt(e.target.value) })}
                                                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700"
                                                    />
                                                </div>
                                                <div>
                                                    <div className="flex justify-between text-xxs font-bold mb-1">
                                                        <span className="text-blue-500">B</span>
                                                        <span className="text-slate-600 dark:text-slate-300">Next {abcThresholds.b - abcThresholds.a}%</span>
                                                    </div>
                                                    <input
                                                        type="range" min={abcThresholds.a + 1} max="99" step="1"
                                                        value={abcThresholds.b}
                                                        onChange={e => setAbcThresholds({ ...abcThresholds, b: parseInt(e.target.value) })}
                                                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        {/* XYZ Settings */}
                                        <div className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-800">
                                            <div className="flex justify-between items-center mb-3">
                                                <h3 className="text-xxs font-bold text-slate-500 dark:text-slate-400 uppercase">XYZ Class (CV)</h3>
                                            </div>
                                            <div className="space-y-4">
                                                <div>
                                                    <div className="flex justify-between text-xxs font-bold mb-1">
                                                        <span className="text-emerald-500">X</span>
                                                        <span className="text-slate-600 dark:text-slate-300">CV &lt; {xyzThresholds.x}</span>
                                                    </div>
                                                    <input
                                                        type="range" min="0.1" max="1.5" step="0.05"
                                                        value={xyzThresholds.x}
                                                        onChange={e => setXyzThresholds({ ...xyzThresholds, x: parseFloat(e.target.value) })}
                                                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700"
                                                    />
                                                </div>
                                                <div>
                                                    <div className="flex justify-between text-xxs font-bold mb-1">
                                                        <span className="text-rose-500">Z</span>
                                                        <span className="text-slate-600 dark:text-slate-300">CV &gt; {xyzThresholds.y}</span>
                                                    </div>
                                                    <input
                                                        type="range" min={xyzThresholds.x + 0.1} max="3.0" step="0.05"
                                                        value={xyzThresholds.y}
                                                        onChange={e => setXyzThresholds({ ...xyzThresholds, y: parseFloat(e.target.value) })}
                                                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            )}

                        </div>

                        {/* Reset Button (Sticky above footer) */}
                        <div className="px-3 py-2 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 shrink-0 z-10">
                            <button
                                onClick={handleReset}
                                className="w-full flex items-center justify-center gap-2 py-3 px-4 rounded-xl border border-rose-200 dark:border-rose-900 text-rose-500 dark:text-rose-400 font-bold text-xs hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-all uppercase tracking-wider group"
                            >
                                <RefreshIcon /> Reset All
                            </button>
                            {analysisData.length > 0 && (
                                <button
                                    onClick={handleExport}
                                    className="w-full mt-2 flex items-center justify-center gap-2 py-3 px-4 rounded-xl bg-brand-gold text-white font-bold text-xs hover:bg-brand-dark transition-all uppercase tracking-wider shadow-md hover:shadow-lg"
                                >
                                    <DownloadIcon /> Export Report
                                </button>
                            )}
                        </div>

                        {/* Sticky Bottom Area */}
                        <div className="bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 p-4 shrink-0 z-10">
                            <div className="text-center">
                                <p className="text-xs font-black text-slate-700 dark:text-slate-300 uppercase tracking-widest">Operartis Analytics</p>
                                <p className="text-[10px] text-amber-600 dark:text-amber-500 italic mt-1 font-medium">Optimizing Today, Growing Tomorrow</p>
                            </div>
                        </div>
                    </aside>

                    {/* Backdrop for mobile sidebar */}
                    {isSidebarOpen && <div className="fixed inset-0 bg-black/60 z-40 md:hidden backdrop-blur-sm transition-opacity" onClick={() => setIsSidebarOpen(false)}></div>}

                    {/* MAIN CONTENT */}
                    <main className="flex-1 flex flex-col overflow-hidden relative">
                        {/* TOP Header - Always Visible */}
                        <div className="h-16 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-4 md:px-8 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm shrink-0 relative z-20">
                            <div className="flex gap-4 items-center">
                                {/* Mobile Menu Button */}
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-1 text-slate-500 hover:text-brand-gold focus:outline-none dark:text-slate-400">
                                    <MenuIcon />
                                </button>
                            </div>

                            {/* Centered Title */}
                            <div className="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 text-sm md:text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-brand-gold to-brand-dark uppercase tracking-widest drop-shadow-sm whitespace-nowrap">
                                ABC-XYZ ANALYSIS
                            </div>

                            <div className="flex items-center gap-2 md:gap-4">
                                {/* Clock - Always Visible */}
                                <div className="hidden sm:flex items-center gap-2 text-xs font-mono text-slate-500 dark:text-slate-400">
                                    <ClockIcon />
                                    <span>{time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                </div>

                                <button onClick={() => setIsSettingsOpen(true)} className="text-slate-400 hover:text-brand-gold dark:text-slate-500 dark:hover:text-yellow-400 transition-colors flex items-center gap-2">
                                    <SettingsIcon />
                                </button>
                            </div>
                        </div>

                        {/* SECONDARY Navigation Bar (Tabs & Metrics) */}
                        <div className="h-14 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-4 md:px-8 bg-white dark:bg-slate-900 shrink-0 relative z-10 overflow-x-auto no-scrollbar gap-4">
                            <div className="flex gap-4 items-center h-full shrink-0">
                                <button
                                    onClick={() => setActiveTab('dashboard')}
                                    className={`h-full border-b-2 px-2 text-xs md:text-sm font-bold transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'dashboard' ? 'border-brand-gold text-brand-gold' : 'border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'}`}
                                >
                                    <GridIcon /> <span className="hidden sm:inline">Matrix Dashboard</span>
                                </button>
                                <button
                                    onClick={() => setActiveTab('list')}
                                    className={`h-full border-b-2 px-2 text-xs md:text-sm font-bold transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'list' ? 'border-brand-gold text-brand-gold' : 'border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'}`}
                                >
                                    <ListIcon /> <span className="hidden sm:inline">Item List</span>
                                    {analysisData.length > 0 && <span className="text-[10px] bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded-full ml-1">
                                        {filterClass ? (matrix[filterClass]?.count || 0) : analysisData.length}
                                    </span>}
                                </button>

                                {/* Search SKU Input (Moved here) */}
                                <div className="h-8 border-l border-slate-200 dark:border-slate-800 ml-2 pl-4 flex items-center shrink-0 gap-2">
                                    <input
                                        type="text"
                                        placeholder="Search SKU..."
                                        value={searchTerm}
                                        onChange={e => { setSearchTerm(e.target.value); if (activeTab !== 'list') setActiveTab('list'); }}
                                        className="bg-slate-100 dark:bg-slate-800 border-none rounded-md px-3 py-1.5 text-xs w-48 md:w-64 focus:ring-1 focus:ring-brand-gold outline-none transition-all placeholder-slate-400"
                                    />
                                    {filterClass && (
                                        <div className="flex items-center gap-1 bg-brand-gold/10 text-brand-gold px-2 py-1 rounded text-[10px] font-bold uppercase cursor-pointer hover:bg-rose-50 hover:text-rose-500 transition-colors" onClick={() => setFilterClass(null)}>
                                            <span>Class: {filterClass}</span>
                                            <XIcon />
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Conditional Total Value Metric */}
                            {analysisData.length > 0 && (
                                <div className="flex items-center gap-3 shrink-0 ml-auto">
                                    <div className="text-right">
                                        <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Inventory Value</div>
                                        <div className="font-mono font-bold text-sm md:text-base text-slate-800 dark:text-slate-200">{fmtCurrency(summary.totalValue)}</div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {analysisData.length === 0 ? (
                            <div className="flex-1 flex flex-col items-center justify-center p-8 opacity-60">
                                <div className="p-6 bg-white dark:bg-slate-900 rounded-full mb-6 shadow-sm border border-slate-100 dark:border-slate-800">
                                    <GridIcon />
                                </div>
                                <h2 className="text-2xl font-bold mb-2 text-center">Ready to Analyze</h2>
                                <p className="text-slate-500 max-w-md text-center text-sm md:text-base">
                                    Upload your inventory Excel file to generate the ABC-XYZ matrix, identify critical items, and optimize your supply chain policies.
                                </p>
                            </div>
                        ) : (
                            <>
                                {/* Dashboard View */}
                                {activeTab === 'dashboard' && (
                                    <div className="flex-1 overflow-y-auto p-4 md:p-8 scroller">
                                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

                                            {/* THE MATRIX */}
                                            <div className="lg:col-span-2 bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm p-4 md:p-6">
                                                <h3 className="text-lg font-bold mb-6 flex items-center gap-2">
                                                    Inventory Matrix
                                                    <span className="text-xs font-normal text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded">SKU Count & Value %</span>
                                                </h3>
                                                <div className="grid grid-cols-3 gap-2 md:gap-4 h-[300px] md:h-[400px]">
                                                    {['A', 'B', 'C'].map(row => (
                                                        ['X', 'Y', 'Z'].map(col => {
                                                            const key = `${row}${col}`;
                                                            const data = matrix[key] || { count: 0, pctValue: 0, pctCount: 0 };

                                                            // Gradient Logic for Matrix Cards
                                                            // A=Emerald, B=Blue, C=Slate
                                                            // X=Emerald, Y=Amber, Z=Rose
                                                            let bgClass = 'bg-white dark:bg-slate-800'; // Default

                                                            if (key === 'AX') bgClass = 'bg-gradient-to-br from-emerald-100 to-emerald-200 dark:from-emerald-900/40 dark:to-emerald-800/40 border-emerald-200 dark:border-emerald-700';
                                                            else if (key === 'AY') bgClass = 'bg-gradient-to-br from-emerald-50 to-amber-100 dark:from-emerald-900/20 dark:to-amber-900/20 border-emerald-100 dark:border-emerald-800';
                                                            else if (key === 'AZ') bgClass = 'bg-gradient-to-br from-emerald-50 to-rose-100 dark:from-emerald-900/10 dark:to-rose-900/20 border-rose-100 dark:border-rose-900';

                                                            else if (key === 'BX') bgClass = 'bg-gradient-to-br from-blue-100 to-emerald-100 dark:from-blue-900/30 dark:to-emerald-900/20 border-blue-200 dark:border-blue-800';
                                                            else if (key === 'BY') bgClass = 'bg-gradient-to-br from-blue-50 to-amber-100 dark:from-blue-900/20 dark:to-amber-900/20 border-blue-100 dark:border-blue-800';
                                                            else if (key === 'BZ') bgClass = 'bg-gradient-to-br from-blue-50 to-rose-100 dark:from-blue-900/20 dark:to-rose-900/20 border-rose-100 dark:border-rose-900';

                                                            else if (key === 'CX') bgClass = 'bg-gradient-to-br from-slate-200 to-emerald-100 dark:from-slate-800 dark:to-emerald-900/20 border-slate-300 dark:border-slate-700';
                                                            else if (key === 'CY') bgClass = 'bg-gradient-to-br from-slate-200 to-amber-100 dark:from-slate-800 dark:to-amber-900/20 border-slate-300 dark:border-slate-700';
                                                            else if (key === 'CZ') bgClass = 'bg-gradient-to-br from-slate-200 to-rose-100 dark:from-slate-800 dark:to-rose-900/20 border-slate-300 dark:border-slate-700';

                                                            return (
                                                                <div
                                                                    key={key}
                                                                    onClick={() => { setFilterClass(key); setActiveTab('list'); }}
                                                                    className={`rounded-lg border p-2 md:p-4 flex flex-col justify-between relative overflow-hidden transition-all hover:scale-[1.02] hover:shadow-md cursor-pointer ${bgClass}`}
                                                                >
                                                                    <div className="absolute top-1 right-1 md:top-2 md:right-2 text-xl md:text-2xl font-black pointer-events-none flex">
                                                                        <span className={row === 'A' ? 'text-emerald-500' : row === 'B' ? 'text-blue-500' : 'text-slate-600 dark:text-slate-400'}>{row}</span>
                                                                        <span className={col === 'X' ? 'text-emerald-500' : col === 'Y' ? 'text-brand-gold' : 'text-rose-500'}>{col}</span>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xl md:text-3xl font-bold text-slate-800 dark:text-slate-100">{data.count}</div>
                                                                        <div className="text-[10px] md:text-xs text-slate-500 uppercase font-bold tracking-wider">SKUs</div>
                                                                    </div>
                                                                    <div className="mt-2 md:mt-4">
                                                                        <div className="w-full bg-slate-200 dark:bg-slate-700 h-1.5 rounded-full mb-1 overflow-hidden">
                                                                            <div className="h-full bg-brand-gold" style={{ width: `${data.pctValue}%` }}></div>
                                                                        </div>
                                                                        <div className="flex flex-col md:flex-row justify-between text-[8px] md:text-[10px] font-mono font-bold text-slate-500">
                                                                            <span>Val: {fmtNum(data.pctValue, 1)}%</span>
                                                                            <span>Qty: {fmtNum(data.pctCount, 1)}%</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })
                                                    ))}
                                                </div>

                                                {/* Matrix Labels */}
                                                <div className="flex justify-between mt-4 text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-widest px-2 md:px-4">
                                                    <span>Stable (X)</span>
                                                    <span>Fluctuating (Y)</span>
                                                    <span>Volatile (Z)</span>
                                                </div>
                                            </div>

                                            {/* Pareto Chart */}
                                            <div className="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm p-4 md:p-6 flex flex-col">
                                                <h3 className="text-lg font-bold mb-4">Pareto Curve</h3>
                                                <div className="flex-1 w-full min-h-[300px]">
                                                    <ResponsiveContainer width="100%" height="100%">
                                                        <LineChart
                                                            data={analysisData.filter((_, i) => i % Math.ceil(analysisData.length / 50) === 0)}
                                                            margin={{ top: 5, right: 5, bottom: 20, left: 10 }}
                                                        >
                                                            <defs>
                                                                <linearGradient id="paretoGradient" x1="0" y1="0" x2="0" y2="1">
                                                                    <stop offset="0%" stopColor="#64748b" />
                                                                    <stop offset={`${100 - abcThresholds.b}%`} stopColor="#64748b" />
                                                                    <stop offset={`${100 - abcThresholds.b}%`} stopColor="#3b82f6" />
                                                                    <stop offset={`${100 - abcThresholds.a}%`} stopColor="#3b82f6" />
                                                                    <stop offset={`${100 - abcThresholds.a}%`} stopColor="#10b981" />
                                                                    <stop offset="100%" stopColor="#10b981" />
                                                                </linearGradient>
                                                            </defs>
                                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                            <XAxis
                                                                dataKey="itemPct"
                                                                type="number"
                                                                domain={[0, 100]}
                                                                tick={{ fontSize: 10 }}
                                                                label={{ value: '% of SKUs', position: 'insideBottom', offset: -10, fontSize: 10, fill: '#64748b' }}
                                                            />
                                                            <YAxis
                                                                dataKey="cumPct"
                                                                domain={[0, 100]}
                                                                tick={{ fontSize: 10 }}
                                                                unit="%"
                                                                label={{ value: 'Cumulative Value %', angle: -90, position: 'insideLeft', offset: 10, fontSize: 10, fill: '#64748b' }}
                                                            />
                                                            <Tooltip content={<CustomParetoTooltip />} cursor={{ stroke: '#64748b', strokeWidth: 1 }} />
                                                            <ReferenceLine y={abcThresholds.a} stroke="#10b981" strokeDasharray="3 3" label={{ value: 'A Limit', fill: '#10b981', fontSize: 10, position: 'insideTopLeft' }} />
                                                            <ReferenceLine y={abcThresholds.b} stroke="#3b82f6" strokeDasharray="3 3" label={{ value: 'B Limit', fill: '#3b82f6', fontSize: 10, position: 'insideTopLeft' }} />
                                                            <Line type="monotone" dataKey="cumPct" stroke="url(#paretoGradient)" strokeWidth={3} dot={false} />
                                                        </LineChart>
                                                    </ResponsiveContainer>
                                                </div>
                                                <div className="mt-4 text-xs text-slate-500 text-center">
                                                    Cumulative Value Distribution
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                )}

                                {/* List View */}
                                {activeTab === 'list' && (
                                    <div className="flex-1 flex flex-col overflow-hidden">

                                        <div className="flex-1 overflow-auto scroller">
                                            <table className="w-full text-left text-sm min-w-[600px]">
                                                <thead className="bg-slate-100 dark:bg-slate-900 sticky top-0 z-10 text-xs font-bold uppercase text-slate-500">
                                                    <tr>
                                                        <th className="px-6 py-3">Class</th>
                                                        <th className="px-6 py-3">SKU</th>
                                                        <th className="px-6 py-3 text-right">Total Value</th>
                                                        <th className="px-6 py-3 text-right">Demand Vol (CV)</th>
                                                        <th className="px-6 py-3 text-right">Avg Demand</th>
                                                        <th className="px-6 py-3">Demand Pattern</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100 dark:divide-slate-800 bg-white dark:bg-slate-950">
                                                    {analysisData
                                                        .filter(item => {
                                                            const matchSearch = item.sku.toString().toLowerCase().includes(searchTerm.toLowerCase());
                                                            const matchFilter = filterClass ? item.class === filterClass : true;
                                                            return matchSearch && matchFilter;
                                                        })
                                                        .slice(0, 100) // Render limit for performance
                                                        .map((item, idx) => (
                                                            <tr key={idx} className="hover:bg-slate-50 dark:hover:bg-slate-900 transition-colors">
                                                                <td className="px-6 py-3">
                                                                    <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold border ${item.abc === 'A' ? 'bg-emerald-50 text-emerald-600 border-emerald-200' :
                                                                        item.abc === 'B' ? 'bg-blue-50 text-blue-600 border-blue-200' :
                                                                            'bg-slate-50 text-slate-500 border-slate-200'
                                                                        }`}>
                                                                        {item.class}
                                                                    </span>
                                                                </td>
                                                                <td className="px-6 py-3 font-mono text-slate-700 dark:text-slate-300 font-bold">{item.sku}</td>
                                                                <td className="px-6 py-3 text-right font-mono">{fmtCurrency(item.totalValue)}</td>
                                                                <td className="px-6 py-3 text-right font-mono text-slate-500">{item.cv.toFixed(2)}</td>
                                                                <td className="px-6 py-3 text-right font-mono text-slate-500">{fmtNum(item.avgDemand, 1)}</td>
                                                                <td className="px-6 py-3 w-32 h-12">
                                                                    {/* Micro Chart */}
                                                                    <ResponsiveContainer width="100%" height="100%">
                                                                        <LineChart data={item.demandHistory.map((d, i) => ({ v: d }))}>
                                                                            <Line type="monotone" dataKey="v" stroke={item.xyz === 'X' ? '#10b981' : item.xyz === 'Y' ? '#f59e0b' : '#ef4444'} strokeWidth={1.5} dot={false} />
                                                                        </LineChart>
                                                                    </ResponsiveContainer>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                </tbody>
                                            </table>
                                            {analysisData.length > 100 && (
                                                <div className="p-4 text-center text-xs text-slate-400 italic">
                                                    Showing first 100 of {analysisData.length} items. Filter to see more.
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </>
                        )}

                        {/* Mapping Modal */}
                        <MappingModal
                            headers={headers}
                            isOpen={isMappingOpen}
                            onClose={() => { setFile(null); setIsMappingOpen(false); }}
                            onConfirm={processAnalysis}
                        />

                        {/* Settings Modal */}
                        <SettingsModal
                            isOpen={isSettingsOpen}
                            onClose={() => setIsSettingsOpen(false)}
                            theme={theme}
                            setTheme={setTheme}
                        />

                    </main>
                </div>
            );
        };

        ReactDOM.render(<MainApp />, document.getElementById('root'));
    </script>
</body>

</html>