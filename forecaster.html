<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Operartis | Machine-Learning Forecaster</title>

    <link rel="icon" type="image/png" href="./icononly_transparent_quadratic.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            gold: '#f59e0b',
                            dark: '#b45309',
                            gray: '#f8fafc',
                            border: '#e2e8f0'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    },
                    fontSize: {
                        xxs: '0.65rem',
                    },
                    screens: {
                        'landscape': { 'raw': '(orientation: landscape)' },
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Roboto+Mono:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
        }

        .scroller {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark body {
            background: #0f172a;
        }

        @media screen and (orientation: landscape) and (max-height: 600px) {
            body.mobile-result-scroll {
                height: auto !important;
                overflow-y: auto !important;
                position: static !important;
            }

            body.mobile-result-scroll .mobile-landscape-root {
                height: auto !important;
                overflow: visible !important;
                min-height: 100vh;
            }

            body.mobile-result-scroll .mobile-landscape-main {
                height: auto !important;
                overflow: visible !important;
            }

            body.mobile-result-scroll .mobile-landscape-content {
                height: auto !important;
                overflow: visible !important;
                min-height: calc(100vh - 8rem);
                min-height: calc(100dvh - 8rem) !important;
            }

            .mobile-compact-p {
                padding: 0px !important;
                border: none !important;
                border-radius: 0 !important;
            }

            .mobile-compact-gap {
                gap: 0px !important;
            }

            .mobile-landscape-content {
                padding: 0px !important;
            }

            /* Optimized Mobile Legend */
            .recharts-legend-wrapper {
                top: 0px !important;
                line-height: 1 !important;
                padding-top: 2px !important;
            }

            .recharts-default-legend {
                margin: 0 !important;
                padding: 0 !important;
            }

            .recharts-legend-item {
                margin-right: 8px !important;
            }

            .recharts-legend-item-text {
                font-size: 9px !important;
            }

            .recharts-legend-item svg {
                width: 9px !important;
                height: 9px !important;
                margin-right: 2px !important;
            }

            .mobile-overlay-scale {
                transform: scale(0.75);
                transform-origin: top right;
            }

            .mobile-overlay-scale-left {
                transform: scale(0.75);
                transform-origin: top left;
            }
        }

        @media screen and (orientation: portrait) and (max-width: 768px) {
            .mobile-compact-p {
                padding: 0px !important;
                border: none !important;
                border-radius: 0 !important;
            }

            .mobile-compact-gap {
                gap: 0px !important;
            }

            .mobile-landscape-content {
                padding: 0px !important;
            }

            /* Optimized Mobile Legend */
            .recharts-legend-wrapper {
                top: 40px !important;
                line-height: 1 !important;
                padding-top: 2px !important;
            }

            .recharts-default-legend {
                margin: 0 !important;
                padding: 0 !important;
            }

            .recharts-legend-item {
                margin-right: 8px !important;
            }

            .recharts-legend-item-text {
                font-size: 9px !important;
            }

            .recharts-legend-item svg {
                width: 9px !important;
                height: 9px !important;
                margin-right: 2px !important;
            }
        }

        /* Responsive Legend Classes */
        .force-legend-drop .recharts-legend-wrapper {
            top: 40px !important;
            transition: top 0.3s ease;
        }

        /* Scalable Legend Text & Icons (Global) */
        .recharts-legend-item-text {
            font-size: clamp(9px, 1.5vw, 12px) !important;
            transition: font-size 0.3s ease;
        }

        .recharts-legend-item svg {
            width: clamp(9px, 1.5vw, 12px) !important;
            height: clamp(9px, 1.5vw, 12px) !important;
            transition: all 0.3s ease;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Modal Backdrop Blur */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script crossorigin
        src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/1.8.5/Recharts.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>

    <div id="root" class="h-full w-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback, memo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Area, ComposedChart, Bar, BarChart, Brush } = window.Recharts;

        // --- TRANSLATIONS ---
        const TRANSLATIONS = {
            en: {
                sidebar: {
                    source_data: "Source Data",
                    upload_label: "Upload Data",
                    uploaded_mapped: "Uploaded & Mapped",
                    action_required: "Action Required",
                    reupload_file: "Re-upload File",
                    edit_mapping: "Edit Mapping",
                    configuration: "Configuration",
                    val_method: "Validation Method",
                    train_h: "Train Horizon",
                    test_h: "Test Horizon",
                    fc_h: "Forecast Horizon",
                    total_periods: "Total time periods",
                    horizon_mismatch: "Train + Test must equal",
                    execute_btn: "Execute Forecast",
                    processing: "Processing...",
                    export_btn: "Export Report",
                    downloading: "Downloading...",
                    reset_btn: "Reset Application",
                    footer_title: "Operartis Analytics",
                    footer_slogan: "Optimizing Today, Growing Tomorrow"
                },
                settings: {
                    title: "Settings",
                    subtitle: "Configure application preferences.",
                    theme_mode: "Theme Mode",
                    language: "Language",
                    about_us: "About Us",
                    interface_appearance: "Interface Appearance",
                    light: "Light Mode",
                    dark: "Dark Mode",
                    system: "System Default",
                    about_title: "About Operartis",
                    about_slogan: "Optimizing today, Growing tomorrow.",
                    about_text_1: "Founded in 2025, Operartis is a specialized consulting and technology firm dedicated to helping enterprises streamline, optimize, and transform their operations. This machine-learning forecaster is a testament to our commitment to making advanced analytics accessible.",
                    about_text_2: "We specialize in Advanced Planning and Scheduling (APS) systems, bridging the gap between raw ERP data and actionable strategic insights."
                },
                mapping: {
                    title: "Map Columns",
                    sku_col: "SKU/Item ID Column",
                    start_col: "First Period Column",
                    end_col: "Last Period Column",
                    preview: "Data Preview",
                    months_detected: "periods detected",
                    cancel: "Cancel",
                    confirm: "Confirm Mapping"
                },
                header: {
                    title: "MACHINE-LEARNING FORECASTER",
                    local: "LOCAL",
                    cloud: "CLOUD"
                },
                dashboard: {
                    batch_overview: "Batch Overview",
                    detailed_view: "Detailed View",
                    total_skus: "Total SKUs",
                    total_vol: "Total Forecast Vol",
                    avg_mae: "Avg. Validation MAE",
                    avg_mse: "Avg. Validation MSE",
                    search_placeholder: "Search SKU...",
                    no_results: "No Results Loaded",
                    running_algo: "Running Analytics Algorithms",
                    table_sku: "SKU",
                    table_status: "Status",
                    table_best_model: "Best Model",
                    table_mae: "MAE (Val)",
                    table_mse: "MSE (Val)",
                    table_action: "Action",
                    table_success: "SUCCESS",
                    view_details: "View Details",
                    best_model: "Best Model",
                    val_mse: "Val. MSE"
                },
                charts: {
                    act_train: "Actual (Train)",
                    act_test: "Actual (Test)",
                    fitted: "Fitted (Train)",
                    val_fc: "Validation Forecast",
                    history: "History",
                    final_fit: "Final Fit",
                    future_fc: "Future Forecast"
                }
            },
            vi: {
                sidebar: {
                    source_data: "Dữ liệu nguồn",
                    upload_label: "Tải lên dữ liệu",
                    uploaded_mapped: "Đã tải lên & Chọn dữ liệu",
                    action_required: "Cần hành động",
                    reupload_file: "Tải lại tệp",
                    edit_mapping: "Chỉnh sửa dữ liệu",
                    configuration: "Cấu hình",
                    val_method: "Phương pháp kiểm định",
                    train_h: "Chu kỳ huấn luyện",
                    test_h: "Chu kỳ thử nghiệm",
                    fc_h: "Chu kỳ dự báo",
                    total_periods: "Tổng số chu kỳ",
                    horizon_mismatch: "Huấn luyện + Thử nghiệm phải bằng",
                    execute_btn: "Chạy dự báo",
                    processing: "Đang xử lý...",
                    export_btn: "Xuất báo cáo",
                    downloading: "Đang tải xuống...",
                    reset_btn: "Đặt lại ứng dụng",
                    footer_title: "Operartis Analytics",
                    footer_slogan: "Optimizing Today, Growing Tomorrow"
                },
                settings: {
                    title: "Cài đặt",
                    subtitle: "Cấu hình tùy chọn ứng dụng.",
                    theme_mode: "Giao diện",
                    language: "Ngôn ngữ",
                    about_us: "Về chúng tôi",
                    interface_appearance: "Giao diện người dùng",
                    light: "Chế độ sáng",
                    dark: "Chế độ tối",
                    system: "Mặc định hệ thống",
                    about_title: "OPERARTIS",
                    about_slogan: "Optimizing today, Growing tomorrow.",
                    about_text_1: "OPERARTIS là một công ty tư vấn và công nghệ chuyên giúp các doanh nghiệp hợp lý hóa, tối ưu hóa quy trình vận hành của họ. Công cụ dự báo máy học này là minh chứng cho cam kết của chúng tôi trong việc làm cho các công cụ phân tích nâng cao trở nên dễ tiếp cận.",
                    about_text_2: "Chúng tôi chuyên về các hệ thống Lập kế hoạch và Lên lịch trình cao cấp (APS), thu hẹp khoảng cách giữa dữ liệu ERP thô và thông tin chiến lược có thể được biến đổi thành hành động hỗ trợ đưa ra quyết định."
                },
                mapping: {
                    title: "Chọn cột dữ liệu",
                    sku_col: "Cột mã hàng (SKU/Item ID)",
                    start_col: "Cột thời gian đầu tiên",
                    end_col: "Cột thời gian cuối cùng",
                    preview: "Xem trước dữ liệu",
                    months_detected: "chu kỳ được phát hiện",
                    cancel: "Hủy bỏ",
                    confirm: "Xác nhận"
                },
                header: {
                    title: "MACHINE-LEARNING FORECASTER",
                    local: "LOCAL",
                    cloud: "CLOUD"
                },
                dashboard: {
                    batch_overview: "Tổng quan",
                    detailed_view: "Chi tiết",
                    total_skus: "Tổng SKU",
                    total_vol: "Tổng lượng dự báo",
                    avg_mae: "MAE trung bình (Val)",
                    avg_mse: "MSE trung bình (Val)",
                    search_placeholder: "Tìm kiếm SKU...",
                    no_results: "Chưa có kết quả",
                    running_algo: "Đang chạy thuật toán phân tích",
                    table_sku: "Mã hàng (SKU)",
                    table_status: "Trạng thái",
                    table_best_model: "Mô hình tốt nhất",
                    table_mae: "MAE (Val)",
                    table_mse: "MSE (Val)",
                    table_action: "Hành động",
                    table_success: "THÀNH CÔNG",
                    view_details: "Xem chi tiết",
                    best_model: "Mô hình tốt nhất",
                    val_mse: "MSE (Val)"
                },
                charts: {
                    act_train: "Thực tế (Train)",
                    act_test: "Thực tế (Test)",
                    fitted: "Khớp (Train)",
                    val_fc: "Dự báo thử nghiệm",
                    history: "Lịch sử",
                    final_fit: "Khớp cuối cùng",
                    future_fc: "Dự báo tương lai"
                }
            }
        };

        // --- ICONS ---
        const MenuIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></svg>;
        const PlayIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const XIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>;
        const MaximizeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3" /><path d="M21 8V5a2 2 0 0 0-2-2h-3" /><path d="M3 16v3a2 2 0 0 0 2 2h3" /><path d="M16 21h3a2 2 0 0 0 2-2v-3" /></svg>;
        const MinimizeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3" /><path d="M21 8h-3a2 2 0 0 1-2-2V3" /><path d="M3 16h3a2 2 0 0 1 2 2v3" /><path d="M16 21v-3a2 2 0 0 1 2-2h3" /></svg>;
        const SunIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></svg>;
        const MoonIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></svg>;
        const SystemIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="3" rx="2" /><line x1="8" x2="16" y1="21" y2="21" /><line x1="12" x2="12" y1="17" y2="21" /></svg>;
        const RefreshIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /><path d="M16 21h5v-5" /></svg>;
        const SplitIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" /><line x1="4" x2="20" y1="12" y2="12" /></svg>;
        const SingleViewIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" /></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg>;
        const UploadIcon = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>;
        const CodeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 18 22 12 16 6" /><polyline points="8 6 2 12 8 18" /></svg>;
        const CopyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></svg>;
        const LockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></svg>;
        const SettingsIcon = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>;
        const PaletteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="13.5" cy="6.5" r=".5" /><circle cx="17.5" cy="10.5" r=".5" /><circle cx="8.5" cy="7.5" r=".5" /><circle cx="6.5" cy="12.5" r=".5" /><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" /></svg>;
        const InfoIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>;
        const CheckIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12" /></svg>;
        const ClockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const ServerIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg>;
        const ChartLineIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18" /><path d="m19 9-5 5-4-4-3 3" /></svg>;
        const LayoutDashboardIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></svg>;
        const SearchIcon = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></svg>;
        const ChevronLeftIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6" /></svg>;
        const ChevronRightIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6" /></svg>;

        const API_ENDPOINTS = { LOCAL: 'http://127.0.0.1:8000', PROD: 'https://95.216.170.251.sslip.io' };

        const MetricTile = memo(({ label, value, subValue, type, isDark, variant = 'default', highlight }) => {
            const colorClass = type === 'pos' ? 'text-emerald-600 dark:text-emerald-400' : type === 'neg' ? 'text-rose-600 dark:text-rose-400' : 'text-slate-700 dark:text-white';
            const bgClass = highlight ? 'bg-amber-50/50 dark:bg-amber-900/20' : variant === 'validation' ? 'bg-amber-50/30 dark:bg-amber-900/10' : 'bg-white/40 dark:bg-white/5';
            return (
                <div className={`flex flex-col justify-center items-center px-3 md:px-6 border-r border-white/20 dark:border-white/10 ${bgClass} backdrop-blur-md h-full min-w-[100px] md:min-w-[140px] snap-start transition-all duration-300 shadow-[inset_0_1px_0_0_rgba(255,255,255,0.2)] dark:shadow-[inset_0_1px_0_0_rgba(255,255,255,0.05)]`}>
                    <span className="text-[9px] uppercase font-bold text-slate-500/80 dark:text-slate-400 tracking-wider mb-0.5 whitespace-nowrap text-center">{label}</span>
                    <div className="flex items-baseline gap-2 justify-center"><span className={`text-base md:text-lg font-bold font-mono ${colorClass} drop-shadow-sm`}>{value}</span>{subValue && <span className="text-[10px] md:text-xs font-medium text-slate-400 dark:text-slate-500">{subValue}</span>}</div>
                </div>
            );
        });

        // Number formatter helper function
        const fmtNumber = (val, minFrac = 0, maxFrac = 0) => {
            if (val === null || val === undefined || val === '-') return '-';
            const num = Number(val);
            if (isNaN(num)) return val;
            return num.toLocaleString('en-US', { minimumFractionDigits: minFrac, maximumFractionDigits: maxFrac });
        };

        const ForecastingLoader = memo(({ t, validationMethod, testHorizon }) => {
            // Calculate adaptive stride info for display
            const testH = parseInt(testHorizon) || 6;
            const isAdaptive = (validationMethod === 'walk_forward' || validationMethod === 'rolling_window') && testH > 12;
            const stride = isAdaptive ? Math.floor(testH / 12) : 1;
            const numFolds = isAdaptive ? Math.min(12 + (testH % 12 > 0 ? 1 : 0), 13) : testH;

            return (
                <div className="h-full flex flex-col items-center justify-center gap-6 animate-fade-in">
                    <div className="relative">
                        <div className="absolute inset-0 bg-brand-gold/20 blur-xl rounded-full animate-pulse"></div>
                        <svg className="animate-spin text-brand-gold relative z-10 w-12 h-12 md:w-16 md:h-16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                    </div>
                    <div className="flex flex-col items-center gap-2">
                        <h3 className="text-xl font-bold text-slate-700 dark:text-slate-200">{t('dashboard.running_algo')}</h3>
                        <div className="flex gap-1 mt-1">
                            <div className="w-1.5 h-1.5 rounded-full bg-brand-gold animate-bounce" style={{ animationDelay: '0ms' }}></div>
                            <div className="w-1.5 h-1.5 rounded-full bg-brand-gold animate-bounce" style={{ animationDelay: '150ms' }}></div>
                            <div className="w-1.5 h-1.5 rounded-full bg-brand-gold animate-bounce" style={{ animationDelay: '300ms' }}></div>
                        </div>
                    </div>
                </div>
            );
        });

        const KPICards = memo(({ results, activeTab, setActiveTab, currentSku, handleSkuSelect, cycleSku, t }) => {
            const hasData = results && results.length > 0;

            // Memoize expensive calculations
            const { totalSeries, avgMse, avgMae, totalForecastVolume } = useMemo(() => {
                if (!hasData) return { totalSeries: '-', avgMse: '-', avgMae: '-', totalForecastVolume: '-' };

                const total = results.length;
                const mseSum = results.reduce((sum, r) => sum + (r.mse_validation || 0), 0);
                const maeSum = results.reduce((sum, r) => sum + (r.mae_validation || 0), 0);
                const fcVolume = results.reduce((sum, r) => {
                    const fcSum = r.forecast_data ? r.forecast_data.reduce((s, d) => s + (d.future_forecast || 0), 0) : 0;
                    return sum + fcSum;
                }, 0);

                return {
                    totalSeries: total,
                    avgMse: mseSum / total,
                    avgMae: maeSum / total,
                    totalForecastVolume: fcVolume
                };
            }, [results, hasData]);

            // SKU Navigator State
            const [localSku, setLocalSku] = useState("");
            const [searchActive, setSearchActive] = useState(false);
            const inputRef = React.useRef(null);

            const onSearchSubmit = useCallback((e) => {
                e.preventDefault();
                handleSkuSelect(localSku);
                setLocalSku("");
                inputRef.current?.blur();
            }, [handleSkuSelect, localSku]);

            return (
                <div className="h-full flex items-center w-full">
                    {/* Tabs Embedded */}
                    <div className="flex gap-2 px-4 border-r border-white/20 dark:border-white/10 h-full items-center shrink-0 bg-white/20 dark:bg-white/5 backdrop-blur-sm">
                        <button onClick={() => setActiveTab("overview")} className={`flex items-center justify-center gap-1.5 text-xs font-bold uppercase px-3 py-1.5 rounded-lg transition-all ${activeTab === 'overview' ? 'bg-brand-gold/90 text-white shadow-lg backdrop-blur-md ring-1 ring-white/20' : 'text-slate-600 dark:text-slate-400 hover:bg-white/40 dark:hover:bg-white/10 hover:backdrop-blur-sm'}`}><LayoutDashboardIcon className="w-3 h-3" /> {t('dashboard.batch_overview')}</button>
                        <button onClick={() => setActiveTab("details")} className={`flex items-center justify-center gap-1.5 text-xs font-bold uppercase px-3 py-1.5 rounded-lg transition-all ${activeTab === 'details' ? 'bg-brand-gold/90 text-white shadow-lg backdrop-blur-md ring-1 ring-white/20' : 'text-slate-600 dark:text-slate-400 hover:bg-white/40 dark:hover:bg-white/10 hover:backdrop-blur-sm'}`}><ChartLineIcon className="w-3 h-3" /> {t('dashboard.detailed_view')}</button>
                    </div>

                    <MetricTile label={t('dashboard.total_skus')} value={totalSeries} />
                    <MetricTile label={t('dashboard.total_vol')} value={fmtNumber(totalForecastVolume, 0, 0)} />
                    <MetricTile label={t('dashboard.avg_mae')} value={fmtNumber(avgMae, 0, 0)} />
                    <MetricTile label={t('dashboard.avg_mse')} value={fmtNumber(avgMse, 0, 0)} />

                    {/* Search Embedded */}
                    <div className="flex items-center gap-2 pl-6 pr-4 flex-1 justify-end">
                        <form
                            onSubmit={onSearchSubmit}
                            onClick={() => inputRef.current?.focus()}
                            className={`flex items-center rounded-lg border transition-all duration-300 cursor-pointer overflow-hidden ${searchActive || localSku ? 'w-48 md:w-64 px-3 py-1.5 bg-white dark:bg-slate-900 border-brand-gold shadow-sm' : 'w-8 h-8 justify-center bg-slate-100 dark:bg-slate-800 border-transparent hover:bg-slate-200 dark:hover:bg-slate-700'}`}
                        >
                            <SearchIcon className={`shrink-0 transition-colors ${searchActive || localSku ? 'text-brand-gold w-4 h-4' : 'text-slate-500 dark:text-slate-400 w-4 h-4'}`} />
                            <input
                                ref={inputRef}
                                className={`bg-transparent border-none outline-none font-mono font-bold text-xs text-slate-700 dark:text-white placeholder-slate-400 transition-all duration-300 ${searchActive || localSku ? 'w-full ml-2 opacity-100' : 'w-0 opacity-0'}`}
                                value={localSku}
                                onChange={(e) => setLocalSku(e.target.value)}
                                onFocus={() => setSearchActive(true)}
                                onBlur={() => setSearchActive(false)}
                                placeholder={t('dashboard.search_placeholder')}
                            />
                        </form>
                    </div>
                </div>
            );
        });



        const BatchOverview = memo(({ results, onSelectSku, t }) => {
            // Memoize row rendering to prevent re-renders
            const tableRows = useMemo(() => results.map((r, i) => (
                <tr key={r.sku || i} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                    <td className="p-3 font-mono font-bold text-slate-700 dark:text-slate-100">{r.sku}</td>
                    <td className="p-3"><span className="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 text-[10px] font-bold">{t('dashboard.table_success')}</span></td>
                    <td className="p-3 text-slate-600 dark:text-slate-300 uppercase">{r.best_ts_model}</td>
                    <td className="p-3 text-right font-mono dark:text-slate-300">{r.mae_validation?.toLocaleString() || '-'}</td>
                    <td className="p-3 text-right font-mono dark:text-slate-300">{r.mse_validation?.toLocaleString() || '-'}</td>
                    <td className="p-3 text-center"><button onClick={() => onSelectSku(r.sku)} className="text-brand-gold hover:underline font-bold">{t('dashboard.view_details')}</button></td>
                </tr>
            )), [results, onSelectSku, t]);

            return (
                <div className="w-full h-full overflow-auto border border-slate-200 dark:border-slate-800 rounded-lg bg-white dark:bg-slate-900 shadow-sm">
                    <table className="w-full text-left text-xs">
                        <thead className="bg-slate-50 dark:bg-slate-950 sticky top-0 z-10">
                            <tr>
                                <th className="p-3 font-bold text-slate-500 dark:text-slate-400 uppercase">{t('dashboard.table_sku')}</th>
                                <th className="p-3 font-bold text-slate-500 dark:text-slate-400 uppercase">{t('dashboard.table_status')}</th>
                                <th className="p-3 font-bold text-slate-500 dark:text-slate-400 uppercase">{t('dashboard.table_best_model')}</th>
                                <th className="p-3 font-bold text-slate-500 dark:text-slate-400 uppercase text-right">{t('dashboard.table_mae')}</th>
                                <th className="p-3 font-bold text-slate-500 dark:text-slate-400 uppercase text-right">{t('dashboard.table_mse')}</th>
                                <th className="p-3 font-bold text-slate-500 dark:text-slate-400 uppercase text-center">{t('dashboard.table_action')}</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
                            {tableRows}
                        </tbody>
                    </table>
                </div>
            );
        });

        // --- ZOOMABLE CHART WRAPPER ---
        // Supports: Mouse wheel zoom, pinch-to-zoom, drag to pan, double-click to reset
        const useChartZoom = (dataLength) => {
            const [zoomDomain, setZoomDomain] = useState({ start: 0, end: dataLength - 1 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState(null);
            const containerRef = useRef(null);

            // Reset zoom when data changes
            useEffect(() => {
                setZoomDomain({ start: 0, end: dataLength - 1 });
            }, [dataLength]);

            const handleWheel = (e) => {
                e.preventDefault();
                const { start, end } = zoomDomain;
                const range = end - start;
                const minRange = Math.max(5, Math.floor(dataLength * 0.05)); // Min 5% of data or 5 points

                // Get cursor position ratio within chart
                const rect = containerRef.current?.getBoundingClientRect();
                const cursorRatio = rect ? (e.clientX - rect.left) / rect.width : 0.5;

                // Determine zoom direction (pinch gesture sends ctrlKey with deltaY)
                const delta = e.deltaY || e.deltaX;
                const zoomIn = delta < 0;
                const zoomFactor = 0.1; // 10% zoom per scroll

                if (zoomIn && range > minRange) {
                    // Zoom in - reduce range centered on cursor
                    const reduction = Math.max(1, Math.floor(range * zoomFactor));
                    const leftReduction = Math.floor(reduction * cursorRatio);
                    const rightReduction = reduction - leftReduction;
                    setZoomDomain({
                        start: Math.min(start + leftReduction, end - minRange),
                        end: Math.max(end - rightReduction, start + minRange)
                    });
                } else if (!zoomIn && range < dataLength - 1) {
                    // Zoom out - increase range
                    const expansion = Math.max(1, Math.floor(range * zoomFactor));
                    const leftExpansion = Math.floor(expansion * cursorRatio);
                    const rightExpansion = expansion - leftExpansion;
                    setZoomDomain({
                        start: Math.max(0, start - leftExpansion),
                        end: Math.min(dataLength - 1, end + rightExpansion)
                    });
                }
            };

            const handleMouseDown = (e) => {
                if (e.button === 0) { // Left click only
                    setIsDragging(true);
                    setDragStart({ x: e.clientX, domain: { ...zoomDomain } });
                }
            };

            const handleMouseMove = (e) => {
                if (!isDragging || !dragStart) return;

                const rect = containerRef.current?.getBoundingClientRect();
                if (!rect) return;

                const deltaX = e.clientX - dragStart.x;
                const range = dragStart.domain.end - dragStart.domain.start;
                const pixelsPerPoint = rect.width / range;
                const pointsDelta = Math.round(-deltaX / pixelsPerPoint);

                const newStart = Math.max(0, Math.min(dataLength - 1 - range, dragStart.domain.start + pointsDelta));
                const newEnd = newStart + range;

                setZoomDomain({ start: newStart, end: Math.min(dataLength - 1, newEnd) });
            };

            const handleMouseUp = () => {
                setIsDragging(false);
                setDragStart(null);
            };

            const handleDoubleClick = () => {
                // Reset to full view
                setZoomDomain({ start: 0, end: dataLength - 1 });
            };

            // Explicit Zoom Helpers
            const zoomIn = () => {
                const { start, end } = zoomDomain;
                const range = end - start;
                const minRange = Math.max(5, Math.floor(dataLength * 0.05));
                if (range <= minRange) return;

                const reduction = Math.max(1, Math.floor(range * 0.25)); // 25% zoom
                setZoomDomain({
                    start: Math.min(start + Math.floor(reduction / 2), end - minRange),
                    end: Math.max(end - Math.floor(reduction / 2), start + minRange)
                });
            };

            const zoomOut = () => {
                const { start, end } = zoomDomain;
                const range = end - start;
                if (start <= 0 && end >= dataLength - 1) return;

                const expansion = Math.max(1, Math.floor(range * 0.25)); // 25% zoom out
                setZoomDomain({
                    start: Math.max(0, start - Math.floor(expansion / 2)),
                    end: Math.min(dataLength - 1, end + Math.floor(expansion / 2))
                });
            };

            // Touch support for mobile pinch-to-zoom (Native Listeners for passive: false)
            const lastTouchDistance = useRef(null);
            const lastTouchCenter = useRef(null);

            useEffect(() => {
                const el = containerRef.current;
                if (!el) return;

                // Gesture State: 'idle' | 'detecting' | 'panning' | 'zooming' | 'scrolling'
                const gestureState = { current: 'idle' };
                const touchStartPos = { current: null };

                const onTouchStart = (e) => {
                    if (e.touches.length === 2) {
                        gestureState.current = 'zooming';
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        lastTouchDistance.current = Math.sqrt(dx * dx + dy * dy);
                        lastTouchCenter.current = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                    } else if (e.touches.length === 1) {
                        const rect = el.getBoundingClientRect();
                        const touchY = e.touches[0].clientY - rect.top;
                        const isBottomArea = touchY > rect.height * 0.85; // Bottom 15% area

                        if (isBottomArea) {
                            gestureState.current = 'detecting';
                            touchStartPos.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                            // Don't set isDragging(true) yet. Wait for move confirmation.
                        } else {
                            gestureState.current = 'idle';
                        }
                    }
                };

                const onTouchMove = (e) => {
                    // 1. PINCH ZOOM LOGIC
                    if (e.touches.length === 2 && gestureState.current === 'zooming' && lastTouchDistance.current) {
                        e.preventDefault(); // Lock browser zoom
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        // Add threshold to avoid micro-jitters
                        if (Math.abs(distance - lastTouchDistance.current) < 2) return;

                        const scale = distance / lastTouchDistance.current;

                        const { start, end } = zoomDomain;
                        const range = end - start;
                        const minRange = Math.max(5, Math.floor(dataLength * 0.05));

                        const rect = el.getBoundingClientRect();
                        const center = lastTouchCenter.current;
                        const cursorRatio = rect ? (center - rect.left) / rect.width : 0.5;

                        // Damped zoom for stability
                        if (scale > 1 && range > minRange) {
                            const reduction = Math.max(1, Math.floor(range * (scale - 1) * 0.4)); // 0.4 damping
                            setZoomDomain({
                                start: Math.min(start + Math.floor(reduction * cursorRatio), end - minRange),
                                end: Math.max(end - Math.floor(reduction * (1 - cursorRatio)), start + minRange)
                            });
                        } else if (scale < 1 && range < dataLength - 1) {
                            const expansion = Math.max(1, Math.floor(range * (1 - scale) * 0.4)); // 0.4 damping
                            setZoomDomain({
                                start: Math.max(0, start - Math.floor(expansion * cursorRatio)),
                                end: Math.min(dataLength - 1, end + Math.floor(expansion * (1 - cursorRatio)))
                            });
                        }
                        lastTouchDistance.current = distance;
                    }
                    // 2. PANNING LOGIC
                    else if (e.touches.length === 1) {
                        if (gestureState.current === 'detecting') {
                            const dx = e.touches[0].clientX - touchStartPos.current.x;
                            const dy = e.touches[0].clientY - touchStartPos.current.y;
                            const dist = Math.hypot(dx, dy);

                            if (dist > 8) { // 8px threshold to lock gesture
                                if (Math.abs(dx) > Math.abs(dy)) {
                                    gestureState.current = 'panning';
                                    setIsDragging(true);
                                    setDragStart({ x: e.touches[0].clientX, domain: { ...zoomDomain } });
                                } else {
                                    gestureState.current = 'scrolling';
                                }
                            }
                        }

                        if (gestureState.current === 'panning' && dragStart) {
                            e.preventDefault(); // Lock page scroll
                            const rect = el.getBoundingClientRect();
                            const deltaX = e.touches[0].clientX - dragStart.x;
                            const range = dragStart.domain.end - dragStart.domain.start;
                            // Smooth factor: if moving fast, reduce sensitivity slightly? No, stick to raw for now.
                            // Ensure non-zero
                            const pxPerPt = Math.max(0.01, rect.width / range);
                            const pointsDelta = Math.round(-deltaX / pxPerPt);

                            if (pointsDelta !== 0) {
                                const newStart = Math.max(0, Math.min(dataLength - 1 - range, dragStart.domain.start + pointsDelta));
                                const newEnd = newStart + range;
                                setZoomDomain({ start: newStart, end: Math.min(dataLength - 1, newEnd) });
                            }
                        }
                    }
                };

                const onTouchEnd = () => {
                    gestureState.current = 'idle';
                    lastTouchDistance.current = null;
                    lastTouchCenter.current = null;
                    setIsDragging(false);
                    setDragStart(null);
                };

                el.addEventListener('touchstart', onTouchStart, { passive: true });
                el.addEventListener('touchmove', onTouchMove, { passive: false });
                el.addEventListener('touchend', onTouchEnd);
                el.addEventListener('touchcancel', onTouchEnd);

                return () => {
                    el.removeEventListener('touchstart', onTouchStart);
                    el.removeEventListener('touchmove', onTouchMove);
                    el.removeEventListener('touchend', onTouchEnd);
                    el.removeEventListener('touchcancel', onTouchEnd);
                };
            }, [zoomDomain, dataLength]); // Re-bind when state changes to capture correct values

            return {
                zoomDomain,
                containerRef,
                handlers: {
                    onWheel: handleWheel,
                    onMouseDown: handleMouseDown,
                    onMouseMove: handleMouseMove,
                    onMouseUp: handleMouseUp,
                    onMouseLeave: handleMouseUp,
                    onDoubleClick: handleDoubleClick
                    // Touch handlers removed from here, handled natively
                },
                isDragging,
                zoomIn,
                zoomOut
            };
        };

        const BacktestChart = ({ data, syncId, isDark, t }) => {
            if (!data) return null;

            const { zoomDomain, containerRef, handlers, isDragging, zoomIn, zoomOut } = useChartZoom(data.length);
            const visibleData = data.slice(zoomDomain.start, zoomDomain.end + 1);
            const isZoomed = zoomDomain.start > 0 || zoomDomain.end < data.length - 1;

            return (
                <div
                    ref={containerRef}
                    className={`w-full h-full relative ${isDragging ? 'cursor-grabbing' : 'cursor-grab'}`}
                    {...handlers}
                    style={{ touchAction: 'none' }}
                >
                    <div className="absolute top-14 right-2 z-10 flex items-center gap-1">
                        {/* Zoom Controls */}
                        <div className="flex flex-col gap-1 bg-white/80 dark:bg-slate-900/80 p-0.5 rounded-lg backdrop-blur-sm border border-white/20 dark:border-white/10 shadow-sm mr-1">
                            <button onClick={(e) => { e.stopPropagation(); zoomIn(); }} className="w-5 h-5 flex items-center justify-center rounded bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors font-bold text-xs" aria-label="Zoom In">+</button>
                            <button onClick={(e) => { e.stopPropagation(); zoomOut(); }} className="w-5 h-5 flex items-center justify-center rounded bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors font-bold text-xs" aria-label="Zoom Out">-</button>
                        </div>

                        {isZoomed && (
                            <div className="flex items-center gap-2 bg-white/80 dark:bg-slate-900/80 px-2 py-1 rounded-lg backdrop-blur-sm border border-white/20 dark:border-white/10 shadow-sm">
                                <span className="text-[10px] text-slate-500 dark:text-slate-400">
                                    {zoomDomain.end - zoomDomain.start + 1} / {data.length} pts
                                </span>
                                <button
                                    onClick={(e) => { e.stopPropagation(); handlers.onDoubleClick(); }}
                                    className="text-[10px] text-amber-600 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/30 px-1.5 py-0.5 rounded transition-colors"
                                >
                                    Reset
                                </button>
                            </div>
                        )}
                    </div>
                    <ResponsiveContainer width="100%" height="100%">
                        <ComposedChart data={visibleData} syncId={syncId} margin={{ top: 10, right: 10, left: 0, bottom: 10 }}>
                            <defs>
                                <linearGradient id="gd_bt_actual_train" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#64748b" stopOpacity={0.3} />
                                    <stop offset="95%" stopColor="#64748b" stopOpacity={0} />
                                </linearGradient>
                                <linearGradient id="gd_bt_actual_test" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#10b981" stopOpacity={0.3} />
                                    <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
                                </linearGradient>
                                <linearGradient id="gd_bt_fitted" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#94a3b8" stopOpacity={0.3} />
                                    <stop offset="95%" stopColor="#94a3b8" stopOpacity={0} />
                                </linearGradient>
                                <linearGradient id="gd_bt_val_forecast" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#f59e0b" stopOpacity={0.3} />
                                    <stop offset="95%" stopColor="#f59e0b" stopOpacity={0} />
                                </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={isDark ? "#334155" : "#e2e8f0"} />
                            <XAxis dataKey="date" axisLine={false} tickLine={false} tick={{ fill: isDark ? "#cbd5e1" : "#64748b", fontSize: 10 }} dy={10} minTickGap={30} />
                            <YAxis axisLine={false} tickLine={false} tick={{ fill: isDark ? "#cbd5e1" : "#64748b", fontSize: 10 }} />
                            <Tooltip contentStyle={{ backgroundColor: isDark ? "#0f172a" : "#fff", borderColor: isDark ? "#334155" : "#e2e8f0", fontSize: '12px', color: isDark ? '#fff' : '#000' }} />
                            <Legend verticalAlign="top" height={36} wrapperStyle={{ color: isDark ? '#cbd5e1' : '#64748b' }} />
                            <Area type="monotone" dataKey="actual_train" name={t('charts.act_train')} stroke="#64748b" fill="url(#gd_bt_actual_train)" strokeWidth={2} isAnimationActive={false} />
                            <Area type="monotone" dataKey="actual_test" name={t('charts.act_test')} stroke="#10b981" fill="url(#gd_bt_actual_test)" strokeWidth={2} isAnimationActive={false} />
                            <Area type="monotone" dataKey="fitted" name={t('charts.fitted')} stroke="#94a3b8" fill="url(#gd_bt_fitted)" strokeDasharray="3 3" strokeWidth={2} isAnimationActive={false} />
                            <Area type="monotone" dataKey="val_forecast" name={t('charts.val_fc')} stroke="#f59e0b" fill="url(#gd_bt_val_forecast)" strokeWidth={2} strokeDasharray="5 5" dot={false} isAnimationActive={false} />
                        </ComposedChart>
                    </ResponsiveContainer>
                </div>
            );
        };

        // Isolated Clock Component - prevents parent re-renders, updates every 30 seconds
        const LiveClock = memo(() => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const t = setInterval(() => setTime(new Date()), 30000); // Update every 30 seconds instead of 1 second
                return () => clearInterval(t);
            }, []);
            return <span>{time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>;
        });

        const ForecastChart = ({ data, syncId, isDark, t }) => {
            if (!data) return null;

            const { zoomDomain, containerRef, handlers, isDragging, zoomIn, zoomOut } = useChartZoom(data.length);
            const visibleData = data.slice(zoomDomain.start, zoomDomain.end + 1);
            const isZoomed = zoomDomain.start > 0 || zoomDomain.end < data.length - 1;

            return (
                <div
                    ref={containerRef}
                    className={`w-full h-full relative ${isDragging ? 'cursor-grabbing' : 'cursor-grab'}`}
                    {...handlers}
                    style={{ touchAction: 'none' }}
                >
                    <div className="absolute top-14 right-2 z-10 flex items-center gap-1">
                        {/* Zoom Controls */}
                        <div className="flex flex-col gap-1 bg-white/80 dark:bg-slate-900/80 p-0.5 rounded-lg backdrop-blur-sm border border-white/20 dark:border-white/10 shadow-sm mr-1">
                            <button onClick={(e) => { e.stopPropagation(); zoomIn(); }} className="w-5 h-5 flex items-center justify-center rounded bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors font-bold text-xs" aria-label="Zoom In">+</button>
                            <button onClick={(e) => { e.stopPropagation(); zoomOut(); }} className="w-5 h-5 flex items-center justify-center rounded bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors font-bold text-xs" aria-label="Zoom Out">-</button>
                        </div>

                        {isZoomed && (
                            <div className="flex items-center gap-2 bg-white/80 dark:bg-slate-900/80 px-2 py-1 rounded-lg backdrop-blur-sm border border-white/20 dark:border-white/10 shadow-sm">
                                <span className="text-[10px] text-slate-500 dark:text-slate-400">
                                    {zoomDomain.end - zoomDomain.start + 1} / {data.length} pts
                                </span>
                                <button
                                    onClick={(e) => { e.stopPropagation(); handlers.onDoubleClick(); }}
                                    className="text-[10px] text-amber-600 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/30 px-1.5 py-0.5 rounded transition-colors"
                                >
                                    Reset
                                </button>
                            </div>
                        )}
                    </div>

                    <ResponsiveContainer width="100%" height="100%">
                        <ComposedChart data={visibleData} syncId={syncId} margin={{ top: 10, right: 10, left: 0, bottom: 10 }}>
                            <defs>
                                <linearGradient id="gd_fc_history" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#64748b" stopOpacity={0.3} />
                                    <stop offset="95%" stopColor="#64748b" stopOpacity={0} />
                                </linearGradient>
                                <linearGradient id="gd_fc_final_fit" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#94a3b8" stopOpacity={0.3} />
                                    <stop offset="95%" stopColor="#94a3b8" stopOpacity={0} />
                                </linearGradient>
                                <linearGradient id="gd_fc_future" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#f59e0b" stopOpacity={0.3} />
                                    <stop offset="95%" stopColor="#f59e0b" stopOpacity={0} />
                                </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={isDark ? "#334155" : "#e2e8f0"} />
                            <XAxis dataKey="date" axisLine={false} tickLine={false} tick={{ fill: isDark ? "#cbd5e1" : "#64748b", fontSize: 10 }} dy={10} minTickGap={30} />
                            <YAxis axisLine={false} tickLine={false} tick={{ fill: isDark ? "#cbd5e1" : "#64748b", fontSize: 10 }} />
                            <Tooltip contentStyle={{ backgroundColor: isDark ? "#0f172a" : "#fff", borderColor: isDark ? "#334155" : "#e2e8f0", fontSize: '12px', color: isDark ? '#fff' : '#000' }} />
                            <Legend verticalAlign="top" height={36} wrapperStyle={{ color: isDark ? '#cbd5e1' : '#64748b' }} />
                            <Area type="monotone" dataKey="actual_history" name={t('charts.history')} stroke="#64748b" fill="url(#gd_fc_history)" strokeWidth={2} isAnimationActive={false} />
                            <Area type="monotone" dataKey="final_fit" name={t('charts.final_fit')} stroke="#94a3b8" fill="url(#gd_fc_final_fit)" strokeDasharray="3 3" strokeWidth={2} isAnimationActive={false} />
                            <Area type="monotone" dataKey="future_forecast" name={t('charts.future_fc')} stroke="#f59e0b" fill="url(#gd_fc_future)" strokeWidth={2} strokeDasharray="5 5" dot={false} isAnimationActive={false} />
                        </ComposedChart>
                    </ResponsiveContainer>
                </div>
            );
        };

        const MappingModal = ({ headers, isOpen, onClose, onConfirm, t }) => {
            const [sku, setSku] = useState('');
            const [startCol, setStartCol] = useState('');
            const [endCol, setEndCol] = useState('');

            // Calculate number of months between start and end columns
            const monthCount = useMemo(() => {
                if (!startCol || !endCol || !headers.length) return 0;
                const startIdx = headers.indexOf(startCol);
                const endIdx = headers.indexOf(endCol);
                if (startIdx < 0 || endIdx < 0 || endIdx < startIdx) return 0;
                return endIdx - startIdx + 1;
            }, [startCol, endCol, headers]);

            useEffect(() => {
                if (isOpen && headers.length) {
                    console.log('MappingModal headers:', headers.slice(0, 5), '...');

                    // Auto-detect date/month columns FIRST
                    // Check for text month patterns OR datetime format patterns
                    const monthPatterns = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    const datePatterns = [/^\d{4}-\d{2}-\d{2}/, /^\d{4}\/\d{2}\/\d{2}/, /^\d{2}[-\/]\d{2}[-\/]\d{4}/];

                    const dateIndices = headers.map((h, i) => {
                        const headerStr = String(h);
                        const headerLower = headerStr.toLowerCase();
                        // Check text month patterns (case insensitive)
                        if (monthPatterns.some(p => headerLower.includes(p))) return i;
                        // Check datetime patterns (YYYY-MM-DD, etc.) on original string
                        if (datePatterns.some(p => p.test(headerStr))) return i;
                        // Check if it looks like a date string (contains year numbers)
                        if (/20\d{2}/.test(headerStr) || /19\d{2}/.test(headerStr)) return i;
                        return -1;
                    }).filter(i => i >= 0);

                    console.log('Detected date column indices:', dateIndices);

                    // Auto-detect SKU column (first non-date column that matches patterns)
                    const findSku = () => {
                        const patterns = ['sku', 'id', 'item', 'product', 'unique_id', 'item_id'];
                        for (let i = 0; i < headers.length; i++) {
                            // Skip if this is a detected date column
                            if (dateIndices.includes(i)) continue;
                            const headerLower = String(headers[i]).toLowerCase();
                            if (patterns.some(p => headerLower.includes(p))) {
                                return headers[i];
                            }
                        }
                        // Fallback: first non-date column
                        for (let i = 0; i < headers.length; i++) {
                            if (!dateIndices.includes(i)) return headers[i];
                        }
                        return headers[0];
                    };

                    // Always auto-suggest when modal opens (user can still change if needed)
                    setSku(findSku());
                    if (dateIndices.length > 0) {
                        setStartCol(headers[dateIndices[0]]);
                        setEndCol(headers[dateIndices[dateIndices.length - 1]]);
                    }
                }
            }, [isOpen, headers]);

            const handleConfirm = () => {
                onConfirm(sku, startCol, endCol);
            };

            if (!isOpen) return null;

            // Filter headers for month selection (exclude SKU column and other non-numeric columns)
            const potentialMonthCols = headers;

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/20 backdrop-blur-sm modal-backdrop transition-opacity" onClick={onClose}></div>
                    <div className="bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl rounded-xl shadow-2xl w-full max-w-md border border-white/20 dark:border-white/10 flex flex-col relative animate-slide-up z-10 ring-1 ring-black/5 dark:ring-white/5">
                        <div className="p-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                            <h2 className="text-sm font-bold text-slate-800 dark:text-slate-100 uppercase tracking-wide">{t('mapping.title')}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><XIcon /></button>
                        </div>
                        <div className="p-4 space-y-4">
                            {/* SKU Column */}
                            <div>
                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t('mapping.sku_col')}</label>
                                <select className="w-full text-xs p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold transition-colors" value={sku} onChange={e => setSku(e.target.value)}>
                                    {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                </select>
                            </div>

                            {/* Month Range Selection */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t('mapping.start_col')}</label>
                                    <select className="w-full text-xs p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold transition-colors" value={startCol} onChange={e => setStartCol(e.target.value)}>
                                        {potentialMonthCols.map(h => <option key={h} value={h}>{h}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t('mapping.end_col')}</label>
                                    <select className="w-full text-xs p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold transition-colors" value={endCol} onChange={e => setEndCol(e.target.value)}>
                                        {potentialMonthCols.map(h => <option key={h} value={h}>{h}</option>)}
                                    </select>
                                </div>
                            </div>

                            {/* Preview Info */}
                            {monthCount > 0 && (
                                <div className="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg p-3">
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full bg-emerald-500"></div>
                                        <span className="text-xs font-bold text-emerald-700 dark:text-emerald-400">
                                            {monthCount} {t('mapping.months_detected')}
                                        </span>
                                    </div>
                                    <div className="mt-2 text-[10px] text-emerald-600 dark:text-emerald-500 font-mono">
                                        {startCol} → {endCol}
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t border-slate-200 dark:border-slate-800 flex justify-end gap-2">
                            <button onClick={onClose} className="px-3 py-1.5 text-xs font-bold text-slate-500 hover:text-slate-700">{t('mapping.cancel')}</button>
                            <button onClick={handleConfirm} disabled={!sku || !startCol || !endCol || monthCount < 1} className="px-3 py-1.5 bg-brand-gold text-white text-xs font-bold rounded hover:bg-brand-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed">{t('mapping.confirm')}</button>
                        </div>
                    </div>
                </div>
            );
        };


        const SettingsModal = ({ isOpen, onClose, theme, setTheme, lang, setLang, t }) => {
            const [copied, setCopied] = useState(null);
            const [activeTab, setActiveTab] = useState("theme");

            useEffect(() => {
                if (isOpen) {
                    setActiveTab("theme");
                    setCopied(null);
                }
            }, [isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/20 backdrop-blur-sm modal-backdrop transition-opacity" onClick={onClose}></div>
                    <div className="bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl w-full max-w-5xl h-[85vh] md:h-[80vh] rounded-xl shadow-2xl relative flex flex-col overflow-hidden animate-slide-up border border-white/20 dark:border-white/10 ring-1 ring-black/5 dark:ring-white/5">
                        {/* Header */}
                        <div className="px-6 py-4 border-b border-white/20 dark:border-white/10 flex items-center justify-between bg-white/50 dark:bg-white/5 shrink-0">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-brand-gold/10 rounded-lg text-brand-gold">
                                    <SettingsIcon />
                                </div>
                                <div>
                                    <h2 className="text-lg font-bold text-slate-800 dark:text-slate-100">{t('settings.title')}</h2>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">{t('settings.subtitle')}</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-400 transition-colors">
                                <XIcon />
                            </button>
                        </div>

                        {/* Body Layout */}
                        <div className="flex flex-col md:flex-row flex-1 overflow-hidden">
                            {/* Sidebar Nav */}
                            <div className="w-full md:w-64 border-b md:border-b-0 md:border-r border-white/20 dark:border-white/10 bg-slate-50/50 dark:bg-black/20 p-2 md:p-4 flex flex-row md:flex-col gap-2 overflow-x-auto md:overflow-y-auto shrink-0 scroller">
                                <button
                                    onClick={() => setActiveTab("theme")}
                                    className={`text-left px-4 py-3 rounded-lg text-xs font-bold uppercase tracking-wide flex items-center gap-3 transition-colors ${activeTab === 'theme' ? 'bg-brand-gold text-white shadow-md' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}`}
                                >
                                    <PaletteIcon /> {t('settings.theme_mode')}
                                </button>
                                <button
                                    onClick={() => setActiveTab("lang")}
                                    className={`text-left px-4 py-3 rounded-lg text-xs font-bold uppercase tracking-wide flex items-center gap-3 transition-colors ${activeTab === 'lang' ? 'bg-brand-gold text-white shadow-md' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><line x1="2" x2="22" y1="12" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></svg> {t('settings.language')}
                                </button>
                                <button
                                    onClick={() => setActiveTab("about")}
                                    className={`text-left px-4 py-3 rounded-lg text-xs font-bold uppercase tracking-wide flex items-center gap-3 transition-colors ${activeTab === 'about' ? 'bg-brand-gold text-white shadow-md' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}`}
                                >
                                    <InfoIcon /> {t('settings.about_us')}
                                </button>
                            </div>

                            {/* Content Area */}
                            <div className="flex-1 overflow-y-auto scroller p-6 md:p-8 relative bg-transparent">
                                {activeTab === 'theme' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <div>
                                            <h3 className="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-4">{t('settings.interface_appearance')}</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <button onClick={() => setTheme('light')} className={`p-4 rounded-lg border-2 flex flex-col items-center gap-3 transition-all ${theme === 'light' ? 'border-brand-gold bg-brand-gold/5 text-brand-dark' : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700 text-slate-500'}`}>
                                                    <div className="p-3 bg-white rounded-full shadow-sm"><SunIcon /></div>
                                                    <span className="text-sm font-bold">{t('settings.light')}</span>
                                                </button>
                                                <button onClick={() => setTheme('dark')} className={`p-4 rounded-lg border-2 flex flex-col items-center gap-3 transition-all ${theme === 'dark' ? 'border-brand-gold bg-brand-gold/5 text-brand-dark dark:text-brand-gold' : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700 text-slate-500'}`}>
                                                    <div className="p-3 bg-slate-800 text-white rounded-full shadow-sm"><MoonIcon /></div>
                                                    <span className="text-sm font-bold">{t('settings.dark')}</span>
                                                </button>
                                                <button onClick={() => setTheme('system')} className={`p-4 rounded-lg border-2 flex flex-col items-center gap-3 transition-all ${theme === 'system' ? 'border-brand-gold bg-brand-gold/5 text-brand-dark dark:text-brand-gold' : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700 text-slate-500'}`}>
                                                    <div className="p-3 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-full shadow-sm"><SystemIcon /></div>
                                                    <span className="text-sm font-bold">{t('settings.system')}</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'lang' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <h3 className="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-4">{t('settings.language')}</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <button onClick={() => setLang('en')} className={`p-4 rounded-lg border-2 flex items-center justify-between transition-all ${lang === 'en' ? 'border-brand-gold bg-brand-gold/5' : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700'}`}>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-2xl">🇺🇸</span>
                                                    <div className="text-left">
                                                        <div className={`font-bold ${lang === 'en' ? 'text-brand-dark dark:text-brand-gold' : 'text-slate-700 dark:text-slate-200'}`}>English</div>
                                                        <div className="text-xs text-slate-500">US English</div>
                                                    </div>
                                                </div>
                                                {lang === 'en' && <div className="w-3 h-3 rounded-full bg-brand-gold"></div>}
                                            </button>
                                            <button onClick={() => setLang('vi')} className={`p-4 rounded-lg border-2 flex items-center justify-between transition-all ${lang === 'vi' ? 'border-brand-gold bg-brand-gold/5' : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700'}`}>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-2xl">🇻🇳</span>
                                                    <div className="text-left">
                                                        <div className={`font-bold ${lang === 'vi' ? 'text-brand-dark dark:text-brand-gold' : 'text-slate-700 dark:text-slate-200'}`}>Tiếng Việt</div>
                                                        <div className="text-xs text-slate-500">Vietnamese</div>
                                                    </div>
                                                </div>
                                                {lang === 'vi' && <div className="w-3 h-3 rounded-full bg-brand-gold"></div>}
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'about' && (
                                    <div className="animate-fade-in space-y-8 max-w-3xl mx-auto">
                                        <div className="text-center space-y-2 mb-8">
                                            <div className="inline-block p-4 bg-brand-gold/10 rounded-full mb-2">
                                                <img src="./icononly_transparent_quadratic.png" className="w-12 h-12 object-contain mx-auto" onError={(e) => e.target.style.display = 'none'} />
                                            </div>
                                            <h2 className="text-2xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">{t('settings.about_title')}</h2>
                                            <p className="text-sm text-brand-gold font-medium uppercase tracking-widest">{t('settings.about_slogan')}</p>
                                        </div>

                                        <div className="prose prose-sm dark:prose-invert max-w-none text-slate-600 dark:text-slate-300 leading-relaxed space-y-6">
                                            <p>
                                                {t('settings.about_text_1')}
                                            </p>
                                            <p>
                                                {t('settings.about_text_2')}
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [file, setFile] = useState(null);
            const [availableCols, setAvailableCols] = useState([]);
            const [skuCol, setSkuCol] = useState("");
            const [startCol, setStartCol] = useState("");
            const [endCol, setEndCol] = useState("");
            // Store indices directly to avoid string matching issues
            const [skuColIdx, setSkuColIdx] = useState(-1);
            const [startColIdx, setStartColIdx] = useState(-1);
            const [endColIdx, setEndColIdx] = useState(-1);

            // Responsive Legend Logic
            const [isLegendOverlap, setIsLegendOverlap] = useState(false);
            const skuOverlayRef = useRef(null);
            const metricsOverlayRef = useRef(null);
            const chartRowRef = useRef(null);

            useEffect(() => {
                const checkOverlap = () => {
                    if (!skuOverlayRef.current || !metricsOverlayRef.current || !chartRowRef.current) return;
                    const skuRect = skuOverlayRef.current.getBoundingClientRect();
                    const metricsRect = metricsOverlayRef.current.getBoundingClientRect();
                    const containerRect = chartRowRef.current.getBoundingClientRect();

                    // Calculate free space between overlays
                    const gap = metricsRect.left - skuRect.right;

                    // Threshold: If gap is less than ~220px (min width for legend to look ok), or if we are on very small screen
                    // We also check if text length forces overlap
                    const shouldDrop = gap < 250;
                    setIsLegendOverlap(shouldDrop);
                };

                // Check on mount and sku change
                checkOverlap();

                // Use ResizeObserver for robust detection
                const ro = new ResizeObserver(checkOverlap);
                if (chartRowRef.current) ro.observe(chartRowRef.current);
                if (skuOverlayRef.current) ro.observe(skuOverlayRef.current); // Text might change length

                window.addEventListener('resize', checkOverlap);
                return () => {
                    window.removeEventListener('resize', checkOverlap);
                    ro.disconnect();
                };
            }, [currentSku, activeTab, layoutKey]);

            const [trainHorizon, setTrainHorizon] = useState("24");
            const [testHorizon, setTestHorizon] = useState("6");
            const [validationMethod, setValidationMethod] = useState("simple");
            const [forecastSteps, setForecastSteps] = useState("6");
            const [totalTimeSeries, setTotalTimeSeries] = useState(0);

            // Computed: Check if train + test equals total
            const horizonMismatch = totalTimeSeries > 0 && (parseInt(trainHorizon) || 0) + (parseInt(testHorizon) || 0) !== totalTimeSeries;

            // Job State
            const [jobId, setJobId] = useState(null);
            const [isPolling, setIsPolling] = useState(false);
            const [batchResults, setBatchResults] = useState(null);
            const [jobStatus, setJobStatus] = useState(null);
            const [error, setError] = useState(null);
            const [isExporting, setIsExporting] = useState(false);

            // UI State
            const [currentSku, setCurrentSku] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isFullScreen, setIsFullScreen] = useState(false);
            const [isSplitView, setIsSplitView] = useState(true); // For All-In-One
            const [activeTab, setActiveTab] = useState("overview"); // overview, details
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isMappingModalOpen, setIsMappingModalOpen] = useState(false);
            const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'system');
            const [isDark, setIsDark] = useState(false);

            // API State
            const [apiUrl, setApiUrl] = useState(API_ENDPOINTS.PROD);
            const [connectionStatus, setConnectionStatus] = useState('checking');
            const BASE_URL = apiUrl;

            // Force re-render on resize/rotate to fix chart scaling
            const [layoutKey, setLayoutKey] = useState(0);
            useEffect(() => {
                let timeoutId;
                const handleResize = () => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => setLayoutKey(prev => prev + 1), 200);
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const fileInputRef = useRef(null);

            // --- EFFECTS ---
            useEffect(() => {
                const checkConnection = async () => {
                    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
                    if (!isLocal) { setApiUrl(API_ENDPOINTS.PROD); setConnectionStatus('cloud'); return; }
                    try {
                        const controller = new AbortController();
                        setTimeout(() => controller.abort(), 2000);
                        const res = await fetch(`${API_ENDPOINTS.LOCAL}/`, { method: 'GET', signal: controller.signal });
                        if (res.ok || res.status === 404) { setApiUrl(API_ENDPOINTS.LOCAL); setConnectionStatus('local'); }
                        else throw new Error('Err');
                    } catch (e) { setApiUrl(API_ENDPOINTS.PROD); setConnectionStatus('cloud'); }
                };
                checkConnection();
            }, []);

            // Toggle mobile scroll behavior based on results presence - DISABLE for fixed view
            // useEffect(() => {
            //     if (batchResults && batchResults.length > 0) {
            //         document.body.classList.add('mobile-result-scroll');
            //     } else {
            //         document.body.classList.remove('mobile-result-scroll');
            //     }
            // }, [batchResults]);

            useEffect(() => {
                const applyTheme = () => {
                    const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const isD = theme === 'dark' || (theme === 'system' && sysDark);
                    setIsDark(isD);
                    if (isD) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', theme);
                };
                applyTheme();
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
            }, [theme]);

            // Language State
            const [lang, setLang] = useState(() => localStorage.getItem('lang') || 'en');
            useEffect(() => { localStorage.setItem('lang', lang); }, [lang]);

            const t = (key) => {
                const keys = key.split('.');
                let val = TRANSLATIONS[lang];
                for (const k of keys) {
                    val = val ? val[k] : null;
                }
                return val || key;
            };

            // --- POLLING ---
            useEffect(() => {
                let interval;
                if (isPolling && jobId) {
                    interval = setInterval(async () => {
                        try {
                            const res = await fetch(`${BASE_URL}/batch_status/${jobId}`);
                            const data = await res.json();
                            setJobStatus(data.status);
                            if (data.status === 'completed') {
                                setIsPolling(false);
                                setBatchResults(data.result.results);
                                if (data.result.results.length > 0) {
                                    setCurrentSku(data.result.results[0].sku);
                                }
                            } else if (data.status === 'failed') {
                                setIsPolling(false);
                                setError("Job Failed: " + data.error);
                            }
                        } catch (e) { console.error(e); }
                    }, 2000);
                }
                return () => clearInterval(interval);
            }, [isPolling, jobId, BASE_URL]);

            // --- HANDLERS ---
            const handleFileChange = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                setFile(f);
                setError(null);
                setAvailableCols([]);
                setSkuCol("");
                setStartCol("");
                setEndCol("");
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary', cellDates: true });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const rawHeaders = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false })[0];

                        // Convert headers - handle Date objects and other types
                        const headers = rawHeaders.map(h => {
                            if (h instanceof Date) {
                                // Format Date as YYYY-MM-DD
                                return h.toISOString().split('T')[0];
                            } else if (typeof h === 'number') {
                                // Could be Excel serial date number - try to convert
                                // Excel serial date: days since 1900-01-01
                                const excelEpoch = new Date(1899, 11, 30);
                                const possibleDate = new Date(excelEpoch.getTime() + h * 24 * 60 * 60 * 1000);
                                // Check if it's a reasonable date (between 1990 and 2100)
                                if (possibleDate.getFullYear() >= 1990 && possibleDate.getFullYear() <= 2100) {
                                    return possibleDate.toISOString().split('T')[0];
                                }
                                return String(h);
                            }
                            return String(h);
                        });

                        console.log('Parsed headers:', headers.slice(0, 5), '...');

                        if (headers && headers.length > 0) {
                            setAvailableCols(headers);
                            setIsMappingModalOpen(true);
                        } else {
                            setError("No headers found in file.");
                        }
                    } catch (err) {
                        console.error('File parse error:', err);
                        setError("Failed to parse file headers");
                    }
                };
                reader.readAsBinaryString(f);
            };

            const handleMappingConfirm = (sku, start, end) => {
                setSkuCol(sku);
                setStartCol(start);
                setEndCol(end);
                setIsMappingModalOpen(false);

                // Calculate and store column indices immediately
                const skuIdx = availableCols.indexOf(sku);
                const startIdx = availableCols.indexOf(start);
                const endIdx = availableCols.indexOf(end);

                setSkuColIdx(skuIdx);
                setStartColIdx(startIdx);
                setEndColIdx(endIdx);

                console.log('Mapping confirmed - Indices:', { skuIdx, startIdx, endIdx });

                // Calculate total time series from column range
                const total = endIdx - startIdx + 1;
                setTotalTimeSeries(total);

                // Set initial values: Test = 6, Train = Total - 6, Forecast = Test
                const initialTest = Math.min(6, Math.floor(total / 2));
                const initialTrain = total - initialTest;
                setTestHorizon(initialTest.toString());
                setTrainHorizon(initialTrain.toString());
                setForecastSteps(initialTest.toString());
            };

            const handleExecute = async () => {
                if (!file || !skuCol || !startCol || !endCol) { setError("Please select file and map columns."); return; }
                if (skuColIdx < 0 || startColIdx < 0 || endColIdx < 0) { setError("Invalid column mapping. Please re-map columns."); return; }
                setError(null);
                setBatchResults(null);
                setJobStatus("queued");
                setActiveTab("overview");

                // Use stored indices directly
                console.log('Execute with indices:', { skuColIdx, startColIdx, endColIdx });

                const fd = new FormData();
                fd.append('file', file);
                fd.append('sku_col_idx', skuColIdx);
                fd.append('start_col_idx', startColIdx);
                fd.append('end_col_idx', endColIdx);
                fd.append('data_format', 'horizontal');
                fd.append('model_type', 'auto');
                fd.append('validation_method', validationMethod);
                fd.append('train_horizon', parseInt(trainHorizon) || 24);
                fd.append('test_horizon', parseInt(testHorizon) || 6);
                fd.append('forecast_steps', parseInt(forecastSteps) || 6);

                try {
                    const res = await fetch(`${BASE_URL}/batch_init`, { method: 'POST', body: fd });
                    if (!res.ok) throw new Error("Failed to start job");
                    const data = await res.json();
                    setJobId(data.job_id);
                    setIsPolling(true);
                } catch (e) { setError(e.message); }
            };

            const handleExport = async () => {
                if (!file || !skuCol || !startCol || !endCol) { setError("Please load and map data first."); return; }
                if (isExporting) return;
                setIsExporting(true);

                // Use fast export if cached results are available
                if (batchResults && batchResults.length > 0) {
                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('validation_method', validationMethod);
                    fd.append('forecast_steps', parseInt(forecastSteps) || 6);
                    fd.append('sku_col_idx', skuColIdx);
                    fd.append('start_col_idx', startColIdx);
                    fd.append('end_col_idx', endColIdx);
                    fd.append('data_format', 'horizontal');
                    fd.append('cached_results', JSON.stringify(batchResults));

                    try {
                        const res = await fetch(`${BASE_URL}/export-fast`, { method: 'POST', body: fd });
                        if (!res.ok) throw new Error("Export failed");
                        const inputBaseName = file.name.replace(/\.[^/.]+$/, "");
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                        let filename = `Operartis_Forecast_${inputBaseName}_${timestamp}.xlsx`;
                        const disposition = res.headers.get('Content-Disposition');
                        if (disposition && disposition.indexOf('attachment') !== -1) {
                            const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                            const matches = filenameRegex.exec(disposition);
                            if (matches != null && matches[1]) {
                                filename = matches[1].replace(/['"]/g, '');
                            }
                        }
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } catch (e) { setError(e.message); }
                    finally { setIsExporting(false); }
                } else {
                    // Fallback to slow export if no cached results
                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('model_type', 'auto');
                    fd.append('validation_method', validationMethod);
                    fd.append('train_horizon', parseInt(trainHorizon) || 24);
                    fd.append('test_horizon', parseInt(testHorizon) || 6);
                    fd.append('forecast_steps', parseInt(forecastSteps) || 6);
                    fd.append('sku_col_idx', skuColIdx);
                    fd.append('start_col_idx', startColIdx);
                    fd.append('end_col_idx', endColIdx);
                    fd.append('data_format', 'horizontal');

                    try {
                        const res = await fetch(`${BASE_URL}/export`, { method: 'POST', body: fd });
                        if (!res.ok) throw new Error("Export failed");
                        const inputBaseName = file.name.replace(/\.[^/.]+$/, "");
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                        let filename = `Operartis_Forecast_${inputBaseName}_${timestamp}.xlsx`;
                        const disposition = res.headers.get('Content-Disposition');
                        if (disposition && disposition.indexOf('attachment') !== -1) {
                            const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                            const matches = filenameRegex.exec(disposition);
                            if (matches != null && matches[1]) {
                                filename = matches[1].replace(/['"]/g, '');
                            }
                        }
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } catch (e) { setError(e.message); }
                    finally { setIsExporting(false); }
                }
            };

            const handleReset = () => {
                setFile(null); setBatchResults(null); setJobId(null); setIsPolling(false); setError(null);
                setSkuCol(""); setStartCol(""); setEndCol("");
                setSkuColIdx(-1); setStartColIdx(-1); setEndColIdx(-1);
                setTotalTimeSeries(0); setAvailableCols([]);
                if (fileInputRef.current) fileInputRef.current.value = "";
            };

            const handleSkuSelect = (sku) => {
                if (batchResults && batchResults.find(r => r.sku === sku)) {
                    setCurrentSku(sku);
                    setActiveTab("details");
                }
            };

            const cycleSku = (dir) => {
                if (!batchResults || !currentSku) return;
                const idx = batchResults.findIndex(r => r.sku === currentSku);
                if (idx === -1) return;
                let newIdx = idx + dir;
                if (newIdx < 0) newIdx = batchResults.length - 1;
                if (newIdx >= batchResults.length) newIdx = 0;
                setCurrentSku(batchResults[newIdx].sku);
            };

            const getCurrentSkuData = () => {
                if (!batchResults || !currentSku) return null;
                return batchResults.find(r => r.sku === currentSku);
            };

            const skuData = getCurrentSkuData();

            // Synchronize Validation Data with Forecast Data Timeline
            const alignedValidationData = useMemo(() => {
                if (!skuData || !skuData.forecast_data || !skuData.validation_data) return null;
                const valMap = new Map(skuData.validation_data.map(d => [d.date, d]));
                return skuData.forecast_data.map(fd => {
                    const vd = valMap.get(fd.date);
                    return {
                        date: fd.date, // Use forecast date as master axis
                        actual_train: vd ? vd.actual_train : null,
                        actual_test: vd ? vd.actual_test : null,
                        fitted: vd ? vd.fitted : null,
                        val_forecast: vd ? vd.val_forecast : null
                    };
                });
            }, [skuData]);

            return (
                <div className="flex h-full bg-slate-50 dark:bg-slate-950 overflow-hidden relative w-full transition-colors duration-300 mobile-landscape-root">
                    <MappingModal headers={availableCols} isOpen={isMappingModalOpen} onClose={() => setIsMappingModalOpen(false)} onConfirm={handleMappingConfirm} t={t} />
                    {/* Mobile Sidebar Backdrop */}
                    {isSidebarOpen && (
                        <div
                            className="lg:hidden fixed inset-0 z-40 bg-slate-900/20 backdrop-blur-sm transition-opacity"
                            onClick={() => setIsSidebarOpen(false)}
                        />
                    )}

                    {/* SIDEBAR */}
                    <aside className={`${isFullScreen ? 'hidden' : 'flex'} fixed lg:relative inset-y-0 left-0 z-50 w-64 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-r border-white/20 dark:border-white/10 flex flex-col h-full shadow-2xl lg:shadow-none transform transition-transform duration-300 ease-in-out ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                        <div className="h-16 flex items-center justify-center px-4 border-b border-white/20 dark:border-white/10 shrink-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md gap-2 relative sticky top-0 z-20">
                            <a href="https://operartis.vercel.app/terminal.html">
                                <img src="./icononly_transparent_nobuffer.png" className="h-8 w-8 md:h-10 md:w-10 object-contain cursor-pointer transition-transform hover:scale-110" onError={(e) => e.target.style.display = 'none'} />
                            </a>
                            <h1 className="font-bold text-slate-800 dark:text-slate-100 tracking-tight text-base">OPERARTIS</h1>
                            <button onClick={() => setIsSidebarOpen(false)} className="lg:hidden absolute right-4 text-slate-400"><XIcon /></button>
                        </div>

                        <div className="flex-1 overflow-y-auto scroller px-3 pt-3 pb-0 gap-6 min-h-0 flex flex-col">
                            {/* 1. Source Data */}
                            <div>
                                <h3 className="text-xxs font-bold text-brand-gold uppercase tracking-widest mb-2 flex items-center gap-2">{t('sidebar.source_data')}<span className="h-px flex-1 bg-brand-gold"></span></h3>
                                <div className={`relative border border-dashed rounded px-3 py-6 text-center transition-colors group ${file ? (skuCol && startCol && endCol ? 'border-emerald-500 bg-gradient-to-br from-emerald-500/10 to-teal-500/10' : 'border-brand-gold bg-amber-50/10') : 'border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer'}`}>
                                    <input ref={fileInputRef} type="file" className="hidden" accept=".xlsx,.xls" onChange={handleFileChange} />
                                    <div onClick={() => !file && fileInputRef.current.click()} className={!file ? "cursor-pointer flex flex-col items-center justify-center gap-2" : ""}>
                                        {file ? (
                                            <div className="flex flex-col items-center gap-1">
                                                <div onClick={() => fileInputRef.current.click()} className="text-xs font-bold text-slate-700 dark:text-slate-200 truncate px-2 cursor-pointer hover:underline mb-1">{file.name}</div>
                                                <div className="text-[10px] text-emerald-500 font-bold uppercase">{skuCol && startCol && endCol ? t('sidebar.uploaded_mapped') : t('sidebar.action_required')}</div>
                                                <div className="flex gap-2 mt-2 justify-center">
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); fileInputRef.current.click(); }}
                                                        className="p-1.5 min-w-[28px] min-h-[28px] rounded-full bg-slate-100 dark:bg-slate-800 text-slate-400 hover:text-brand-gold hover:bg-white dark:hover:bg-slate-700 shadow-sm transition-all"
                                                        title={t('sidebar.reupload_file')}
                                                    >
                                                        <UploadIcon width="14" height="14" />
                                                    </button>
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); setIsMappingModalOpen(true); }}
                                                        className="p-1.5 min-w-[28px] min-h-[28px] rounded-full bg-slate-100 dark:bg-slate-800 text-slate-400 hover:text-brand-gold hover:bg-white dark:hover:bg-slate-700 shadow-sm transition-all"
                                                        title={t('sidebar.edit_mapping')}
                                                    >
                                                        <SettingsIcon width="14" height="14" />
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <>
                                                <UploadIcon className="w-8 h-8 text-slate-300 dark:text-slate-600 mb-1" />
                                                <div className="text-xs text-slate-500 font-medium">{t('sidebar.upload_label')}</div>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* 2. Configuration */}
                            <div className="border-t border-slate-100 dark:border-slate-800 pt-4">
                                <h3 className="text-xxs font-bold text-brand-gold uppercase tracking-widest mb-3 flex items-center gap-2">{t('sidebar.configuration')}<span className="h-px flex-1 bg-brand-gold"></span></h3>
                                <form className="space-y-3" onSubmit={(e) => e.preventDefault()}>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t('sidebar.val_method')}</label>
                                        <select value={validationMethod} onChange={(e) => setValidationMethod(e.target.value)} className="w-full h-8 text-xxs border rounded px-2 bg-white dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 outline-none focus:border-brand-gold transition-colors"><option value="simple">Simple Split (Fast)</option><option value="walk_forward">Walk-Forward (Adaptive)</option><option value="rolling_window">Rolling Window (Adaptive)</option></select>

                                    </div>
                                    <div className="flex gap-2">
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t('sidebar.train_h')}</label>
                                            <input
                                                type="number"
                                                value={trainHorizon}
                                                onChange={(e) => setTrainHorizon(e.target.value)}
                                                onBlur={() => setTrainHorizon(prev => Math.max(1, parseInt(prev) || 1).toString())}
                                                className={`w-full h-8 text-xxs border rounded px-2 bg-white dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 outline-none focus:border-brand-gold transition-colors dark:[color-scheme:dark] ${horizonMismatch ? 'border-red-400' : ''}`}
                                            />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t('sidebar.test_h')}</label>
                                            <input
                                                type="number"
                                                value={testHorizon}
                                                onChange={(e) => {
                                                    const newTest = parseInt(e.target.value) || 0;
                                                    setTestHorizon(e.target.value);
                                                    // Auto-update train horizon when test changes
                                                    if (totalTimeSeries > 0 && newTest > 0 && newTest < totalTimeSeries) {
                                                        setTrainHorizon((totalTimeSeries - newTest).toString());
                                                    }
                                                }}
                                                onBlur={() => setTestHorizon(prev => Math.max(1, parseInt(prev) || 1).toString())}
                                                min="1"
                                                className={`w-full h-8 text-xxs border rounded px-2 bg-white dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 outline-none focus:border-brand-gold transition-colors dark:[color-scheme:dark] ${horizonMismatch ? 'border-red-400' : ''}`}
                                            />
                                        </div>
                                    </div>
                                    {totalTimeSeries > 0 && (
                                        <div className={`text-[9px] ${horizonMismatch ? 'text-red-500' : 'text-slate-400'}`}>
                                            {horizonMismatch
                                                ? `⚠️ ${t('sidebar.horizon_mismatch')} ${totalTimeSeries}`
                                                : `${t('sidebar.total_periods')}: ${totalTimeSeries}`
                                            }
                                        </div>
                                    )}
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t('sidebar.fc_h')}</label>
                                        <input
                                            type="number"
                                            value={forecastSteps}
                                            onChange={(e) => setForecastSteps(e.target.value)}
                                            onBlur={() => setForecastSteps(prev => Math.max(1, parseInt(prev) || 1).toString())}
                                            min="1"
                                            className="w-full h-8 text-xxs border rounded px-2 bg-white dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 outline-none focus:border-brand-gold transition-colors dark:[color-scheme:dark]"
                                        />
                                    </div>
                                    <button type="button" onClick={handleExecute} disabled={!file || isPolling} className={`w-full py-2.5 rounded text-xs font-bold uppercase tracking-wide transition-all shadow-sm flex items-center justify-center gap-2 ${!file || isPolling ? 'bg-slate-100 dark:bg-slate-800 text-slate-400 cursor-not-allowed' : 'bg-brand-gold text-white hover:bg-brand-dark'}`}>
                                        {isPolling ? <div className="animate-spin"><RefreshIcon /></div> : <PlayIcon />}
                                        {isPolling ? t('sidebar.processing') : t('sidebar.execute_btn')}
                                    </button>
                                    <button type="button" onClick={handleExport} disabled={!file || !batchResults || isExporting || isPolling} className={`w-full py-2.5 rounded text-xs font-bold uppercase tracking-wide transition-all shadow-sm flex items-center justify-center gap-2 ${!file || !batchResults || isExporting || isPolling ? 'bg-slate-100 dark:bg-slate-800 text-slate-400 cursor-not-allowed' : 'bg-emerald-500 text-white hover:bg-emerald-600'}`}>
                                        {isExporting ? <div className="animate-spin"><RefreshIcon /></div> : <DownloadIcon />}
                                        {isExporting ? t('sidebar.downloading') : t('sidebar.export_btn')}
                                    </button>

                                    {/* Removed Reset Button from here */}
                                </form>
                            </div>

                            {/* Reset Button Area - Inside Body, Pushed to Bottom */}
                            <div className="px-3 pb-1 pt-4 !mt-auto">
                                <div className="pt-4 border-t border-dashed border-slate-200 dark:border-slate-700">
                                    <button type="button" onClick={handleReset} className="w-full py-2 text-xxs font-bold text-slate-400 hover:text-red-500 border border-transparent hover:border-red-200 rounded transition-colors uppercase tracking-wide flex items-center justify-center gap-2 transition-all"><RefreshIcon /> {t('sidebar.reset_btn')}</button>
                                </div>
                            </div>
                        </div>


                        {/* Sticky Sidebar Footer */}
                        <div className="sticky bottom-0 z-20 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-t border-white/20 dark:border-white/10 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)]">
                            <div className="p-4 text-center">
                                <p className="text-xs font-bold text-slate-700 dark:text-slate-200 uppercase tracking-wide">Operartis Analytics</p>
                                <p className="text-[10px] text-brand-gold mt-1 font-medium italic">Optimizing Today, Growing Tomorrow</p>
                            </div>
                        </div>
                    </aside >

                    {/* MAIN CONTENT */}
                    < div className="flex flex-col flex-grow min-w-0 transition-all relative" >
                        {/* Combined Header & Metrics Bar */}
                        < div className={`flex flex-col sticky top-0 z-30 ${isFullScreen ? 'hidden' : ''}`}>
                            <header className="h-16 bg-white/60 dark:bg-slate-900/60 backdrop-blur-md border-b border-white/20 dark:border-white/10 flex items-center justify-between px-6 shrink-0 shadow-sm relative">
                                <div className="flex items-center gap-4"><button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="lg:hidden text-slate-500"><MenuIcon /></button></div>
                                <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-sm md:text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-brand-gold to-brand-dark uppercase tracking-widest whitespace-nowrap">{t('header.title')}</div>
                                <div className="flex items-center gap-4">
                                    <div className="hidden sm:flex items-center gap-2 text-xs font-mono text-slate-500 dark:text-slate-400">
                                        <div className={`hidden lg:flex items-center gap-1.5 px-2 py-1 rounded-md border ${connectionStatus === 'local' ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'bg-sky-50 text-sky-600 border-sky-200'}`}><ServerIcon /><span>{connectionStatus === 'local' ? t('header.local') : t('header.cloud')}</span></div>
                                        <div className="hidden lg:block w-px h-4 bg-slate-300 mx-2"></div><ClockIcon /><LiveClock />
                                    </div>
                                    <button onClick={() => setIsSettingsOpen(true)} className="text-slate-400 hover:text-brand-gold"><SettingsIcon /></button>
                                </div>
                            </header>

                            {/* KPI BAR */}
                            <div className="min-h-16 bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl border-b border-white/20 dark:border-white/10 flex items-center shrink-0 shadow-sm overflow-x-auto relative">
                                <KPICards results={batchResults} activeTab={activeTab} setActiveTab={setActiveTab} currentSku={currentSku} handleSkuSelect={handleSkuSelect} cycleSku={cycleSku} t={t} />
                            </div>
                        </div >

                        <main className={`flex-grow flex flex-col bg-slate-50 dark:bg-slate-950 relative w-full h-full overflow-hidden mobile-landscape-main ${isFullScreen ? 'hidden' : 'flex'}`}>

                            {/* CONTENT AREA */}
                            <div className="flex-1 p-2 md:p-4 relative overflow-y-auto scroller md:min-h-0 mobile-landscape-content">
                                {!batchResults && (
                                    isPolling ? (
                                        <ForecastingLoader t={t} validationMethod={validationMethod} testHorizon={testHorizon} />
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-300 dark:text-slate-600">
                                            <div className="w-16 h-16 border-2 border-dashed rounded flex items-center justify-center mb-2"><LayoutDashboardIcon /></div>
                                            <span className="text-xs font-bold uppercase tracking-widest">{t('dashboard.no_results')}</span>
                                        </div>
                                    )
                                )}

                                {batchResults && activeTab === 'overview' && <BatchOverview results={batchResults} onSelectSku={handleSkuSelect} t={t} />}

                                {batchResults && activeTab === 'details' && skuData && (
                                    <div className="h-full flex flex-col gap-4 mobile-compact-gap" key={layoutKey}>
                                        <div className="flex-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded shadow-sm p-1 lg:p-4 mobile-compact-p relative flex flex-col min-h-0">
                                            <div className="flex flex-col h-full gap-2 mobile-landscape-chart-row mobile-compact-gap">
                                                <div ref={chartRowRef} className={`flex-1 border-b border-dashed border-slate-200 relative mobile-landscape-chart-sep ${isLegendOverlap ? 'force-legend-drop' : ''}`}>
                                                    {/* Metrics Overlay */}
                                                    <div ref={metricsOverlayRef} className="absolute top-0 right-0 lg:right-2 z-10 flex items-center gap-2 lg:gap-4 bg-white/40 dark:bg-white/5 p-1 lg:p-2 rounded-lg lg:rounded-xl backdrop-blur-md shadow-lg border border-white/20 dark:border-white/10 ring-1 ring-black/5 dark:ring-white/5">
                                                        <div className="flex flex-col items-end">
                                                            <span className="text-[8px] lg:text-[10px] uppercase font-bold text-slate-400">{t('dashboard.best_model')}</span>
                                                            <span className="text-[10px] lg:text-xs font-bold text-brand-gold">{skuData.best_ts_model.toUpperCase()}</span>
                                                        </div>
                                                        <div className="flex flex-col items-end">
                                                            <span className="text-[8px] lg:text-[10px] uppercase font-bold text-slate-400">{t('dashboard.val_mse')}</span>
                                                            <span className="text-[10px] lg:text-xs font-mono font-bold text-slate-700 dark:text-slate-300">{fmtNumber(skuData.mse_validation, 0, 0)}</span>
                                                        </div>
                                                    </div>
                                                    {/* SKU Name Overlay */}
                                                    <div ref={skuOverlayRef} className="absolute top-0 lg:top-2 left-0 lg:left-2 z-10 flex items-center gap-0.5 lg:gap-1 bg-white/40 dark:bg-white/5 pl-0.5 pr-1.5 py-0.5 lg:pl-1 lg:pr-3 lg:py-1 rounded-full backdrop-blur-md border border-white/20 dark:border-white/10 shadow-lg hover:bg-white/60 dark:hover:bg-white/10 transition-all ring-1 ring-black/5 dark:ring-white/5">
                                                        <button onClick={() => cycleSku(-1)} className="p-0.5 lg:p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200"><ChevronLeftIcon /></button>
                                                        <span className="text-xs lg:text-lg font-black text-slate-800 dark:text-slate-100 tracking-tight mx-0.5 lg:mx-1">{skuData.sku}</span>
                                                        <button onClick={() => cycleSku(1)} className="p-0.5 lg:p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200"><ChevronRightIcon /></button>
                                                    </div>
                                                    <BacktestChart data={alignedValidationData} syncId="sv" isDark={isDark} t={t} />
                                                </div>
                                                <div className={`flex-1 relative ${isLegendOverlap ? 'force-legend-drop' : ''}`}>
                                                    <ForecastChart data={skuData.forecast_data} syncId="sv" isDark={isDark} t={t} />
                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                )}
                            </div>
                        </main>
                    </div >

                    {/* FULL SCREEN */}


                    < SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} baseUrl={BASE_URL} theme={theme} setTheme={setTheme} lang={lang} setLang={setLang} t={t} />
                </div >
            );
        };
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>