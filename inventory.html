<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operartis | Inventory Optimizer</title>

    <link rel="icon" type="image/png" href="./icononly_transparent_quadratic.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { gold: '#f59e0b', dark: '#b45309', slate: '#1e293b' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['Roboto Mono', 'monospace'] }
                }
            }
        }
    </script>

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.development.js"></script>
    <script crossorigin
        src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.development.js"></script>

    <!-- PropTypes is required by Recharts UMD build -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.1.12/Recharts.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Roboto+Mono:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
        }

        .dark body {
            background: #0f172a;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .scroller::-webkit-scrollbar {
            width: 4px;
        }

        /* Custom thin scrollbars for Statistical Table */
        .stat-table-scroll::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        .stat-table-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .stat-table-scroll::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 2px;
        }

        .stat-table-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .dark .stat-table-scroll::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark .stat-table-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .stat-table-scroll::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* Custom select dropdown arrows - dark text in light mode, white in dark mode */
        select.custom-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M7 10l5 5 5-5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px !important;
        }

        .dark select.custom-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M7 10l5 5 5-5'/%3E%3C/svg%3E");
        }

        /* Custom number input spinners - dark in light mode, white in dark mode */
        input[type='number'].custom-input::-webkit-inner-spin-button,
        input[type='number'].custom-input::-webkit-outer-spin-button {
            opacity: 1;
            filter: invert(0);
        }

        .dark input[type='number'].custom-input::-webkit-inner-spin-button,
        .dark input[type='number'].custom-input::-webkit-outer-spin-button {
            filter: invert(1);
        }

        .dark .stat-table-scroll::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark .stat-table-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .stat-table-scroll::-webkit-scrollbar-corner {
            background: transparent;
        }

        @keyframes slide-up {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-slide-up {
            animation: slide-up 0.3s ease-out;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(245, 158, 11, 0);
            }
        }

        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        @keyframes order-arrive {
            0% {
                transform: translateY(-10px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .order-arrive {
            animation: order-arrive 0.3s ease-out;
        }
    </style>
</head>

<body class="text-slate-800 dark:text-slate-100 transition-colors duration-300">

    <div id="root" class="h-screen w-screen flex flex-col overflow-hidden">
        <div class="m-auto text-center p-4">
            <h1 class="text-xl font-bold text-slate-400 animate-pulse">Loading Application...</h1>
            <p class="text-sm text-slate-500 mt-2">If this stays visible, please check your internet connection.</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const { ComposedChart, Line, Area, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend, ReferenceLine } = window.Recharts;

        // --- ICONS ---
        const PlayIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const PauseIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></svg>;
        const StepForwardIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 4 15 12 5 20 5 4" /><line x1="19" x2="19" y1="5" y2="19" /></svg>;
        const RewindIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 19 2 12 11 5 11 19" /><polygon points="22 19 13 12 22 5 22 19" /></svg>;
        const FastForwardIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 19 22 12 13 5 13 19" /><polygon points="2 19 11 12 2 5 2 19" /></svg>;
        const BoxIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>;
        const RefreshIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;
        const UploadIcon = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>;
        const SettingsIcon = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>;
        const XIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" x2="6" y1="6" y2="18" /><line x1="6" x2="18" y1="6" y2="18" /></svg>;
        const TruckIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11" /><path d="M14 9h4l4 4v4c0 .6-.4 1-1 1h-2" /><circle cx="7" cy="18" r="2" /><path d="M15 18H9" /><circle cx="17" cy="18" r="2" /></svg>;
        const PackageIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m7.5 4.27 9 5.15" /><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" /><path d="m3.3 7 8.7 5 8.7-5" /><path d="M12 22V12" /></svg>;
        const AlertTriangleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" x2="12" y1="9" y2="13" /><line x1="12" x2="12.01" y1="17" y2="17" /></svg>;
        const SunIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5" /><line x1="12" x2="12" y1="1" y2="3" /><line x1="12" x2="12" y1="21" y2="23" /><line x1="4.22" x2="5.64" y1="4.22" y2="5.64" /><line x1="18.36" x2="19.78" y1="18.36" y2="19.78" /><line x1="1" x2="3" y1="12" y2="12" /><line x1="21" x2="23" y1="12" y2="12" /><line x1="4.22" x2="5.64" y1="19.78" y2="18.36" /><line x1="18.36" x2="19.78" y1="5.64" y2="4.22" /></svg>;
        const MoonIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" /></svg>;
        const FileIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></svg>;
        const LoaderIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>;
        const GlobeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><line x1="2" x2="22" y1="12" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg>;

        // --- TRANSLATIONS ---
        const translations = {
            en: {
                // Header
                inventoryOptimizer: 'Inventory Optimizer',
                stochasticPolicy: 'Stochastic (s, S) Policy',

                // Sidebar - Mode Toggle
                optimizeMode: 'Optimize',
                whatIfMode: 'What-If',

                // Sidebar - File
                dataSource: 'Data Source',
                inputData: 'Input Data',
                uploadInputData: 'Upload Input Data',

                // Sidebar - Parameters
                parameters: 'Parameters',
                simulationParameters: 'Simulation Parameters',
                initialStock: 'Initial Stock',
                leadTime: 'Lead Time',
                leadTimeDays: 'Lead Time (days)',
                reviewPeriod: 'Review Period R (days)',
                targetServiceLevel: 'Target Service Level Œ±',
                safetyFactor: 'Safety Factor k',
                moq: 'Min Order Quantity',
                minOrderQty: 'Min Order Qty',

                // Lead Time Types
                type: 'Type',
                valueDays: 'Value (days)',
                deterministicFixed: 'Deterministic (Fixed)',
                customDiscrete: 'Custom Discrete',
                discreteUniform: 'Discrete Uniform',
                deterministic: 'Deterministic',
                discreteValues: 'Discrete Values',
                valuesAndProbabilities: 'Values & Probabilities',
                add: 'Add',
                poisson: 'Poisson',
                binomial: 'Binomial',
                uniform: 'Uniform',
                minDays: 'Min (days)',
                maxDays: 'Max (days)',
                expectedValueDays: 'Expected value ‚âà',
                days: 'days',
                reviewDay: 'Review Day',

                // Review Period Options
                daily: 'Daily',
                weekly: 'Weekly',
                biWeekly: 'Bi-Weekly',
                monthly: 'Monthly',

                // Sidebar - SKU Navigator
                skuNavigator: 'SKU Navigator',


                inventoryPolicy: 'Inventory Policy',

                // Sidebar - Actions
                findOptimalPolicy: 'Find Optimal Policy',
                optimizing: 'Optimizing...',
                optimizeAll: 'Optimize All',
                runSimulation: 'Run Simulation',
                simulating: 'Simulating...',
                simulateAll: 'Simulate All',
                resetAll: 'Reset All',
                parametersLocked: 'Parameters locked. Switch to <strong>What-If</strong> mode to edit.',
                optimizeModeDesc: 'üéØ Find optimal policy for target service level',
                whatIfModeDesc: 'üî¨ Test a specific scenario manually',

                // Result Section
                result: 'Result',
                optimalPolicyFound: '‚úì Optimal Policy Found',
                bestPolicyFound: '~ Best Policy Found',
                targetAlpha: 'Target Œ±',
                achievedAlpha: 'Achieved Œ±',
                achievedBeta: 'Achieved Œ≤',
                avgReorderPoint: 'Avg Reorder Point (s)',
                avgOrderUpTo: 'Avg Order-Up-To (S)',
                recommendedInitialStock: 'Recommended Initial Stock',
                foundInIterations: 'Found in {0} iterations',

                // Main View
                liveInventorySimulation: 'Live Inventory Simulation',
                statisticalLiveTable: 'Statistical Live Table',
                backToChart: 'Back to Chart',
                periods: 'periods',

                // View Modes
                interface: 'Interface',
                summary: 'Summary',
                individual: 'Individual',
                readyToSimulate: 'Ready to Simulate',
                loadDataPrompt: 'Load data and click Simulate',
                optimizing: 'OPTIMIZING...',
                simulating: 'SIMULATING...',

                // Metrics
                alphaFull: 'Œ± (Full)',
                betaFull: 'Œ≤ (Full)',
                alphaSteady: 'Œ± (Steady)',
                betaSteady: 'Œ≤ (Steady)',
                betaSteady: 'Œ≤ (Steady)',
                avgInv: 'Avg Inventory',
                avgServiceLevel: 'AVG SERVICE LEVEL (Œ±)',
                avgFillRate: 'AVG FILL RATE (Œ≤)',
                avgStockoutDays: 'Avg Stockout Days',
                skusBelow90: 'SKUS BELOW 90% (Œ±)',
                skuId: 'SKU ID',
                alphaCol: 'ALPHA (Œ±)',
                betaCol: 'BETA (Œ≤)',
                safetyFactorCol: 'SAFETY FACTOR',
                avgInvCol: 'AVG INV',
                stockoutsCol: 'STOCKOUTS',
                actionCol: 'ACTION',
                view: 'View',
                optimizedSteadyState: '‚úì Optimized (Steady-State Œ±/Œ≤)',
                skusOptimized: 'optimized',
                skusSimulated: 'simulated',
                statusSimulating: 'Simulating...',
                statusReadyToPlay: 'Ready to Play',
                statusAwaitingSetup: 'Awaiting Setup',

                // Real-time Panel
                onHand: 'On Hand',
                demand: 'Demand',
                arrived: 'Arrived',
                inTransit: 'In Transit',
                invPosition: 'Inv. Position',
                backlog: 'Backlog',
                stockout: 'STOCKOUT!',
                unfulfilled: 'Unfulfilled',
                orders: 'order(s)',

                // Playback
                reload: 'Reload with new random demand',
                resetToDay1: 'Reset to Day 1',
                stepForward: 'Step Forward',
                day: 'Day',
                speed: 'SPEED',

                //Table View
                parameterDate: 'Parameter/Date',
                reorderPoint: 's_t (Reorder Point)',
                orderUpTo: 'S_t (Order-Up-To)',
                orderPlaced: 'Order Placed?',
                arrivedOrders: 'Arrived Orders',
                stockoutQuestion: 'Stockout?',
                reviewDayQuestion: 'Review Day?',
                viewChart: 'View Chart',
                viewTable: 'View Statistical Table',

                // Chart/Tooltips
                now: 'NOW',
                targetSt: 'Target S(t)',
                reorderSt: 'Reorder s(t)',
                orderArrival: 'Order Arrival',

                // Loading
                runningMonteCarlo: 'Running Monte Carlo...',
                searchingOptimal: 'Searching optimal policy...',

                // Warnings
                warmupStockoutWarning: '{0} stockout days during warm-up (first {1} days)',

                // Summary Dashboard
                skuPerformanceSummary: 'SKU Performance Summary',
                sku: 'SKU',
                alpha: 'Œ±',
                beta: 'Œ≤',
                stockouts: 'Stockouts',
                status: 'Status',
                excellent: 'Excellent',
                good: 'Good',
                needsAttention: 'Needs Attention',

                // Statistical Table params
                reorderPoint: 'Reorder Point s(t)',
                orderUpTo: 'Order-Up-To S(t)',
                actualDemand: 'Actual Demand',
                invBeforeDemand: 'Inv Before Demand',
                invAfterDemand: 'Inv After Demand',
                shortage: 'Shortage',
                orderQty: 'Order Qty',
                arrivedQty: 'Arrived Qty',
                pipelineOrders: 'Pipeline Orders',
                inventoryPosition: 'Inventory Position',

                // Upload states
                noDataLoaded: 'No data loaded',
                clickToUpload: 'Click to upload forecast data',

                // Mapping Modal
                detected: 'Detected',
                mapColumns: 'Map Columns',
                auto: 'AUTO',
                p50P90Detected: 'P50 & P90 Columns Detected',
                formatP50P90: 'Format: P50_DD.MM.YYYY, P90_DD.MM.YYYY (complete data)',
                p50Columns: 'P50 Columns',
                p90Columns: 'P90 Columns',
                days: 'days',
                skuIdColumn: 'SKU ID Column',
                select: '-- Select --',
                notMapped: '-- Not Mapped --',
                optionalParameters: 'Optional Parameters',
                selectColumnToMap: 'Select column to map',
                detectedParameters: 'Detected Parameters',
                lockedOnSidebar: '‚úì = Locked on sidebar',
                uncheckToEdit: 'Uncheck to manually edit on sidebar',
                locked: 'Locked',
                editable: 'Editable',
                cancel: 'Cancel',
                confirm: 'Confirm',
                confirmLoadParams: 'Confirm & Load Params',

                // Export Report
                exportReport: 'Export Report',
                exporting: 'Exporting...',
                exportSuccess: 'Report exported successfully',
                exportError: 'Export failed',

                // File Upload Errors
                invalidFileFormat: 'Invalid File Format',
                noHeadersFound: 'No headers found in file. Please check that you have uploaded a valid Excel or CSV file with data.',
                noValidDataFound: 'No valid data found. Please check that your file contains the required columns.',
                fileReadError: 'Error reading file',
                fileParseError: 'Error parsing file',

                // Operartis Mapping Modal
                operartisForecastDetected: 'Operartis Forecast Report Detected',
                //residualBasedModel: 'Residual-based uncertainty model (œÉ‚Çï = Resid_Std √ó ‚àöh)',
                skuColumn: 'SKU Column',
                residStdLabel: 'Resid_Std',
                dateColumnsLabel: 'Date Columns',
                residStdColumn: 'Resid_Std Column',
                forecastHorizonDays: 'Forecast Horizon (days)',
                lastDaysAsForecast: 'Last {0} date columns will be used as forecasts',
                forecastHorizonTip: 'Tip: The forecast horizon is auto-detected from the file if available',
                serviceLevel: 'Service Level'
            },
            vi: {
                // Header
                inventoryOptimizer: 'T·ªëi ∆Øu H√†ng T·ªìn',
                stochasticPolicy: 'Ch√≠nh s√°ch (s, S) Ng·∫´u nhi√™n',

                // Sidebar - Mode Toggle
                optimizeMode: 'T·ªëi ∆∞u',
                whatIfMode: 'Gi·∫£ l·∫≠p',

                // Sidebar - File
                dataSource: 'Ngu·ªìn d·ªØ li·ªáu',
                inputData: 'D·ªØ li·ªáu ƒë·∫ßu v√†o',
                uploadInputData: 'T·∫£i l√™n d·ªØ li·ªáu',

                // Sidebar - Parameters
                parameters: 'Tham s·ªë',
                simulationParameters: 'Tham s·ªë m√¥ ph·ªèng',
                initialStock: 'T.kho ban ƒë·∫ßu',
                leadTime: 'Th·ªùi gian giao h√†ng',
                leadTimeDays: 'Th·ªùi gian giao (ng√†y)',
                reviewPeriod: 'Chu k·ª≥ ki·ªÉm kho R (ng√†y)',
                targetServiceLevel: 'M·ª©c d·ªãch v·ª• m·ª•c ti√™u Œ±',
                safetyFactor: 'H·ªá s·ªë an to√†n k',
                moq: 'SL ƒë·∫∑t h√†ng t·ªëi thi·ªÉu',
                minOrderQty: 'SL t·ªëi thi·ªÉu',

                // Lead Time Types
                type: 'Lo·∫°i',
                valueDays: 'Gi√° tr·ªã (ng√†y)',
                deterministicFixed: 'X√°c ƒë·ªãnh (C·ªë ƒë·ªãnh)',
                customDiscrete: 'R·ªùi r·∫°c t√πy ch·ªânh',
                discreteUniform: 'ƒê·ªÅu r·ªùi r·∫°c',
                deterministic: 'X√°c ƒë·ªãnh',
                discreteValues: 'Gi√° tr·ªã r·ªùi r·∫°c',
                valuesAndProbabilities: 'Gi√° tr·ªã & X√°c su·∫•t',
                add: 'Th√™m',
                poisson: 'Poisson',
                binomial: 'Nh·ªã th·ª©c',
                uniform: 'ƒê·ªÅu',
                minDays: 'T·ªëi thi·ªÉu (ng√†y)',
                maxDays: 'T·ªëi ƒëa (ng√†y)',
                expectedValueDays: 'Gi√° tr·ªã k·ª≥ v·ªçng ‚âà',
                days: 'ng√†y',
                reviewDay: 'Ng√†y ki·ªÉm kho',

                // Review Period Options
                daily: 'H√†ng ng√†y',
                weekly: 'H√†ng tu·∫ßn',
                biWeekly: 'Hai tu·∫ßn',
                monthly: 'H√†ng th√°ng',

                // Sidebar - SKU Navigator
                skuNavigator: 'ƒêi·ªÅu h∆∞·ªõng SKU',
                inventoryPolicy: 'Ch√≠nh s√°ch t·ªìn kho',

                // Sidebar - Actions
                findOptimalPolicy: 'T√¨m ch√≠nh s√°ch t·ªëi ∆∞u',
                optimizing: 'ƒêang t·ªëi ∆∞u...',
                optimizeAll: 'T·ªëi ∆∞u t·∫•t c·∫£',
                runSimulation: 'Ch·∫°y m√¥ ph·ªèng',
                simulating: 'ƒêang m√¥ ph·ªèng...',
                simulateAll: 'M√¥ ph·ªèng t·∫•t c·∫£',
                resetAll: 'ƒê·∫∑t l·∫°i',
                parametersLocked: 'Tham s·ªë ƒë√£ kh√≥a. Chuy·ªÉn sang ch·∫ø ƒë·ªô <strong>Gi·∫£ l·∫≠p</strong> ƒë·ªÉ ch·ªânh s·ª≠a.',
                optimizeModeDesc: 'üéØ T√¨m ch√≠nh s√°ch t·ªëi ∆∞u cho m·ª©c d·ªãch v·ª• m·ª•c ti√™u',
                whatIfModeDesc: 'üî¨ Ki·ªÉm tra k·ªãch b·∫£n c·ª• th·ªÉ theo c√°ch th·ªß c√¥ng',

                // Result Section
                result: 'K·∫øt qu·∫£',
                optimalPolicyFound: '‚úì ƒê√£ t√¨m th·∫•y ch√≠nh s√°ch t·ªëi ∆∞u',
                bestPolicyFound: '~ ƒê√£ t√¨m th·∫•y ch√≠nh s√°ch t·ªët nh·∫•t',
                targetAlpha: 'M·ª•c ti√™u Œ±',
                achievedAlpha: 'ƒê·∫°t ƒë∆∞·ª£c Œ±',
                achievedBeta: 'ƒê·∫°t ƒë∆∞·ª£c Œ≤',
                avgReorderPoint: 'TB ƒêi·ªÉm ƒë·∫∑t h√†ng (s)',
                avgOrderUpTo: 'TB ƒê·∫∑t h√†ng ƒë·∫øn (S)',
                recommendedInitialStock: 'T·ªìn kho ban ƒë·∫ßu ƒë·ªÅ xu·∫•t',
                foundInIterations: 'T√¨m th·∫•y sau {0} l·∫ßn l·∫∑p',

                // Main View
                liveInventorySimulation: 'M√¥ ph·ªèng t·ªìn kho tr·ª±c ti·∫øp',
                statisticalLiveTable: 'B·∫£ng th·ªëng k√™ tr·ª±c ti·∫øp',
                backToChart: 'Quay l·∫°i bi·ªÉu ƒë·ªì',
                periods: 'k·ª≥',

                // View Modes
                interface: 'Giao di·ªán',
                summary: 'T.quan',
                individual: 'C.ti·∫øt',
                readyToSimulate: 'S·∫µn s√†ng m√¥ ph·ªèng',
                loadDataPrompt: 'T·∫£i d·ªØ li·ªáu v√† nh·∫•n M√¥ ph·ªèng',
                optimizing: 'ƒêANG T·ªêI ∆ØU...',
                simulating: 'ƒêANG M√î PH·ªéNG...',

                // Metrics
                alphaFull: 'Œ± (To√†n b·ªô)',
                betaFull: 'Œ≤ (To√†n b·ªô)',
                alphaSteady: 'Œ± (·ªîn ƒë·ªãnh)',
                betaSteady: 'Œ≤ (·ªîn ƒë·ªãnh)',
                avgInv: 'T·ªìn kho trung b√¨nh',
                avgServiceLevel: 'M·ª®C PH·ª§C V·ª§ TB (Œ±)',
                avgFillRate: 'T·ª∂ L·ªÜ ƒê√ÅP ·ª®NG TB (Œ≤)',
                avgStockoutDays: 'Ng√†y h·∫øt h√†ng TB',
                skusBelow90: 'SKU D∆Ø·ªöI 90% (Œ±)',
                skuId: 'M√É SKU',
                alphaCol: 'ALPHA (Œ±)',
                betaCol: 'BETA (Œ≤)',
                safetyFactorCol: 'H·ªÜ S·ªê AN TO√ÄN',
                avgInvCol: 'T·ªíN KHO TB',
                stockoutsCol: 'H·∫æT H√ÄNG',
                actionCol: 'THAO T√ÅC',
                view: 'Xem',
                optimizedSteadyState: '‚úì ƒê√£ t·ªïi ∆∞u (Œ±/Œ≤ ·ªïn ƒë·ªãnh)',
                skusOptimized: 'ƒë√£ t·ªëi ∆∞u',
                skusSimulated: 'ƒë√£ m√¥ ph·ªèng',
                statusSimulating: 'ƒêang m√¥ ph·ªèng...',
                statusReadyToPlay: 'S·∫µn s√†ng',
                statusAwaitingSetup: 'Ch·ªù thi·∫øt l·∫≠p',

                // Real-time Panel
                onHand: 'T·ªìn kho th·ª±c',
                demand: 'Nhu c·∫ßu',
                arrived: 'ƒê√£ ƒë·∫øn',
                inTransit: 'ƒêang v·∫≠n chuy·ªÉn',
                invPosition: 'T·ªìn kho t·ªïng',
                backlog: 'T·ªìn ƒë·ªçng',
                stockout: 'H·∫æT H√ÄNG!',
                unfulfilled: 'Ch∆∞a ho√†n th√†nh',
                orders: 'ƒë∆°n h√†ng',

                // Playback
                reload: 'T·∫£i l·∫°i v·ªõi nhu c·∫ßu ng·∫´u nhi√™n m·ªõi',
                resetToDay1: 'ƒê·∫∑t l·∫°i v·ªÅ Ng√†y 1',
                stepForward: 'B∆∞·ªõc ti·∫øp',
                day: 'Ng√†y',
                speed: 'T·ªêC ƒê·ªò',

                //Table View
                parameterDate: 'Tham s·ªë/Ng√†y',
                reorderPoint: 's_t (ƒêi·ªÉm ƒë·∫∑t h√†ng)',
                orderUpTo: 'S_t (ƒê·∫∑t h√†ng ƒë·∫øn)',
                orderPlaced: 'ƒê√£ ƒë·∫∑t h√†ng?',
                arrivedOrders: 'ƒê∆°n h√†ng ƒë√£ ƒë·∫øn',
                stockoutQuestion: 'H·∫øt h√†ng?',
                reviewDayQuestion: 'Ng√†y ki·ªÉm kho?',
                viewChart: 'Xem bi·ªÉu ƒë·ªì',
                viewTable: 'Xem b·∫£ng th·ªëng k√™',

                // Chart/Tooltips
                now: 'HI·ªÜN T·∫†I',
                targetSt: 'M·ª•c ti√™u S(t)',
                reorderSt: 'ƒê·∫∑t h√†ng s(t)',
                orderArrival: 'ƒê∆°n h√†ng ƒë·∫øn',

                // Loading
                runningMonteCarlo: 'ƒêang ch·∫°y Monte Carlo...',
                searchingOptimal: 'ƒêang t√¨m ch√≠nh s√°ch t·ªëi ∆∞u...',

                // Warnings
                warmupStockoutWarning: '{0} ng√†y h·∫øt h√†ng trong giai ƒëo·∫°n kh·ªüi ƒë·ªông ({1} ng√†y ƒë·∫ßu)',

                // Summary Dashboard
                skuPerformanceSummary: 'T·ªïng h·ª£p hi·ªáu su·∫•t SKU',
                sku: 'SKU',
                alpha: 'Œ±',
                beta: 'Œ≤',
                stockouts: 'Thi·∫øu h√†ng',
                status: 'Tr·∫°ng th√°i',
                excellent: 'Xu·∫•t s·∫Øc',
                good: 'T·ªët',
                needsAttention: 'C·∫ßn ch√∫ √Ω',

                // Statistical Table params
                reorderPoint: 'ƒêi·ªÉm ƒë·∫∑t h√†ng s(t)',
                orderUpTo: 'ƒê·∫∑t h√†ng ƒë·∫øn S(t)',
                actualDemand: 'Nhu c·∫ßu th·ª±c t·∫ø',
                invBeforeDemand: 'T·ªìn tr∆∞·ªõc nhu c·∫ßu',
                invAfterDemand: 'T·ªìn sau nhu c·∫ßu',
                shortage: 'Thi·∫øu h·ª•t',
                orderQty: 'SL ƒê·∫∑t h√†ng',
                arrivedQty: 'SL ƒê√£ ƒë·∫øn',
                pipelineOrders: 'ƒê∆°n ƒëang ch·ªù',
                inventoryPosition: 'T·ªìn kho t·ªïng',

                // Upload states
                noDataLoaded: 'Ch∆∞a c√≥ d·ªØ li·ªáu',
                clickToUpload: 'Nh·∫•n ƒë·ªÉ t·∫£i l√™n d·ªØ li·ªáu d·ª± b√°o',

                // Mapping Modal
                detected: 'ƒê√£ ph√°t hi·ªán',
                mapColumns: '√Ånh x·∫° c·ªôt',
                auto: 'T·ª∞ ƒê·ªòNG',
                p50P90Detected: 'ƒê√£ ph√°t hi·ªán c·ªôt P50 & P90',
                formatP50P90: 'ƒê·ªãnh d·∫°ng: P50_DD.MM.YYYY, P90_DD.MM.YYYY (d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß)',
                p50Columns: 'C·ªôt P50',
                p90Columns: 'C·ªôt P90',
                days: 'ng√†y',
                skuIdColumn: 'C·ªôt m√£ SKU',
                select: '-- Ch·ªçn --',
                notMapped: '-- Ch∆∞a ch·ªçn --',
                optionalParameters: 'Tham s·ªë t√πy ch·ªçn',
                selectColumnToMap: 'Ch·ªçn c·ªôt ƒë·ªÉ √°nh x·∫°',
                detectedParameters: 'Tham s·ªë ƒë√£ ph√°t hi·ªán',
                lockedOnSidebar: '‚úì = Kh√≥a tr√™n thanh b√™n',
                uncheckToEdit: 'B·ªè ch·ªçn ƒë·ªÉ ch·ªânh s·ª≠a th·ªß c√¥ng tr√™n thanh b√™n',
                locked: 'ƒê√£ kh√≥a',
                editable: 'C√≥ th·ªÉ s·ª≠a',
                cancel: 'H·ªßy',
                confirm: 'X√°c nh·∫≠n',
                confirmLoadParams: 'X√°c nh·∫≠n & T·∫£i tham s·ªë',

                // Export Report
                exportReport: 'Xu·∫•t b√°o c√°o',
                exporting: 'ƒêang xu·∫•t...',
                exportSuccess: 'Xu·∫•t b√°o c√°o th√†nh c√¥ng',
                exportError: 'Xu·∫•t b√°o c√°o th·∫•t b·∫°i',

                // File Upload Errors
                invalidFileFormat: 'ƒê·ªãnh d·∫°ng t·ªáp kh√¥ng h·ª£p l·ªá',
                noHeadersFound: 'Kh√¥ng t√¨m th·∫•y ti√™u ƒë·ªÅ trong t·ªáp. Vui l√≤ng ki·ªÉm tra xem b·∫°n ƒë√£ t·∫£i l√™n t·ªáp Excel ho·∫∑c CSV h·ª£p l·ªá c√≥ d·ªØ li·ªáu.',
                noValidDataFound: 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra xem t·ªáp c√≥ ch·ª©a c√°c c·ªôt b·∫Øt bu·ªôc.',
                fileReadError: 'L·ªói ƒë·ªçc t·ªáp',
                fileParseError: 'L·ªói ph√¢n t√≠ch t·ªáp',

                // Operartis Mapping Modal
                operartisForecastDetected: 'ƒê√£ ph√°t hi·ªán B√°o c√°o D·ª± b√°o Operartis',
                //residualBasedModel: 'M√¥ h√¨nh ƒë·ªô b·∫•t ƒë·ªãnh d·ª±a tr√™n ph·∫ßn d∆∞ (œÉ‚Çï = Resid_Std √ó ‚àöh)',
                skuColumn: 'C·ªôt SKU',
                residStdLabel: 'Resid_Std',
                dateColumnsLabel: 'C·ªôt ng√†y',
                residStdColumn: 'C·ªôt Resid_Std',
                forecastHorizonDays: 'Kho·∫£ng d·ª± b√°o (ng√†y)',
                lastDaysAsForecast: '{0} c·ªôt ng√†y cu·ªëi s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng l√†m d·ª± b√°o',
                forecastHorizonTip: 'M·∫πo: Kho·∫£ng d·ª± b√°o ƒë∆∞·ª£c t·ª± ƒë·ªông ph√°t hi·ªán t·ª´ t·ªáp n·∫øu c√≥',
                serviceLevel: 'M·ª©c d·ªãch v·ª•'
            }
        };

        // --- API CONFIGURATION ---
        const API_ENDPOINTS = {
            LOCAL: 'http://localhost:8000',
            PROD: 'https://95.216.170.251.sslip.io'
        };

        // --- API CALL: Timeline Simulation (Single Run for Animation) ---
        const callTimelineSimulation = async (skuId, forecastData, params, apiUrl) => {
            // Build lead_time_config for API
            const ltConfig = params.leadTimeConfig || { type: 'deterministic', deterministicValue: 14 };
            const apiLeadTimeConfig = {
                type: ltConfig.type,
                deterministic_value: ltConfig.deterministicValue || 14,
                values: ltConfig.type === 'value' ? ltConfig.values?.map(v => ({ value: v.value, probability: v.probability })) : null,
                poisson_lambda: ltConfig.poissonLambda,
                binomial_n: ltConfig.binomialN,
                binomial_p: ltConfig.binomialP,
                uniform_min: ltConfig.uniformMin,
                uniform_max: ltConfig.uniformMax
            };

            const requestBody = {
                sku_id: skuId,
                initial_stock: params.initialStock,
                lead_time_config: apiLeadTimeConfig,
                // Legacy fields for backward compatibility
                lead_time_days: ltConfig.deterministicValue || 14,
                lead_time_std: 0,
                review_period: params.reviewPeriod,
                target_service_level: params.serviceLevel,
                safety_factor: params.safetyFactor || 1.0,
                forecast_data: forecastData.map(d => ({
                    date: d.date,
                    p50: d.p50,
                    p90: d.p90,
                    // Include residual-based uncertainty fields if available
                    resid_std: d.resid_std ?? null,
                    horizon_index: d.horizon_index ?? null
                }))
            };

            // Add MOQ if set (0 = no minimum)
            if (params.moqValue > 0) {
                requestBody.min_order_qty = params.moqValue;
            }

            const response = await fetch(`${apiUrl}/inventory/simulate-timeline`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Simulation failed');
            }

            const result = await response.json();

            // Transform backend response to match frontend expected format
            return {
                timeline: result.timeline.map(t => ({
                    day: t.day,
                    date: t.date,
                    p50: t.p50,
                    p90: t.p90,
                    s_t: t.s_t,
                    S_t: t.S_t,
                    invBeforeArrival: t.inv_before_arrival,
                    arrivedQty: t.arrived_qty,
                    invAfterArrival: t.inv_after_arrival,
                    actualDemand: t.actual_demand,
                    fulfilled: t.fulfilled,
                    invBeforeDemand: t.inv_before_demand,
                    invAfterDemand: t.inv_after_demand,
                    shortage: t.shortage,
                    backlog: t.backlog,
                    stockoutEvent: t.stockout_event,
                    orderPlaced: t.order_placed,
                    pipelineOrders: t.pipeline_orders,
                    inventoryPosition: t.inventory_position,
                    inTransit: t.in_transit,
                    undershoot: t.undershoot,
                    isReviewDay: t.is_review_day
                })),
                metrics: {
                    alpha: result.metrics.alpha,
                    beta: result.metrics.beta,
                    avgInventory: result.metrics.avg_inventory,
                    totalStockouts: result.metrics.total_stockouts,
                    totalDays: result.metrics.total_days,
                    // Steady-state metrics
                    alpha_steady: result.metrics.alpha_steady,
                    beta_steady: result.metrics.beta_steady,
                    warmup_days: result.metrics.warmup_days,
                    warmup_stockout_days: result.metrics.warmup_stockout_days,
                    steady_state_days: result.metrics.steady_state_days
                }
            };
        };

        // --- API CALL: Monte Carlo Simulation (500 runs for robust stats) ---
        const callMonteCarloSimulation = async (skuId, forecastData, params, numRuns = 500, apiUrl) => {
            // Build lead_time_config for API
            const ltConfig = params.leadTimeConfig || { type: 'deterministic', deterministicValue: 14 };
            const apiLeadTimeConfig = {
                type: ltConfig.type,
                deterministic_value: ltConfig.deterministicValue || 14,
                values: ltConfig.type === 'value' ? ltConfig.values?.map(v => ({ value: v.value, probability: v.probability })) : null,
                poisson_lambda: ltConfig.poissonLambda,
                binomial_n: ltConfig.binomialN,
                binomial_p: ltConfig.binomialP,
                uniform_min: ltConfig.uniformMin,
                uniform_max: ltConfig.uniformMax
            };

            const requestBody = {
                sku_id: skuId,
                initial_stock: params.initialStock,
                lead_time_config: apiLeadTimeConfig,
                lead_time_days: ltConfig.deterministicValue || 14,
                lead_time_std: 0,
                review_period: params.reviewPeriod,
                target_service_level: params.serviceLevel,
                safety_factor: params.safetyFactor || 1.0,
                forecast_data: forecastData.map(d => ({
                    date: d.date,
                    p50: d.p50,
                    p90: d.p90,
                    // Include residual-based uncertainty fields if available
                    resid_std: d.resid_std ?? null,
                    horizon_index: d.horizon_index ?? null
                }))
            };

            // Add MOQ if set (0 = no minimum)
            if (params.moqValue > 0) {
                requestBody.min_order_qty = params.moqValue;
            }

            const response = await fetch(`${apiUrl}/inventory/simulate-monte-carlo?num_runs=${numRuns}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Monte Carlo simulation failed');
            }

            const result = await response.json();

            // Return in format expected by frontend
            return {
                numRuns: result.num_runs,
                alpha: result.alpha,
                beta: result.beta,
                avgInventory: result.avg_inventory,
                stockoutDays: result.stockout_days
            };
        };

        // --- API CALL: Policy Optimization (Find optimal safety factor for target Œ±) ---
        const callPolicyOptimization = async (skuId, forecastData, params, apiUrl) => {
            // Build lead_time_config for API
            const ltConfig = params.leadTimeConfig || { type: 'deterministic', deterministicValue: 14 };
            const apiLeadTimeConfig = {
                type: ltConfig.type,
                deterministic_value: ltConfig.deterministicValue || 14,
                values: ltConfig.type === 'value' ? ltConfig.values?.map(v => ({ value: v.value, probability: v.probability })) : null,
                poisson_lambda: ltConfig.poissonLambda,
                binomial_n: ltConfig.binomialN,
                binomial_p: ltConfig.binomialP,
                uniform_min: ltConfig.uniformMin,
                uniform_max: ltConfig.uniformMax
            };

            const requestBody = {
                sku_id: skuId,
                initial_stock: params.initialStock,  // Use the actual initial stock from input
                lead_time_config: apiLeadTimeConfig,
                lead_time_days: ltConfig.deterministicValue || 14,
                lead_time_std: 0,
                review_period: params.reviewPeriod,
                target_service_level: params.serviceLevel,
                forecast_data: forecastData.map(d => ({
                    date: d.date,
                    p50: d.p50,
                    p90: d.p90,
                    // Include residual-based uncertainty fields if available
                    resid_std: d.resid_std ?? null,
                    horizon_index: d.horizon_index ?? null
                })),
                tolerance: 0.01,
                max_iterations: 15,
                num_simulation_runs: 500
            };

            // Add MOQ if set (0 = no minimum)
            if (params.moqValue > 0) {
                requestBody.min_order_qty = params.moqValue;
            }

            const response = await fetch(`${apiUrl}/inventory/optimize-policy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Policy optimization failed');
            }

            const result = await response.json();

            // Return mapped result
            return {
                skuId: result.sku_id,
                targetAlpha: result.target_alpha,
                achievedAlpha: result.achieved_alpha,
                achievedBeta: result.achieved_beta,
                optimalSafetyFactor: result.optimal_safety_factor,
                avgSt: result.avg_s_t,
                avgST: result.avg_S_t,
                recommendedInitialStock: result.recommended_initial_stock,
                iterationsUsed: result.iterations_used,
                convergenceAchieved: result.convergence_achieved,
                // MC statistics from optimization (no separate MC call needed)
                mcAvgInventory: result.mc_avg_inventory,
                mcAvgStockoutDays: result.mc_avg_stockout_days,
                timeline: result.timeline?.map(t => ({
                    day: t.day,
                    date: t.date,
                    p50: t.p50,
                    p90: t.p90,
                    s_t: t.s_t,  // Use underscore version for consistency with chart
                    S_t: t.S_t,
                    actualDemand: t.actual_demand,
                    invBeforeDemand: t.inv_before_demand,
                    invAfterDemand: t.inv_after_demand,
                    shortage: t.shortage,
                    orderPlaced: t.order_placed,
                    orderQty: t.order_qty,
                    arrived: t.arrived,
                    arrivedQty: t.arrived_qty,
                    backlog: t.backlog,
                    stockoutEvent: t.stockout_event,
                    pipelineOrders: t.pipeline_orders,
                    inventoryPosition: t.inventory_position,
                    inTransit: t.in_transit,
                    undershoot: t.undershoot,
                    isReviewDay: t.is_review_day
                })),
                metrics: result.metrics ? {
                    alpha: result.metrics.alpha,
                    beta: result.metrics.beta,
                    avgInventory: result.metrics.avg_inventory,
                    totalStockouts: result.metrics.total_stockouts,
                    alpha_steady: result.metrics.alpha_steady,
                    beta_steady: result.metrics.beta_steady,
                    warmup_days: result.metrics.warmup_days,
                    warmup_stockout_days: result.metrics.warmup_stockout_days
                } : null
            };
        };

        // Old simulation engines removed - now using backend API
        // Note: All simulation logic is now in inventory_engine.py

        // Note: All simulation logic is now in inventory_engine.py (backend)
        // Frontend calls callTimelineSimulation() and callMonteCarloSimulation() APIs

        // --- LIVE SIMULATION CHART (Industry-Standard Step Chart) ---
        const LiveSimulationChart = ({ timeline, currentDay, isDark, reviewPeriod, t }) => {
            // Track active (clicked) series - use Set for multiple selection
            const [activeSeries, setActiveSeries] = React.useState(new Set());

            // Toggle series visibility on click
            const toggleSeries = (seriesKey) => {
                if (!seriesKey || seriesKey === 'stockout') return;
                setActiveSeries(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(seriesKey)) {
                        newSet.delete(seriesKey);
                    } else {
                        newSet.add(seriesKey);
                    }
                    return newSet;
                });
            };

            const visibleData = timeline.slice(0, currentDay + 1).map(d => ({
                date: d.date,
                inventory: d.invAfterDemand,
                inventoryPosition: d.inventoryPosition,
                inTransit: d.inTransit,
                backlog: d.backlog,
                backlogNeg: d.backlog > 0 ? -d.backlog : null, // Negative for display below zero
                s_t: d.s_t,
                S_t: d.S_t,
                demand: d.actualDemand,
                arrival: d.arrivedQty > 0 ? d.arrivedQty : null,
                stockout: d.stockoutEvent ? d.invAfterDemand : null,
                isReviewDay: d.isReviewDay
            }));

            // Add future policy lines (grayed out)
            const futureData = timeline.slice(currentDay + 1).map(d => ({
                date: d.date,
                s_t_future: d.s_t,
                S_t_future: d.S_t
            }));

            const allData = [...visibleData, ...futureData];

            // Color definitions for each series
            const seriesColors = {
                demand: isDark ? '#64748b' : '#94a3b8',
                arrival: '#22c55e',
                S_t: '#ef4444',
                s_t: '#f97316',
                inventoryPosition: '#14b8a6',
                inventory: '#3b82f6',
                backlogNeg: '#dc2626'
            };

            // Faded color (grey) for hidden series
            const fadedColor = isDark ? '#475569' : '#94a3b8';

            // Check if any series is active (clicked)
            const hasActiveSelection = activeSeries.size > 0;

            // Get color based on active selection state
            const getSeriesColor = (seriesKey) => {
                if (!hasActiveSelection) return seriesColors[seriesKey];
                return activeSeries.has(seriesKey) ? seriesColors[seriesKey] : fadedColor;
            };

            // Get opacity based on active selection state
            const getSeriesOpacity = (seriesKey) => {
                if (!hasActiveSelection) return 1;
                return activeSeries.has(seriesKey) ? 1 : 0.15;
            };

            // Check if series should be visible (for hiding completely)
            const isSeriesVisible = (seriesKey) => {
                if (!hasActiveSelection) return true;
                return activeSeries.has(seriesKey);
            };

            return (
                <ResponsiveContainer width="100%" height="100%">
                    <ComposedChart data={allData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                        <defs>
                            {/* On-Hand Inventory gradient (gold/amber) */}
                            <linearGradient id="invGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3} />
                                <stop offset="95%" stopColor="#3b82f6" stopOpacity={0.02} />
                            </linearGradient>
                            {/* Order-Up-To Level gradient (green) */}
                            <linearGradient id="stGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#10b981" stopOpacity={0.12} />
                                <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
                            </linearGradient>
                            {/* Inventory Position gradient (teal) */}
                            <linearGradient id="ipGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#14b8a6" stopOpacity={0.15} />
                                <stop offset="95%" stopColor="#14b8a6" stopOpacity={0} />
                            </linearGradient>
                            {/* Target S(t) gradient (red) */}
                            <linearGradient id="targetStGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#ef4444" stopOpacity={0.12} />
                                <stop offset="95%" stopColor="#ef4444" stopOpacity={0} />
                            </linearGradient>
                            {/* Reorder s(t) gradient (orange) */}
                            <linearGradient id="reorderStGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#f97316" stopOpacity={0.12} />
                                <stop offset="95%" stopColor="#f97316" stopOpacity={0} />
                            </linearGradient>
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" vertical={true} stroke={isDark ? '#334155' : '#e2e8f0'} opacity={0.5} />
                        <XAxis dataKey="date" tick={{ fontSize: 9, fill: isDark ? '#94a3b8' : '#64748b' }} minTickGap={50} axisLine={false} tickLine={false} />
                        <YAxis tick={{ fontSize: 10, fill: isDark ? '#94a3b8' : '#64748b' }} axisLine={false} tickLine={false} />

                        {/* Zero reference line (like AnyLogic yellow line) */}
                        <ReferenceLine y={0} stroke="#eab308" strokeWidth={2} strokeOpacity={0.8} />

                        <Tooltip
                            content={({ active, payload, label }) => {
                                if (!active || !payload || !payload.length) return null;
                                const data = payload[0]?.payload;
                                return (
                                    <div style={{
                                        backgroundColor: isDark ? '#0f172a' : '#fff',
                                        border: `1px solid ${isDark ? '#1e293b' : '#e2e8f0'}`,
                                        borderRadius: '12px',
                                        padding: '12px 16px',
                                        boxShadow: '0 10px 25px -5px rgba(0, 0, 0, 0.2)',
                                        minWidth: '180px'
                                    }}>
                                        <div style={{ color: isDark ? '#cbd5e1' : '#334155', fontSize: '10px', fontWeight: 'bold', marginBottom: '8px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, paddingBottom: '6px' }}>
                                            {label} {data?.isReviewDay && <span style={{ color: '#f59e0b', marginLeft: '8px' }}>üìã {t ? t('reviewDay') : 'Review Day'}</span>}
                                        </div>
                                        {payload.filter(p => p.value !== null && p.value !== undefined).map((entry, idx) => (
                                            <div key={idx} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '11px', fontFamily: 'monospace', marginBottom: '3px' }}>
                                                <span style={{ color: entry.color, fontWeight: '600' }}>{entry.name}</span>
                                                <span style={{ color: isDark ? '#e2e8f0' : '#1e293b', fontWeight: 'bold' }}>{typeof entry.value === 'number' ? Math.round(entry.value).toLocaleString() : entry.value}</span>
                                            </div>
                                        ))}
                                    </div>
                                );
                            }}
                        />

                        <Legend
                            verticalAlign="top"
                            height={36}
                            wrapperStyle={{ paddingBottom: '10px', cursor: 'pointer' }}
                            onClick={(e) => {
                                const dataKey = e.dataKey;
                                toggleSeries(dataKey);
                            }}
                            formatter={(value, entry) => {
                                const isActive = activeSeries.has(entry.dataKey);
                                const isFaded = hasActiveSelection && !isActive;
                                return (
                                    <span style={{
                                        color: isFaded ? (isDark ? '#64748b' : '#94a3b8') : (isDark ? '#cbd5e1' : '#64748b'),
                                        fontSize: '10px',
                                        fontWeight: isActive ? '900' : 'bold',
                                        opacity: isFaded ? 0.4 : 1,
                                        transition: 'all 0.2s ease',
                                        textDecoration: isActive ? 'underline' : 'none',
                                        textUnderlineOffset: '3px'
                                    }}>{value}</span>
                                );
                            }}
                        />

                        {/* Future policy lines (faded) */}
                        <Line type="stepAfter" dataKey="S_t_future" stroke={activeSeries.has('S_t') ? '#10b981' : (!hasActiveSelection ? '#10b981' : fadedColor)} strokeWidth={1} strokeDasharray="5 5" strokeOpacity={activeSeries.has('S_t') ? 0.5 : (!hasActiveSelection ? 0.3 : 0.1)} dot={false} name="S(t) Future" legendType="none" />
                        <Line type="stepAfter" dataKey="s_t_future" stroke={activeSeries.has('s_t') ? '#ef4444' : (!hasActiveSelection ? '#ef4444' : fadedColor)} strokeWidth={1} strokeDasharray="5 5" strokeOpacity={activeSeries.has('s_t') ? 0.5 : (!hasActiveSelection ? 0.3 : 0.1)} dot={false} name="s(t) Future" legendType="none" />

                        {/* Demand bars */}
                        <Bar dataKey="demand" fill={getSeriesColor('demand')} opacity={!hasActiveSelection ? 0.5 : (activeSeries.has('demand') ? 0.8 : 0.1)} barSize={4} name={t ? t('demand') : 'Demand'} />

                        {/* Arrivals (green bars going up) */}
                        <Bar dataKey="arrival" fill={getSeriesColor('arrival')} opacity={!hasActiveSelection ? 0.8 : (activeSeries.has('arrival') ? 0.9 : 0.1)} barSize={6} name={t ? t('orderArrival') : 'Order Arrival'} />

                        {/* Order-Up-To Level (S_t) - Target Inventory Line (dashed) */}
                        <Area type="stepAfter" dataKey="S_t" stroke={getSeriesColor('S_t')} fill={!hasActiveSelection || activeSeries.has('S_t') ? 'url(#targetStGradient)' : 'transparent'} strokeWidth={activeSeries.has('S_t') ? 3 : 2} strokeDasharray="5 3" strokeOpacity={getSeriesOpacity('S_t')} dot={false} name={t ? t('targetSt') : 'Target S(t)'} />

                        {/* Reorder Point (s_t) - Threshold line */}
                        <Area type="stepAfter" dataKey="s_t" stroke={getSeriesColor('s_t')} fill={!hasActiveSelection || activeSeries.has('s_t') ? 'url(#reorderStGradient)' : 'transparent'} strokeWidth={activeSeries.has('s_t') ? 3 : 2} strokeDasharray="8 4" strokeOpacity={getSeriesOpacity('s_t')} dot={false} name={t ? t('reorderSt') : 'Reorder s(t)'} />

                        {/* Inventory Position (stepAfter dashed line - Teal/Green in AnyLogic) */}
                        <Area type="stepAfter" dataKey="inventoryPosition" stroke={getSeriesColor('inventoryPosition')} fill={!hasActiveSelection || activeSeries.has('inventoryPosition') ? 'url(#ipGradient)' : 'transparent'} strokeWidth={activeSeries.has('inventoryPosition') ? 3.5 : 2.5} strokeDasharray="8 4" strokeOpacity={getSeriesOpacity('inventoryPosition')} dot={false} name={t ? t('invPosition') : 'Inv. Position'} />

                        {/* On-Hand Inventory (stepAfter for discrete sawtooth - Blue in AnyLogic) */}
                        <Area type="stepAfter" dataKey="inventory" stroke={getSeriesColor('inventory')} fill={!hasActiveSelection || activeSeries.has('inventory') ? 'url(#invGradient)' : 'transparent'} strokeWidth={activeSeries.has('inventory') ? 4 : 3} strokeOpacity={getSeriesOpacity('inventory')} name={t ? t('onHand') : 'On Hand'} animationDuration={100} />

                        {/* Backlog (negative area - shown below zero line) */}
                        <Area type="stepAfter" dataKey="backlogNeg" stroke={getSeriesColor('backlogNeg')} fill={getSeriesColor('backlogNeg')} fillOpacity={!hasActiveSelection ? 0.3 : (activeSeries.has('backlogNeg') ? 0.5 : 0.1)} strokeWidth={activeSeries.has('backlogNeg') ? 3 : 2} strokeOpacity={getSeriesOpacity('backlogNeg')} name={t ? t('backlog') : 'Backlog'} />

                        {/* Stockout markers */}
                        <Line type="stepAfter" dataKey="stockout" stroke="#ef4444" strokeWidth={0} dot={{ r: 8, fill: '#ef4444', stroke: '#fff', strokeWidth: 2 }} name={t ? t('stockout') : 'Stockout!'} legendType="none" />

                        {/* Current day reference line */}
                        {visibleData.length > 0 && (
                            <ReferenceLine x={visibleData[visibleData.length - 1]?.date} stroke="#f59e0b" strokeWidth={2} strokeDasharray="3 3" label={{ value: t ? t('now') : 'NOW', position: 'top', fontSize: 9, fill: '#f59e0b', fontWeight: 'bold' }} />
                        )}
                    </ComposedChart>
                </ResponsiveContainer>
            );
        };

        // --- REAL-TIME STATUS PANEL ---
        const RealTimePanel = ({ currentDayData, params, isPlaying, t }) => {
            if (!currentDayData) return null;

            const { invAfterDemand, s_t, actualDemand, arrivedQty, orderPlaced, pipelineOrders, stockoutEvent, inventoryPosition, backlog, inTransit } = currentDayData;

            const inventoryStatus = invAfterDemand <= 0 ? 'critical' : invAfterDemand <= s_t ? 'warning' : 'normal';
            const statusColors = {
                critical: 'bg-red-500 text-white',
                warning: 'bg-amber-500 text-white',
                normal: 'bg-emerald-500 text-white'
            };

            return (
                <div className={`grid grid-cols-3 md:grid-cols-6 gap-2 p-2 bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl rounded-xl border ${stockoutEvent ? 'border-red-500 animate-pulse' : 'border-white/50 dark:border-white/10'} shadow-lg ring-1 ring-white/50 dark:ring-white/5`}>
                    {/* Inventory On Hand */}
                    <div className={`p-2 rounded-lg backdrop-blur-md border shadow ${statusColors[inventoryStatus]} transition-all duration-300`}>
                        <div className="flex items-center gap-1.5 mb-0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                            <span className="text-[9px] font-bold uppercase opacity-80">{t ? t('onHand') : 'On Hand'}</span>
                        </div>
                        <div className="text-lg font-black">{Math.round(invAfterDemand).toLocaleString()}</div>
                        {stockoutEvent && <div className="text-[9px] font-bold mt-0.5 flex items-center gap-1"><AlertTriangleIcon size={10} /> {t ? t('stockout') : 'STOCKOUT!'}</div>}
                    </div>

                    {/* Today's Demand */}
                    <div className="p-2 rounded-lg backdrop-blur-md bg-slate-100/80 dark:bg-slate-800/50 border border-slate-200 dark:border-white/10 shadow">
                        <div className="flex items-center gap-1.5 mb-0.5 text-slate-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18" /><path d="m19 9-5 5-4-4-3 3" /></svg>
                            <span className="text-[9px] font-bold uppercase">{t ? t('demand') : 'Demand'}</span>
                        </div>
                        <div className="text-lg font-black text-slate-700 dark:text-slate-200">-{Math.round(actualDemand)}</div>
                    </div>

                    {/* Arrivals */}
                    <div className={`p-2 rounded-lg backdrop-blur-md border shadow ${arrivedQty > 0 ? 'bg-emerald-100/80 dark:bg-emerald-900/30 border-emerald-200 dark:border-emerald-500/20 order-arrive' : 'bg-slate-100/80 dark:bg-slate-800/50 border-slate-200 dark:border-white/10'}`}>
                        <div className="flex items-center gap-1.5 mb-0.5 text-emerald-600 dark:text-emerald-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                            <span className="text-[9px] font-bold uppercase">{t ? t('arrived') : 'Arrived'}</span>
                        </div>
                        <div className={`text-lg font-black ${arrivedQty > 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-400'}`}>
                            {arrivedQty > 0 ? `+${Math.round(arrivedQty)}` : '‚Äî'}
                        </div>
                    </div>

                    {/* In Transit */}
                    <div className="p-2 rounded-lg backdrop-blur-md bg-blue-50/80 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-500/20 shadow">
                        <div className="flex items-center gap-1.5 mb-0.5 text-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>
                            <span className="text-[9px] font-bold uppercase">{t ? t('inTransit') : 'In Transit'}</span>
                        </div>
                        <div className="text-lg font-black text-blue-600 dark:text-blue-400">
                            {inTransit > 0 ? Math.round(inTransit).toLocaleString() : '‚Äî'}
                        </div>
                        {pipelineOrders.length > 0 && (
                            <div className="text-[8px] text-blue-500 mt-0.5">{pipelineOrders.length} {t ? t('orders') : 'order(s)'}</div>
                        )}
                    </div>

                    {/* Inventory Position */}
                    <div className="p-2 rounded-lg backdrop-blur-md bg-indigo-50/80 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-500/20 shadow">
                        <div className="flex items-center gap-1.5 mb-0.5 text-indigo-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2" /></svg>
                            <span className="text-[9px] font-bold uppercase">{t ? t('invPosition') : 'Inv. Position'}</span>
                        </div>
                        <div className={`text-lg font-black ${inventoryPosition < s_t ? 'text-amber-500' : 'text-indigo-600 dark:text-indigo-400'}`}>
                            {Math.round(inventoryPosition).toLocaleString()}
                        </div>
                        <div className="text-[8px] text-indigo-500 mt-0.5">IP = OH + IT - BL</div>
                    </div>

                    {/* Backlog */}
                    <div className={`p-2 rounded-lg backdrop-blur-md border shadow ${backlog > 0 ? 'bg-red-100/80 dark:bg-red-900/30 border-red-200 dark:border-red-500/20' : 'bg-slate-100/80 dark:bg-slate-800/50 border-slate-200 dark:border-white/10'}`}>
                        <div className={`flex items-center gap-1.5 mb-0.5 ${backlog > 0 ? 'text-red-500' : 'text-slate-500'}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></svg>
                            <span className="text-[9px] font-bold uppercase">{t ? t('backlog') : 'Backlog'}</span>
                        </div>
                        <div className={`text-lg font-black ${backlog > 0 ? 'text-red-500' : 'text-slate-400'}`}>
                            {backlog > 0 ? Math.round(backlog).toLocaleString() : '‚Äî'}
                        </div>
                        {backlog > 0 && <div className="text-[8px] text-red-500 mt-0.5">{t ? t('unfulfilled') : 'Unfulfilled'}</div>}
                    </div>
                </div>
            );
        };

        // --- PLAYBACK CONTROLS ---
        const PlaybackControls = ({ isPlaying, setIsPlaying, speed, setSpeed, currentDay, setCurrentDay, maxDays, onReset, onReload, isReloading, t }) => {
            return (
                <div className="flex items-center gap-2 p-1.5 bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl rounded-xl border border-white/50 dark:border-white/10 shadow-lg ring-1 ring-white/50 dark:ring-white/5">
                    {/* Reload - Quick single simulation */}
                    <button
                        onClick={onReload}
                        disabled={isReloading}
                        className={`p-1 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors ${isReloading ? 'animate-spin text-green-500' : 'text-green-600 dark:text-green-400'}`}
                        title="Reload with new random demand (quick single run)"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                            <path d="M21 3v5h-5" />
                        </svg>
                    </button>

                    {/* Reset */}
                    <button onClick={onReset} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-500 transition-colors" title="Reset to Day 1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 19 2 12 11 5 11 19"></polygon><polygon points="22 19 13 12 22 5 22 19"></polygon></svg>
                    </button>

                    {/* Play/Pause */}
                    <button
                        onClick={() => setIsPlaying(!isPlaying)}
                        className={`p-1.5 rounded-lg transition-all ${isPlaying ? 'bg-amber-500 text-white pulse-glow' : 'bg-brand-gold text-white hover:bg-brand-dark'}`}
                    >
                        {isPlaying ?
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg> :
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>}
                    </button>

                    {/* Step Forward */}
                    <button
                        onClick={() => setCurrentDay(prev => Math.min(prev + 1, maxDays - 1))}
                        disabled={currentDay >= maxDays - 1}
                        className="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-500 transition-colors disabled:opacity-30"
                        title="Step Forward"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>
                    </button>

                    {/* Progress Bar */}
                    <div className="flex-1 flex items-center gap-2">
                        <input
                            type="range"
                            min="0"
                            max={maxDays - 1}
                            value={currentDay}
                            onChange={e => setCurrentDay(parseInt(e.target.value))}
                            className="flex-1 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-brand-gold"
                            style={{ backgroundImage: `linear-gradient(to right, #f59e0b 0%, #f59e0b ${(currentDay / (maxDays - 1)) * 100}%, transparent ${(currentDay / (maxDays - 1)) * 100}%, transparent 100%)` }}
                        />
                        <div className="text-[10px] font-mono font-bold text-slate-500 whitespace-nowrap min-w-[70px] text-right">
                            {t ? t('day') : 'Day'} {currentDay + 1} / {maxDays}
                        </div>
                    </div>

                    {/* Speed Control */}
                    <div className="flex items-center gap-2 border-l border-slate-200 dark:border-slate-700 pl-2">
                        <span className="text-[9px] font-bold text-slate-400 uppercase">{t ? t('speed') : 'Speed'}</span>
                        <select
                            value={speed}
                            onChange={e => setSpeed(parseInt(e.target.value))}
                            className="text-[10px] font-bold bg-slate-100 dark:bg-slate-800 border-0 rounded px-1.5 py-0.5 dark:text-white cursor-pointer"
                        >
                            <option value="1000">0.5x</option>
                            <option value="500">1x</option>
                            <option value="200">2x</option>
                            <option value="100">5x</option>
                            <option value="50">10x</option>
                        </select>
                    </div>
                </div>
            );
        };

        // --- STATISTICAL TABLE ---
        const StatisticalTable = ({ simResult, currentDay, onBack, t }) => {
            if (!simResult?.timeline) return null;

            const timeline = simResult.timeline;
            const tableRef = React.useRef(null);

            // Auto-scroll to keep current day column centered in view
            React.useEffect(() => {
                if (tableRef.current && currentDay >= 0) {
                    const container = tableRef.current;
                    const fixedColumnWidth = 160; // sticky first column width
                    const columnWidth = 90; // min-w-[90px] per day column
                    const visibleWidth = container.clientWidth - fixedColumnWidth;

                    // Calculate scroll position to center the current day column
                    const currentColumnStart = currentDay * columnWidth;
                    const centerOffset = (visibleWidth / 2) - (columnWidth / 2);
                    const targetScroll = Math.max(0, currentColumnStart - centerOffset);

                    container.scrollLeft = targetScroll;
                }
            }, [currentDay]);

            // Define parameter rows - keys must match frontend camelCase convention (transformed from backend snake_case)
            const params = [
                { key: 's_t', label: t ? t('reorderPoint') : 's_t (Reorder Point)', format: (d) => d.s_t?.toLocaleString(undefined, { maximumFractionDigits: 0 }) ?? '‚Äî', color: 'text-orange-500' },
                { key: 'S_t', label: t ? t('orderUpTo') : 'S_t (Order-Up-To)', format: (d) => d.S_t?.toLocaleString(undefined, { maximumFractionDigits: 0 }) ?? '‚Äî', color: 'text-red-500' },
                { key: 'actualDemand', label: t ? t('demand') : 'Demand', format: (d) => d.actualDemand?.toLocaleString(undefined, { maximumFractionDigits: 0 }) ?? '‚Äî' },
                { key: 'orderPlaced', label: t ? t('orderPlaced') : 'Order Placed?', format: (d) => d.orderPlaced ? `‚úì ${d.orderPlaced.qty?.toLocaleString()}` : '‚Äî', color: (d) => d.orderPlaced ? 'text-emerald-500 font-bold' : 'text-slate-400', headerColor: 'text-emerald-500' },
                { key: 'arrivedQty', label: t ? t('arrivedOrders') : 'Arrived Orders', format: (d) => d.arrivedQty > 0 ? d.arrivedQty.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '‚Äî', color: (d) => d.arrivedQty > 0 ? 'text-teal-500' : 'text-slate-400', headerColor: 'text-teal-500' },
                { key: 'inventoryPosition', label: t ? t('invPosition') : 'Inv. Position', format: (d) => d.inventoryPosition?.toLocaleString(undefined, { maximumFractionDigits: 0 }) ?? '‚Äî', color: 'text-purple-500' },
                { key: 'invAfterDemand', label: t ? t('onHand') : 'On-Hand', format: (d) => d.invAfterDemand?.toLocaleString(undefined, { maximumFractionDigits: 0 }) ?? '‚Äî', color: 'text-cyan-500' },
                { key: 'inTransit', label: t ? t('inTransit') : 'In Transit', format: (d) => d.inTransit > 0 ? d.inTransit.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '‚Äî', color: (d) => d.inTransit > 0 ? 'text-blue-500' : 'text-slate-400', headerColor: 'text-blue-500' },
                { key: 'backlog', label: t ? t('backlog') : 'Backlog', format: (d) => d.backlog > 0 ? d.backlog.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '‚Äî', color: (d) => d.backlog > 0 ? 'text-red-500 font-bold' : 'text-slate-400', headerColor: 'text-red-500' },
                { key: 'stockoutEvent', label: t ? t('stockoutQuestion') : 'Stockout?', format: (d) => d.stockoutEvent ? '‚ö† Yes' : '‚Äî', color: (d) => d.stockoutEvent ? 'text-red-600 font-bold bg-red-50 dark:bg-red-900/20' : 'text-slate-400', headerColor: 'text-red-600' },
                { key: 'isReviewDay', label: t ? t('reviewDayQuestion') : 'Review Day?', format: (d) => d.isReviewDay ? '‚óè Yes' : '‚Äî', color: (d) => d.isReviewDay ? 'text-brand-gold font-bold' : 'text-slate-400', headerColor: 'text-brand-gold' },
            ];

            return (
                <div className="h-full flex flex-col">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4 pb-3 border-b border-slate-200 dark:border-slate-700 relative">
                        {/* Left: Back to Chart */}
                        <div className="flex items-center gap-3">
                            <button
                                onClick={onBack}
                                className="bg-slate-100/80 dark:bg-slate-800/50 backdrop-blur-md px-3 py-1.5 rounded-xl border border-slate-200 dark:border-white/10 shadow hover:bg-slate-200/80 dark:hover:bg-slate-700/50 transition-colors flex items-center gap-2 text-slate-600 dark:text-slate-300"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6" /></svg>
                                <span className="text-xs font-bold">{t ? t('backToChart') : 'Back to Chart'}</span>
                            </button>
                        </div>
                        {/* Center: Title - Glassmorphism Box */}
                        <div className="absolute left-1/2 -translate-x-1/2 bg-slate-100/80 dark:bg-slate-800/50 backdrop-blur-md px-3 py-1.5 rounded-xl border border-slate-200 dark:border-white/10 shadow flex items-center gap-2">
                            <span className="text-xs font-bold text-brand-gold uppercase tracking-wide">{t ? t('statisticalLiveTable') : 'Statistical Live Table'}</span>
                            <span className="text-[10px] text-slate-500 dark:text-slate-400 font-mono">{timeline.length} {t ? t('periods') : 'periods'}</span>
                        </div>
                        {/* Right: Empty for balance */}
                        <div></div>
                    </div>

                    {/* Scrollable Table */}
                    <div ref={tableRef} className="flex-1 overflow-auto rounded-xl border border-slate-200 dark:border-slate-700 stat-table-scroll">
                        <table className="w-max text-xs">
                            <thead className="sticky top-0 z-20">
                                <tr>
                                    <th className="sticky left-0 top-0 z-40 bg-slate-200 dark:bg-slate-700 px-4 py-3 text-left font-bold text-slate-700 dark:text-slate-200 border-r border-b border-slate-300 dark:border-slate-600 min-w-[160px]">
                                        {t ? t('parameterDate') : 'Parameter/Date'}
                                    </th>
                                    {timeline.map((day, idx) => (
                                        <th
                                            key={idx}
                                            className={`sticky top-0 z-20 px-3 py-3 text-center font-mono font-bold min-w-[90px] border-r border-b border-slate-200 dark:border-slate-700 ${idx === currentDay
                                                ? 'bg-brand-gold text-white'
                                                : idx < currentDay
                                                    ? 'bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400'
                                                    : 'bg-slate-100 dark:bg-slate-800 text-slate-400 dark:text-slate-500'
                                                }`}
                                        >
                                            <div className="text-[9px] uppercase mb-0.5">{t ? t('day') : 'Day'} {idx + 1}</div>
                                            <div className="text-[10px]">{day.date}</div>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {params.map((param, pIdx) => (
                                    <tr key={param.key} className={pIdx % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-slate-50 dark:bg-slate-800/50'}>
                                        <td className="sticky left-0 z-10 bg-slate-100 dark:bg-slate-800 px-4 py-2.5 font-bold text-slate-700 dark:text-slate-300 border-r border-slate-300 dark:border-slate-600 whitespace-nowrap">
                                            <span className={param.headerColor || (param.color && typeof param.color === 'string' ? param.color : '')}>{param.label}</span>
                                        </td>
                                        {timeline.map((day, dIdx) => {
                                            const colorClass = typeof param.color === 'function' ? param.color(day) : (param.color || 'text-slate-600 dark:text-slate-400');
                                            return (
                                                <td
                                                    key={dIdx}
                                                    className={`px-3 py-2.5 text-center font-mono border-r border-slate-100 dark:border-slate-800 transition-all ${colorClass} ${dIdx === currentDay ? 'bg-brand-gold/10 ring-2 ring-brand-gold ring-inset' : ''
                                                        }`}
                                                >
                                                    {param.format(day)}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- MAPPING MODAL ---
        const MappingModal = ({ headers, isOpen, onClose, onConfirm, t, fileMetadata = {} }) => {
            const [mapping, setMapping] = useState({});
            const [formatType, setFormatType] = useState('vertical'); // 'vertical', 'horizontal', 'forecaster', or 'operartis_residual'
            const [lockedParams, setLockedParams] = useState({}); // Track which params should be locked on sidebar

            // Helper: Check if a string looks like a date
            const isDateLike = (str) => {
                const s = String(str).trim();
                // Match various date formats: DD.MM.YYYY, DD/MM/YYYY, YYYY-MM-DD, MM-DD-YYYY, etc.
                const datePatterns = [
                    /^\d{1,2}[.\/-]\d{1,2}[.\/-]\d{2,4}$/,  // DD.MM.YYYY, DD/MM/YYYY, DD-MM-YYYY
                    /^\d{4}[.\/-]\d{1,2}[.\/-]\d{1,2}$/,    // YYYY-MM-DD, YYYY.MM.DD
                    /^[A-Za-z]{3,9}[\s\-]\d{1,2}[\s,\-]\d{2,4}$/,  // Jan 01 2026, January-01-2026
                ];
                return datePatterns.some(p => p.test(s));
            };

            // Helper: Check if column is P50_DATE or P90_DATE format
            const isPrefixedP50 = (col) => /^P50_\d{1,2}[.\/-]\d{1,2}[.\/-]\d{2,4}$/i.test(String(col));
            const isPrefixedP90 = (col) => /^P90_\d{1,2}[.\/-]\d{1,2}[.\/-]\d{2,4}$/i.test(String(col));

            // Detect format type based on headers
            const detectFormat = (hdrs) => {
                // Check for OPERARTIS RESIDUAL-BASED format: has SKU, Resid_Std, and date columns
                const lowerHeaders = hdrs.map(h => String(h).toLowerCase());
                const hasResidStd = lowerHeaders.some(h => h === 'resid_std' || h === 'residstd' || h === 'resid std');
                const hasSkuCol = lowerHeaders.some(h => h === 'sku' || h === 'sku_id');
                const dateColumns = hdrs.filter(h => isDateLike(h));

                if (hasResidStd && hasSkuCol && dateColumns.length >= 3) {
                    return 'operartis_residual';
                }

                // Check for PREFIX-BASED format: P50_DD.MM.YYYY, P90_DD.MM.YYYY (ML-Forecaster output)
                const p50PrefixCols = hdrs.filter(h => isPrefixedP50(h));
                const p90PrefixCols = hdrs.filter(h => isPrefixedP90(h));
                if (p50PrefixCols.length >= 5 && p90PrefixCols.length >= 5) return 'forecaster_prefixed';

                // Check for P50_D1 style horizontal format
                const lower = hdrs.map(h => String(h).toLowerCase());
                const hasP50Cols = lower.filter(h => h.match(/p50_d\d+/)).length > 5;
                const hasP90Cols = lower.filter(h => h.match(/p90_d\d+/)).length > 5;
                if (hasP50Cols && hasP90Cols) return 'horizontal';

                // Check for raw date column headers (legacy forecaster format without P90)
                if (dateColumns.length >= 5) return 'forecaster';

                // Default to vertical
                return 'vertical';
            };

            // Required columns for VERTICAL format
            const REQUIRED_COLS = [
                { key: 'sku_id', label: 'SKU ID', required: false },
                { key: 'date', label: 'Date', required: true },
                { key: 'p50', label: 'P50 (Median Demand)', required: true },
                { key: 'p90', label: 'P90 (Upper Bound)', required: true },
            ];

            // Optional parameter columns (will auto-populate sidebar when present)
            const OPTIONAL_COLS = [
                { key: 'initial_stock', label: 'Initial Stock', patterns: ['initial_stock', 'initial stock', 'starting'] },
                { key: 'lead_time_mean', label: 'Lead Time (Mean)', patterns: ['lead_time_mean', 'lead_time', 'leadtime'] },
                { key: 'lead_time_std', label: 'Lead Time (Std)', patterns: ['lead_time_std', 'leadtime_std'] },
                { key: 'review_period', label: 'Review Period', patterns: ['review_period', 'review'] },
                { key: 'min_order_qty', label: 'Min Order Qty (MOQ)', patterns: ['min_order_qty', 'moq', 'minimum'] },
                { key: 'target_service_level', label: 'Target Service Level', patterns: ['target_service_level', 'service_level'] },
                { key: 'start_date', label: 'Start Date', patterns: ['start_date', 'start'] },
            ];

            useEffect(() => {
                if (isOpen && headers.length) {
                    const format = detectFormat(headers);
                    setFormatType(format);

                    const lower = headers.map(h => String(h).toLowerCase().replace(/[^a-z0-9]/g, '_'));
                    const findCol = (patterns) => {
                        const idx = lower.findIndex(h => patterns.some(p => h.includes(p.replace(/[^a-z0-9]/g, '_'))));
                        return idx >= 0 ? headers[idx] : "";
                    };

                    if (format === 'operartis_residual') {
                        // OPERARTIS RESIDUAL-BASED format: SKU, Resid_Std, then date columns
                        // The last N date columns are forecast values (N = forecast horizon from file)
                        const dateColumns = headers.filter(h => isDateLike(h));
                        const nonDateColumns = headers.filter(h => !isDateLike(h));

                        // Find Resid_Std column
                        const residStdCol = headers.find(h =>
                            String(h).toLowerCase() === 'resid_std' ||
                            String(h).toLowerCase() === 'residstd' ||
                            String(h).toLowerCase() === 'resid std'
                        ) || '';

                        // Find SKU column
                        const skuCol = findCol(['sku', 'sku_id']) || nonDateColumns[0] || headers[0];

                        // Use forecast horizon from file metadata, otherwise default to all date columns
                        const forecastHorizon = fileMetadata?.forecastHorizon || dateColumns.length;
                        const forecastColumns = dateColumns.slice(-forecastHorizon);

                        setMapping({
                            format: 'operartis_residual',
                            sku_id: skuCol,
                            resid_std: residStdCol,
                            date_columns: dateColumns,
                            forecast_columns: forecastColumns,
                            forecast_horizon: forecastHorizon,
                            header_row_index: fileMetadata?.headerRowIndex || 0,
                            initial_stock: findCol(['initial_stock']) || '',
                            lead_time_mean: findCol(['lead_time_mean', 'lead_time']) || '',
                            lead_time_std: findCol(['lead_time_std']) || '',
                            review_period: findCol(['review_period']) || '',
                            min_order_qty: findCol(['min_order_qty', 'moq']) || '',
                            target_service_level: findCol(['target_service_level', 'service_level']) || '',
                        });

                        // Auto-lock parameters that were detected from file
                        const detectedLocks = {
                            initial_stock: !!findCol(['initial_stock']),
                            lead_time_mean: !!findCol(['lead_time_mean', 'lead_time']),
                            lead_time_std: !!findCol(['lead_time_std']),
                            review_period: !!findCol(['review_period']),
                            min_order_qty: !!findCol(['min_order_qty', 'moq']),
                            target_service_level: !!findCol(['target_service_level', 'service_level']),
                        };
                        setLockedParams(detectedLocks);

                        console.log('Operartis Residual format detected:', {
                            skuCol,
                            residStdCol,
                            dateColumnsCount: dateColumns.length,
                            forecastHorizon,
                            forecastColumns: forecastColumns.length
                        });
                    } else if (format === 'horizontal') {
                        // P50_D1 style horizontal format
                        const p50Cols = headers.filter(h => String(h).toLowerCase().match(/p50_d\d+/));
                        const p90Cols = headers.filter(h => String(h).toLowerCase().match(/p90_d\d+/));

                        const horizDetectedParams = {
                            initial_stock: findCol(['initial_stock']) || '',
                            lead_time_mean: findCol(['lead_time_mean']) || '',
                            lead_time_std: findCol(['lead_time_std']) || '',
                            review_period: findCol(['review_period']) || '',
                            min_order_qty: findCol(['min_order_qty']) || '',
                            target_service_level: findCol(['target_service_level']) || '',
                        };

                        setMapping({
                            format: 'horizontal',
                            sku_id: findCol(['sku_id', 'sku']) || headers[0],
                            p50_columns: p50Cols,
                            p90_columns: p90Cols,
                            ...horizDetectedParams,
                            start_date: findCol(['start_date']) || '',
                        });

                        // Auto-lock parameters that were detected from file
                        setLockedParams({
                            initial_stock: !!horizDetectedParams.initial_stock,
                            lead_time_mean: !!horizDetectedParams.lead_time_mean,
                            lead_time_std: !!horizDetectedParams.lead_time_std,
                            review_period: !!horizDetectedParams.review_period,
                            min_order_qty: !!horizDetectedParams.min_order_qty,
                            target_service_level: !!horizDetectedParams.target_service_level,
                        });
                    } else if (format === 'forecaster_prefixed') {
                        // PREFIX-BASED format: P50_DD.MM.YYYY, P90_DD.MM.YYYY columns
                        const p50Cols = headers.filter(h => isPrefixedP50(h)).sort();
                        const p90Cols = headers.filter(h => isPrefixedP90(h)).sort();
                        const otherCols = headers.filter(h => !isPrefixedP50(h) && !isPrefixedP90(h));

                        const detectedParams = {
                            initial_stock: findCol(['initial_stock']) || '',
                            lead_time_mean: findCol(['lead_time_mean', 'lead_time']) || '',
                            lead_time_std: findCol(['lead_time_std']) || '',
                            review_period: findCol(['review_period']) || '',
                            min_order_qty: findCol(['min_order_qty', 'moq']) || '',
                            target_service_level: findCol(['target_service_level', 'service_level']) || '',
                        };

                        setMapping({
                            format: 'forecaster_prefixed',
                            sku_id: findCol(['sku', 'id', 'item', 'product', 'article']) || otherCols[0] || headers[0],
                            p50_columns: p50Cols,
                            p90_columns: p90Cols,
                            ...detectedParams,
                        });

                        // Auto-lock parameters that were detected from file
                        const detectedLocks = {
                            initial_stock: !!detectedParams.initial_stock,
                            lead_time_mean: !!detectedParams.lead_time_mean,
                            lead_time_std: !!detectedParams.lead_time_std,
                            review_period: !!detectedParams.review_period,
                            min_order_qty: !!detectedParams.min_order_qty,
                            target_service_level: !!detectedParams.target_service_level,
                        };
                        setLockedParams(detectedLocks);
                    } else if (format === 'forecaster') {
                        // Legacy ML-Forecaster output: date column headers (01.01.2026, etc.) - P90 calculated
                        const dateColumns = headers.filter(h => isDateLike(h));
                        const nonDateColumns = headers.filter(h => !isDateLike(h));

                        const forecasterDetectedParams = {
                            initial_stock: findCol(['initial_stock']) || '',
                            lead_time_mean: findCol(['lead_time_mean', 'lead_time']) || '',
                            lead_time_std: findCol(['lead_time_std']) || '',
                            review_period: findCol(['review_period']) || '',
                            min_order_qty: findCol(['min_order_qty', 'moq']) || '',
                            target_service_level: findCol(['target_service_level', 'service_level']) || '',
                        };

                        setMapping({
                            format: 'forecaster',
                            sku_id: findCol(['sku', 'id', 'item', 'product', 'article']) || nonDateColumns[0] || headers[0],
                            date_columns: dateColumns,
                            // P90 will be calculated as P50 * variance factor
                            p90_variance_factor: 1.3,
                            ...forecasterDetectedParams,
                        });

                        // Auto-lock parameters that were detected from file
                        setLockedParams({
                            initial_stock: !!forecasterDetectedParams.initial_stock,
                            lead_time_mean: !!forecasterDetectedParams.lead_time_mean,
                            lead_time_std: !!forecasterDetectedParams.lead_time_std,
                            review_period: !!forecasterDetectedParams.review_period,
                            min_order_qty: !!forecasterDetectedParams.min_order_qty,
                            target_service_level: !!forecasterDetectedParams.target_service_level,
                        });
                    } else {
                        // Vertical format - standard mapping
                        const verticalDetectedParams = {
                            initial_stock: findCol(['initial_stock', 'initial stock', 'starting_inventory']) || '',
                            lead_time_mean: findCol(['lead_time_mean', 'lead_time', 'leadtime']) || '',
                            lead_time_std: findCol(['lead_time_std', 'leadtime_std']) || '',
                            review_period: findCol(['review_period', 'review']) || '',
                            min_order_qty: findCol(['min_order_qty', 'moq', 'minimum_order']) || '',
                            target_service_level: findCol(['target_service_level', 'service_level', 'target_alpha']) || '',
                        };

                        setMapping({
                            format: 'vertical',
                            date: findCol(['date', 'period', 'time', 'ds']) || headers[0],
                            p50: findCol(['p50', 'median', 'forecast', 'demand']) || '',
                            p90: findCol(['p90', 'upper', 'high']) || '',
                            sku_id: findCol(['sku', 'id', 'item', 'product']) || '',
                            ...verticalDetectedParams,
                        });

                        // Auto-lock parameters that were detected from file
                        setLockedParams({
                            initial_stock: !!verticalDetectedParams.initial_stock,
                            lead_time_mean: !!verticalDetectedParams.lead_time_mean,
                            lead_time_std: !!verticalDetectedParams.lead_time_std,
                            review_period: !!verticalDetectedParams.review_period,
                            min_order_qty: !!verticalDetectedParams.min_order_qty,
                            target_service_level: !!verticalDetectedParams.target_service_level,
                        });
                    }
                }
            }, [isOpen, headers]);

            if (!isOpen) return null;

            const isHorizontal = formatType === 'horizontal';
            const isForecasterPrefixed = formatType === 'forecaster_prefixed';
            const isForecaster = formatType === 'forecaster';
            const isOperartisResidual = formatType === 'operartis_residual';
            const isAutoFormat = isHorizontal || isForecasterPrefixed || isForecaster || isOperartisResidual;

            const allMapped = isHorizontal || isForecasterPrefixed
                ? (mapping.p50_columns?.length > 0 && mapping.p90_columns?.length > 0)
                : isForecaster
                    ? (mapping.date_columns?.length > 0)
                    : isOperartisResidual
                        ? (mapping.date_columns?.length > 0 && mapping.resid_std)
                        : (mapping.date && mapping.p50 && mapping.p90);
            const hasOptionalParams = mapping.initial_stock || mapping.lead_time_mean || mapping.review_period;

            // Get format display name
            const formatName = isOperartisResidual
                ? 'Operartis Forecast'
                : isForecasterPrefixed
                    ? 'Quantile Values'
                    : isForecaster
                        ? 'ML-Forecaster Output'
                        : isHorizontal
                            ? 'Horizontal Format'
                            : 'Vertical Format';

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-2xl rounded-2xl shadow-2xl w-full max-w-lg border border-white/50 dark:border-white/10 ring-1 ring-white/40 dark:ring-white/5 relative animate-slide-up z-10 max-h-[90vh] overflow-y-auto">
                        <div className="p-4 border-b border-white/50 dark:border-white/10 flex justify-between items-center sticky top-0 bg-white/70 dark:bg-slate-900/70 backdrop-blur-xl z-10">
                            <div className="flex items-center gap-2">
                                <h2 className="text-sm font-bold text-slate-800 dark:text-slate-100 uppercase tracking-wide">
                                    {isAutoFormat ? formatName + ' ' + (t ? t('detected') : 'Detected') : (t ? t('mapColumns') : 'Map Columns')}
                                </h2>
                                {isAutoFormat && (
                                    <span className={`text-[9px] font-bold px-2 py-0.5 rounded-full ${isOperartisResidual ? 'text-amber-600 bg-amber-100 dark:bg-amber-900/30' :
                                        isForecasterPrefixed ? 'text-emerald-600 bg-emerald-100 dark:bg-emerald-900/30' :
                                            isForecaster ? 'text-purple-600 bg-purple-100 dark:bg-purple-900/30' :
                                                'text-cyan-600 bg-cyan-100 dark:bg-cyan-900/30'
                                        }`}>{t ? t('auto') : 'AUTO'}</span>
                                )}
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><XIcon /></button>
                        </div>

                        {isOperartisResidual ? (
                            /* OPERARTIS RESIDUAL-BASED FORMAT UI (SKU, Resid_Std, Date columns) */
                            <div className="p-4 space-y-4">
                                <div className="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-lg p-4 border border-amber-200 dark:border-amber-800">
                                    <div className="flex items-center gap-2 mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-amber-600">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                            <polyline points="22 4 12 14.01 9 11.01" />
                                        </svg>
                                        <span className="text-xs font-bold text-amber-700 dark:text-amber-400">{t ? t('operartisForecastDetected') : 'Operartis Forecast Report Detected'}</span>
                                    </div>
                                    <div className="grid grid-cols-3 gap-3 text-xs">
                                        <div className="bg-white/50 dark:bg-slate-800/50 rounded p-2">
                                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">{t ? t('skuColumn') : 'SKU Column'}</div>
                                            <div className="font-mono font-bold text-amber-600">{mapping.sku_id ? '‚úì' : '‚Äî'}</div>
                                        </div>
                                        <div className="bg-white/50 dark:bg-slate-800/50 rounded p-2">
                                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">{t ? t('residStdLabel') : 'Resid_Std'}</div>
                                            <div className="font-mono font-bold text-amber-600">{mapping.resid_std ? '‚úì' : '‚Äî'}</div>
                                        </div>
                                        <div className="bg-white/50 dark:bg-slate-800/50 rounded p-2">
                                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">{t ? t('dateColumnsLabel') : 'Date Columns'}</div>
                                            <div className="font-mono font-bold text-amber-600">{mapping.date_columns?.length > 0 ? '‚úì' : '‚Äî'}</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t ? t('skuIdColumn') : 'SKU ID Column'}</label>
                                        <select
                                            className="w-full text-xs p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold"
                                            value={mapping.sku_id || ''}
                                            onChange={e => setMapping({ ...mapping, sku_id: e.target.value })}
                                        >
                                            <option value="">{t ? t('select') : '-- Select --'}</option>
                                            {headers.filter(h => !isDateLike(h)).map(h => <option key={h} value={h}>{h}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t ? t('residStdColumn') : 'Resid_Std Column'}</label>
                                        <select
                                            className="w-full text-xs p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold"
                                            value={mapping.resid_std || ''}
                                            onChange={e => setMapping({ ...mapping, resid_std: e.target.value })}
                                        >
                                            <option value="">{t ? t('select') : '-- Select --'}</option>
                                            {headers.filter(h => !isDateLike(h)).map(h => <option key={h} value={h}>{h}</option>)}
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t ? t('forecastHorizonDays') : 'Forecast Horizon (days)'}</label>
                                    <div className="flex gap-2 items-center">
                                        <input
                                            type="number"
                                            min="1"
                                            max={mapping.date_columns?.length || 30}
                                            className="w-24 text-xs p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold"
                                            value={mapping.forecast_horizon || mapping.date_columns?.length || 0}
                                            onChange={e => {
                                                const h = parseInt(e.target.value) || 1;
                                                setMapping({ ...mapping, forecast_horizon: h });
                                            }}
                                        />
                                        <span className="text-[10px] text-slate-500">
                                            ({(t ? t('lastDaysAsForecast') : 'Last {0} date columns will be used as forecasts').replace('{0}', mapping.forecast_horizon || mapping.date_columns?.length || 0)})
                                        </span>
                                    </div>
                                    <div className="text-[9px] text-amber-600 mt-1 italic">
                                        üí° {t ? t('forecastHorizonTip') : 'Tip: The forecast horizon is auto-detected from the file if available'}
                                    </div>
                                </div>

                                {/* Optional Parameters */}
                                <div className="border-t border-slate-200 dark:border-slate-700 pt-4">
                                    <div className="flex items-center justify-between mb-3">
                                        <span className="text-[10px] font-bold text-slate-400 uppercase">{t ? t('optionalParameters') : 'Optional Parameters'}</span>
                                        <span className="text-[9px] text-slate-400">
                                            üîí = {t ? t('lockedOnSidebar') : 'Locked on sidebar'}
                                        </span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-[10px]">
                                        {[
                                            { key: 'initial_stock', labelKey: 'initialStock', fallback: 'Initial Stock' },
                                            { key: 'lead_time_mean', labelKey: 'leadTime', fallback: 'Lead Time' },
                                            { key: 'review_period', labelKey: 'reviewPeriod', fallback: 'Review Period' },
                                            { key: 'min_order_qty', labelKey: 'moq', fallback: 'Min Order Quantity' },
                                            { key: 'target_service_level', labelKey: 'serviceLevel', fallback: 'Service Level' },
                                        ].map(({ key, labelKey, fallback }) => {
                                            const isMapped = !!mapping[key];
                                            const isLocked = lockedParams[key];
                                            return (
                                                <div key={key} className="space-y-1">
                                                    <div className="flex items-center justify-between">
                                                        <label className="font-bold text-slate-500 dark:text-slate-400">{t ? t(labelKey) : fallback}</label>
                                                        {isMapped && (
                                                            <label className="flex items-center gap-1 cursor-pointer">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={isLocked}
                                                                    onChange={e => setLockedParams({ ...lockedParams, [key]: e.target.checked })}
                                                                    className="w-3 h-3 rounded border-slate-300 text-amber-500 focus:ring-amber-500"
                                                                />
                                                                <span className="text-[9px] text-slate-400">üîí</span>
                                                            </label>
                                                        )}
                                                    </div>
                                                    <select
                                                        className={`w-full text-[10px] p-1.5 border rounded outline-none transition-all ${isMapped
                                                            ? 'bg-amber-50 dark:bg-amber-900/20 border-amber-300 dark:border-amber-700 text-amber-700 dark:text-amber-400'
                                                            : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400'
                                                            } focus:border-brand-gold`}
                                                        value={mapping[key] || ''}
                                                        onChange={e => {
                                                            const newMapping = { ...mapping, [key]: e.target.value };
                                                            setMapping(newMapping);
                                                            // Auto-lock when a column is selected, auto-unlock when cleared
                                                            if (e.target.value) {
                                                                setLockedParams({ ...lockedParams, [key]: true });
                                                            } else {
                                                                setLockedParams({ ...lockedParams, [key]: false });
                                                            }
                                                        }}
                                                    >
                                                        <option value="">{t ? t('notMapped') : '-- Not Mapped --'}</option>
                                                        {headers.filter(h => !isDateLike(h)).map(h => (
                                                            <option key={h} value={h}>{h}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        ) : isForecasterPrefixed ? (
                            /* FORECASTER PREFIX-BASED FORMAT UI (P50_DD.MM.YYYY, P90_DD.MM.YYYY) */
                            <div className="p-4 space-y-4">
                                <div className="bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 rounded-lg p-4 border border-emerald-200 dark:border-emerald-800">
                                    <div className="flex items-center gap-2 mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-emerald-600">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                            <polyline points="22 4 12 14.01 9 11.01" />
                                        </svg>
                                        <span className="text-xs font-bold text-emerald-700 dark:text-emerald-400">{t ? t('p50P90Detected') : 'P50 & P90 Columns Detected'}</span>
                                    </div>
                                    <div className="text-xs text-emerald-600 dark:text-emerald-400 mb-2">
                                        {t ? t('formatP50P90') : 'Format: P50_DD.MM.YYYY, P90_DD.MM.YYYY (complete data)'}
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-xs">
                                        <div className="bg-white/50 dark:bg-slate-800/50 rounded p-2">
                                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">{t ? t('p50Columns') : 'P50 Columns'}</div>
                                            <div className="font-mono font-bold text-emerald-600">{mapping.p50_columns?.length || 0} {t ? t('days') : 'days'}</div>
                                        </div>
                                        <div className="bg-white/50 dark:bg-slate-800/50 rounded p-2">
                                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">{t ? t('p90Columns') : 'P90 Columns'}</div>
                                            <div className="font-mono font-bold text-emerald-600">{mapping.p90_columns?.length || 0} {t ? t('days') : 'days'}</div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{t ? t('skuIdColumn') : 'SKU ID Column'}</label>
                                    <select
                                        className="w-full text-xs p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold"
                                        value={mapping.sku_id || ''}
                                        onChange={e => setMapping({ ...mapping, sku_id: e.target.value })}
                                    >
                                        <option value="">{t ? t('select') : '-- Select --'}</option>
                                        {headers.filter(h => !isPrefixedP50(h) && !isPrefixedP90(h)).map(h => <option key={h} value={h}>{h}</option>)}
                                    </select>
                                </div>

                                {/* Optional Parameters - Manual Mapping with Dropdowns */}
                                <div className="border-t border-slate-200 dark:border-slate-700 pt-4">
                                    <div className="flex items-center justify-between mb-3">
                                        <span className="text-[10px] font-bold text-slate-400 uppercase">{t ? t('optionalParameters') : 'Optional Parameters'}</span>
                                        <span className="text-[9px] text-slate-400">
                                            {t ? t('selectColumnToMap') : 'Select column to map'}
                                        </span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-[10px]">
                                        {[
                                            { key: 'initial_stock', label: t ? t('initialStock') : 'Initial Stock' },
                                            { key: 'lead_time_mean', label: t ? t('leadTime') : 'Lead Time' },
                                            { key: 'review_period', label: t ? t('reviewPeriod') : 'Review Period' },
                                            { key: 'min_order_qty', label: t ? t('moq') : 'MOQ' },
                                            { key: 'target_service_level', label: t ? t('targetServiceLevel') : 'Service Level' },
                                        ].map(({ key, label }) => {
                                            const isMapped = !!mapping[key];
                                            const isLocked = lockedParams[key];
                                            return (
                                                <div key={key} className="space-y-1">
                                                    <div className="flex items-center justify-between">
                                                        <label className="font-bold text-slate-500 dark:text-slate-400">{label}</label>
                                                        {isMapped && (
                                                            <label className="flex items-center gap-1 cursor-pointer">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={isLocked}
                                                                    onChange={e => setLockedParams({ ...lockedParams, [key]: e.target.checked })}
                                                                    className="w-3 h-3 rounded border-slate-300 text-emerald-500 focus:ring-emerald-500"
                                                                />
                                                                <span className="text-[9px] text-slate-400">üîí</span>
                                                            </label>
                                                        )}
                                                    </div>
                                                    <select
                                                        className={`w-full text-[10px] p-1.5 border rounded outline-none transition-all ${isMapped
                                                            ? 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-300 dark:border-emerald-700 text-emerald-700 dark:text-emerald-400'
                                                            : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400'
                                                            } focus:border-brand-gold`}
                                                        value={mapping[key] || ''}
                                                        onChange={e => {
                                                            const newMapping = { ...mapping, [key]: e.target.value };
                                                            setMapping(newMapping);
                                                            // Clear lock state if column is deselected
                                                            if (!e.target.value) {
                                                                setLockedParams({ ...lockedParams, [key]: false });
                                                            }
                                                        }}
                                                    >
                                                        <option value="">{t ? t('notMapped') : '-- Not Mapped --'}</option>
                                                        {headers.filter(h => !isPrefixedP50(h) && !isPrefixedP90(h)).map(h => (
                                                            <option key={h} value={h}>{h}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        ) : isHorizontal ? (
                            /* HORIZONTAL FORMAT UI */
                            <div className="p-4 space-y-4">
                                <div className="bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-cyan-900/20 dark:to-blue-900/20 rounded-lg p-4 border border-cyan-200 dark:border-cyan-800">
                                    <div className="flex items-center gap-2 mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-cyan-600">
                                            <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                                        </svg>
                                        <span className="text-xs font-bold text-cyan-700 dark:text-cyan-400">Format Auto-Detected</span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-xs">
                                        <div className="bg-white/50 dark:bg-slate-800/50 rounded p-2">
                                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">P50 Columns</div>
                                            <div className="font-mono font-bold text-cyan-600">{mapping.p50_columns?.length || 0} days</div>
                                        </div>
                                        <div className="bg-white/50 dark:bg-slate-800/50 rounded p-2">
                                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">P90 Columns</div>
                                            <div className="font-mono font-bold text-cyan-600">{mapping.p90_columns?.length || 0} days</div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">SKU ID Column</label>
                                    <select
                                        className="w-full text-xs p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold"
                                        value={mapping.sku_id || ''}
                                        onChange={e => setMapping({ ...mapping, sku_id: e.target.value })}
                                    >
                                        <option value="">-- Select --</option>
                                        {headers.filter(h => !String(h).match(/^P\d+_D\d+$/i)).map(h => <option key={h} value={h}>{h}</option>)}
                                    </select>
                                </div>

                                {/* Auto-detected parameters */}
                                <div className="border-t border-slate-200 dark:border-slate-700 pt-4">
                                    <div className="flex items-center justify-between mb-3">
                                        <span className="text-[10px] font-bold text-slate-400 uppercase">Detected Parameters</span>
                                        {hasOptionalParams && (
                                            <span className="text-[9px] font-bold text-emerald-500 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-0.5 rounded-full">
                                                ‚úì Will auto-populate
                                            </span>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 text-[10px]">
                                        {['initial_stock', 'lead_time_mean', 'lead_time_std', 'review_period', 'min_order_qty', 'target_service_level'].map(key => (
                                            <div key={key} className={`p-2 rounded ${mapping[key] ? 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'}`}>
                                                <div className="font-bold truncate">{key.replace(/_/g, ' ')}</div>
                                                <div className="font-mono">{mapping[key] ? '‚úì' : '‚Äî'}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ) : isForecaster ? (
                            /* ML-FORECASTER OUTPUT FORMAT UI */
                            <div className="p-4 space-y-4">
                                <div className="bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 rounded-lg p-4 border border-purple-200 dark:border-purple-800">
                                    <div className="flex items-center gap-2 mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-purple-600">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                            <line x1="3" y1="9" x2="21" y2="9" />
                                            <line x1="9" y1="21" x2="9" y2="9" />
                                        </svg>
                                        <span className="text-xs font-bold text-purple-700 dark:text-purple-400">ML-Forecaster Output Detected</span>
                                    </div>
                                    <div className="text-xs text-purple-600 dark:text-purple-400 mb-2">
                                        Date columns found as headers (e.g., 01.01.2026, 01.02.2026...)
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-xs">
                                        <div className="bg-white/50 dark:bg-slate-800/50 rounded p-2">
                                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">Forecast Days</div>
                                            <div className="font-mono font-bold text-purple-600">{mapping.date_columns?.length || 0} days</div>
                                        </div>
                                        <div className="bg-white/50 dark:bg-slate-800/50 rounded p-2">
                                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">P90 Formula</div>
                                            <div className="font-mono font-bold text-purple-600">P50 √ó {mapping.p90_variance_factor || 1.3}</div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">SKU ID Column</label>
                                    <select
                                        className="w-full text-xs p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold"
                                        value={mapping.sku_id || ''}
                                        onChange={e => setMapping({ ...mapping, sku_id: e.target.value })}
                                    >
                                        <option value="">-- Select --</option>
                                        {headers.filter(h => !isDateLike(h)).map(h => <option key={h} value={h}>{h}</option>)}
                                    </select>
                                </div>

                                <div>
                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">P90 Variance Factor</label>
                                    <div className="flex gap-2">
                                        {[1.2, 1.3, 1.4, 1.5].map(factor => (
                                            <button
                                                key={factor}
                                                onClick={() => setMapping({ ...mapping, p90_variance_factor: factor })}
                                                className={`flex-1 py-1.5 text-xs font-bold rounded transition-all ${(mapping.p90_variance_factor || 1.3) === factor
                                                    ? 'bg-purple-500 text-white'
                                                    : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200'
                                                    }`}
                                            >
                                                √ó{factor}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="text-[9px] text-slate-400 mt-1 italic">
                                        P90 = P50 √ó factor (simulates forecast uncertainty)
                                    </div>
                                </div>

                                {/* Auto-detected parameters */}
                                <div className="border-t border-slate-200 dark:border-slate-700 pt-4">
                                    <div className="flex items-center justify-between mb-3">
                                        <span className="text-[10px] font-bold text-slate-400 uppercase">Detected Parameters</span>
                                        {hasOptionalParams && (
                                            <span className="text-[9px] font-bold text-emerald-500 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-0.5 rounded-full">
                                                ‚úì Will auto-populate
                                            </span>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 text-[10px]">
                                        {['initial_stock', 'lead_time_mean', 'lead_time_std', 'review_period', 'min_order_qty', 'target_service_level'].map(key => (
                                            <div key={key} className={`p-2 rounded ${mapping[key] ? 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'}`}>
                                                <div className="font-bold truncate">{key.replace(/_/g, ' ')}</div>
                                                <div className="font-mono">{mapping[key] ? '‚úì' : '‚Äî'}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            /* VERTICAL FORMAT UI */
                            <>
                                <div className="p-4 space-y-3">
                                    <div className="text-[10px] font-bold text-slate-400 uppercase mb-2">Required Columns</div>
                                    {REQUIRED_COLS.map(col => (
                                        <div key={col.key}>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">
                                                {col.label} {col.required && <span className="text-red-500">*</span>}
                                            </label>
                                            <select
                                                className="w-full text-xs p-2 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold"
                                                value={mapping[col.key] || ''}
                                                onChange={e => setMapping({ ...mapping, [col.key]: e.target.value })}
                                            >
                                                <option value="">-- Select --</option>
                                                {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                            </select>
                                        </div>
                                    ))}
                                </div>

                                <div className="px-4 pb-4">
                                    <div className="border-t border-slate-200 dark:border-slate-700 pt-4">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="text-[10px] font-bold text-slate-400 uppercase">Optional: Per-SKU Parameters</span>
                                            {hasOptionalParams && (
                                                <span className="text-[9px] font-bold text-emerald-500 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-0.5 rounded-full">
                                                    ‚úì Will auto-populate sidebar
                                                </span>
                                            )}
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            {OPTIONAL_COLS.map(col => (
                                                <div key={col.key}>
                                                    <label className="text-[9px] font-bold text-slate-400 block mb-1">{col.label}</label>
                                                    <select
                                                        className="w-full text-[10px] p-1.5 border rounded bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:border-brand-gold"
                                                        value={mapping[col.key] || ''}
                                                        onChange={e => setMapping({ ...mapping, [col.key]: e.target.value })}
                                                    >
                                                        <option value="">-- Not Mapped --</option>
                                                        {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                                    </select>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="text-[9px] text-slate-400 mt-2 italic">
                                            If mapped, these values will be read from the first row of each SKU
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}

                        <div className="p-4 border-t border-slate-200 dark:border-slate-800 flex justify-end gap-2 sticky bottom-0 bg-white dark:bg-slate-900">
                            <button onClick={onClose} className="px-3 py-1.5 text-xs font-bold text-slate-500">{t ? t('cancel') : 'Cancel'}</button>
                            <button onClick={() => onConfirm({ ...mapping, lockedParams })} disabled={!allMapped} className="px-4 py-1.5 bg-brand-gold text-white text-xs font-bold rounded disabled:opacity-50">
                                {hasOptionalParams ? (t ? t('confirmLoadParams') : 'Confirm & Load Params') : (t ? t('confirm') : 'Confirm')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- TOAST NOTIFICATION COMPONENT ---
        const Toast = ({ message, type = 'error', isVisible, onClose, t }) => {
            React.useEffect(() => {
                if (isVisible) {
                    const timer = setTimeout(() => onClose(), 5000);
                    return () => clearTimeout(timer);
                }
            }, [isVisible, onClose]);

            if (!isVisible) return null;

            const typeStyles = {
                error: 'bg-red-500 text-white',
                warning: 'bg-amber-500 text-white',
                success: 'bg-emerald-500 text-white',
                info: 'bg-blue-500 text-white'
            };

            const typeIcons = {
                error: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><line x1="15" y1="9" x2="9" y2="15" /><line x1="9" y1="9" x2="15" y2="15" /></svg>,
                warning: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></svg>,
                success: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></svg>,
                info: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></svg>
            };

            return (
                <div className="fixed top-4 right-4 z-[100] animate-slide-up">
                    <div className={`${typeStyles[type]} rounded-lg shadow-lg px-4 py-3 flex items-start gap-3 max-w-md backdrop-blur-sm`}>
                        <div className="flex-shrink-0 mt-0.5">
                            {typeIcons[type]}
                        </div>
                        <div className="flex-1">
                            <p className="text-sm font-medium">{message}</p>
                        </div>
                        <button
                            onClick={onClose}
                            className="flex-shrink-0 text-white/80 hover:text-white transition-colors"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>
                        </button>
                    </div>
                </div>
            );
        };

        // --- SKU SUMMARY DASHBOARD ---
        const SummaryDashboard = ({ skuList, simResults, mcResults, optimizationResults, simulationMode, onSelectSku, isDark, isRunningMC, t }) => {
            const [sortBy, setSortBy] = useState('sku');
            const [sortDir, setSortDir] = useState('asc');

            // Build summary data - prioritize optimization results when in optimize mode
            const summaryData = skuList.map(sku => {
                const optim = optimizationResults?.[sku];
                const mc = mcResults?.[sku];
                const det = simResults[sku];
                if (!det && !optim) return null;

                // In optimize mode, use optimization results (averaged steady-state metrics)
                if (simulationMode === 'optimize' && optim) {
                    return {
                        sku,
                        alpha: optim.achievedAlpha,
                        alphaCI: null, // Optimization already returns averaged value
                        beta: optim.achievedBeta,
                        betaCI: null,
                        avgInventory: optim.mcAvgInventory || det?.metrics?.avgInventory || 0,
                        avgInvCI: null,
                        stockouts: optim.mcAvgStockoutDays || det?.metrics?.totalStockouts || 0,
                        stockoutsCI: null,
                        safetyFactor: optim.optimalSafetyFactor,
                        hasMC: false,
                        isOptimized: true
                    };
                }

                // In what-if mode, prefer MC results when available, otherwise deterministic
                if (!det) return null;
                return {
                    sku,
                    alpha: mc ? mc.alpha.mean : det.metrics.alpha,
                    alphaCI: mc ? `${(mc.alpha.p5 * 100).toFixed(1)}% - ${(mc.alpha.p95 * 100).toFixed(1)}%` : null,
                    beta: mc ? mc.beta.mean : det.metrics.beta,
                    betaCI: mc ? `${(mc.beta.p5 * 100).toFixed(1)}% - ${(mc.beta.p95 * 100).toFixed(1)}%` : null,
                    avgInventory: mc ? mc.avgInventory.mean : det.metrics.avgInventory,
                    avgInvCI: mc ? `${Math.round(mc.avgInventory.p5)} - ${Math.round(mc.avgInventory.p95)}` : null,
                    stockouts: mc ? mc.stockoutDays.mean : det.metrics.totalStockouts,
                    stockoutsCI: mc ? `${mc.stockoutDays.p5.toFixed(0)} - ${mc.stockoutDays.p95.toFixed(0)}` : null,
                    hasMC: !!mc,
                    isOptimized: false
                };
            }).filter(Boolean);

            const sortedData = [...summaryData].sort((a, b) => {
                let valA = a[sortBy], valB = b[sortBy];
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                return sortDir === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });

            const avgAlpha = summaryData.length ? summaryData.reduce((s, d) => s + d.alpha, 0) / summaryData.length : 0;
            const avgBeta = summaryData.length ? summaryData.reduce((s, d) => s + d.beta, 0) / summaryData.length : 0;
            const avgStockouts = summaryData.reduce((s, d) => s + d.stockouts, 0) / (summaryData.length || 1);
            const lowAlphaCount = summaryData.filter(d => d.alpha < 0.90).length;
            const hasMC = summaryData.some(d => d.hasMC);
            const hasOptimized = summaryData.some(d => d.isOptimized);

            const handleSort = (col) => { if (sortBy === col) setSortDir(sortDir === 'asc' ? 'desc' : 'asc'); else { setSortBy(col); setSortDir('asc'); } };
            const SortIcon = ({ col }) => <span className="ml-1 opacity-50">{sortBy === col ? (sortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</span>;

            return (
                <div className="h-full flex flex-col gap-4 animate-slide-up">
                    {/* MC Status */}
                    {isRunningMC && (
                        <div className="flex items-center gap-2 px-4 py-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                            <LoaderIcon />
                            <span className="text-xs font-bold text-blue-600 dark:text-blue-400">Running Monte Carlo (500 simulations per SKU)...</span>
                        </div>
                    )}

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div className="bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl p-4 rounded-2xl border border-white/50 dark:border-white/10 shadow-md ring-1 ring-white/40 dark:ring-white/5">
                            <div className="text-[10px] font-bold text-slate-400 mb-1">
                                {t ? t('avgServiceLevel') : 'AVG SERVICE LEVEL (Œ±)'} {hasMC && <span className="text-blue-400">‚Ä¢ MC</span>}
                            </div>
                            <div className={`text-2xl font-black ${avgAlpha >= 0.95 ? 'text-emerald-500' : avgAlpha >= 0.90 ? 'text-amber-500' : 'text-red-500'}`}>
                                {(avgAlpha * 100).toFixed(1)}%
                            </div>
                        </div>
                        <div className="bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl p-4 rounded-2xl border border-white/50 dark:border-white/10 shadow-md ring-1 ring-white/40 dark:ring-white/5">
                            <div className="text-[10px] font-bold text-slate-400 mb-1">
                                {t ? t('avgFillRate') : 'AVG FILL RATE (Œ≤)'} {hasMC && <span className="text-blue-400">‚Ä¢ MC</span>}
                            </div>
                            <div className="text-2xl font-black text-blue-500">{(avgBeta * 100).toFixed(1)}%</div>
                        </div>
                        <div className="bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl p-4 rounded-2xl border border-white/50 dark:border-white/10 shadow-md ring-1 ring-white/40 dark:ring-white/5">
                            <div className="text-[10px] font-bold text-slate-400 mb-1">
                                {t ? t('avgStockoutDays') : 'AVG STOCKOUT DAYS'} {hasMC && <span className="text-blue-400">‚Ä¢ MC</span>}
                            </div>
                            <div className={`text-2xl font-black ${avgStockouts < 1 ? 'text-emerald-500' : 'text-red-500'}`}>
                                {avgStockouts.toFixed(1)}
                            </div>
                        </div>
                        <div className="bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl p-4 rounded-2xl border border-white/50 dark:border-white/10 shadow-md ring-1 ring-white/40 dark:ring-white/5">
                            <div className="text-[10px] font-bold text-slate-400 mb-1">{t ? t('skusBelow90') : 'SKUS BELOW 90% Œ±'}</div>
                            <div className={`text-2xl font-black ${lowAlphaCount === 0 ? 'text-emerald-500' : 'text-amber-500'}`}>{lowAlphaCount} / {summaryData.length}</div>
                        </div>
                    </div>
                    <div className="flex-1 bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl rounded-2xl border border-white/50 dark:border-white/10 shadow-lg ring-1 ring-white/50 dark:ring-white/5 overflow-hidden flex flex-col">
                        <div className="p-4 border-b border-white/50 dark:border-white/10 flex justify-between items-center bg-white/40 dark:bg-slate-900/40">
                            <div className="flex items-center gap-3">
                                <h3 className="font-bold text-slate-800 dark:text-white">{t ? t('skuPerformanceSummary') : 'SKU Performance Summary'}</h3>
                                {hasOptimized && <span className="text-[10px] px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-full font-bold">{t ? t('optimizedSteadyState') : '‚úì Optimized (Steady-State Œ±/Œ≤)'}</span>}
                                {hasMC && !hasOptimized && <span className="text-[10px] px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full font-bold">{t ? t('monteCarloRuns') : 'Monte Carlo (500 runs)'}</span>}
                            </div>
                            <div className="text-xs text-slate-400">{summaryData.length} SKUs {hasOptimized ? (t ? t('skusOptimized') : 'optimized') : (t ? t('skusSimulated') : 'simulated')}</div>
                        </div>
                        <div className="flex-1 overflow-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-slate-50 dark:bg-slate-800 sticky top-0">
                                    <tr>
                                        <th onClick={() => handleSort('sku')} className="text-left px-4 py-3 text-[10px] font-bold text-slate-500 cursor-pointer hover:text-brand-gold">{t ? t('skuId') : 'SKU ID'} <SortIcon col="sku" /></th>
                                        <th onClick={() => handleSort('alpha')} className="text-center px-4 py-3 text-[10px] font-bold text-slate-500 cursor-pointer hover:text-brand-gold">{t ? t('alphaCol') : 'ALPHA (Œ±)'} <SortIcon col="alpha" /></th>
                                        <th onClick={() => handleSort('beta')} className="text-center px-4 py-3 text-[10px] font-bold text-slate-500 cursor-pointer hover:text-brand-gold">{t ? t('betaCol') : 'BETA (Œ≤)'} <SortIcon col="beta" /></th>
                                        {hasOptimized && <th onClick={() => handleSort('safetyFactor')} className="text-center px-4 py-3 text-[10px] font-bold text-slate-500 cursor-pointer hover:text-brand-gold">{t ? t('safetyFactorCol') : 'SAFETY FACTOR'} <SortIcon col="safetyFactor" /></th>}
                                        <th onClick={() => handleSort('avgInventory')} className="text-center px-4 py-3 text-[10px] font-bold text-slate-500 cursor-pointer hover:text-brand-gold">{t ? t('avgInvCol') : 'AVG INV'} <SortIcon col="avgInventory" /></th>
                                        <th onClick={() => handleSort('stockouts')} className="text-center px-4 py-3 text-[10px] font-bold text-slate-500 cursor-pointer hover:text-brand-gold">{t ? t('stockoutsCol') : 'STOCKOUTS'} <SortIcon col="stockouts" /></th>
                                        <th className="text-center px-4 py-3 text-[10px] font-bold text-slate-500">{t ? t('actionCol') : 'ACTION'}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedData.map((row, idx) => (
                                        <tr key={row.sku} className={`border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors cursor-pointer ${idx % 2 === 0 ? '' : 'bg-slate-50/50 dark:bg-slate-800/30'}`} onClick={() => onSelectSku(row.sku)}>
                                            <td className="px-4 py-3 font-mono font-bold text-slate-700 dark:text-slate-200">{row.sku}</td>
                                            <td className="px-4 py-3 text-center" title={row.alphaCI ? `90% CI: ${row.alphaCI}` : (row.isOptimized ? 'Avg of 500 Monte Carlo runs (steady-state)' : '')}>
                                                <span className={`px-2 py-1 rounded-full text-xs font-bold ${row.alpha >= 0.95 ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400' : row.alpha >= 0.90 ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'}`}>
                                                    {(row.alpha * 100).toFixed(1)}%
                                                </span>
                                                {row.alphaCI && <div className="text-[9px] text-slate-400 mt-0.5">¬±{((row.alpha - parseFloat(row.alphaCI.split(' - ')[0]) / 100) * 100).toFixed(1)}%</div>}
                                            </td>
                                            <td className="px-4 py-3 text-center" title={row.betaCI ? `90% CI: ${row.betaCI}` : (row.isOptimized ? 'Avg of 500 Monte Carlo runs (steady-state)' : '')}>
                                                <span className="text-blue-600 dark:text-blue-400 font-bold">{(row.beta * 100).toFixed(1)}%</span>
                                                {row.betaCI && <div className="text-[9px] text-slate-400">¬±{((row.beta - parseFloat(row.betaCI.split(' - ')[0]) / 100) * 100).toFixed(1)}%</div>}
                                            </td>
                                            {hasOptimized && (
                                                <td className="px-4 py-3 text-center">
                                                    <span className="font-bold text-cyan-600 dark:text-cyan-400">{row.safetyFactor || '-'}√ó</span>
                                                </td>
                                            )}
                                            <td className="px-4 py-3 text-center font-mono text-slate-600 dark:text-slate-300" title={row.avgInvCI ? `90% CI: ${row.avgInvCI}` : ''}>
                                                {Math.round(row.avgInventory).toLocaleString()}
                                                {row.avgInvCI && <div className="text-[9px] text-slate-400">{row.avgInvCI}</div>}
                                            </td>
                                            <td className="px-4 py-3 text-center" title={row.stockoutsCI ? `90% CI: ${row.stockoutsCI} days` : ''}>
                                                {row.stockouts < 0.5 ? <span className="text-emerald-500 font-bold">‚úì Rare</span> : <span className="text-red-500 font-bold">{row.stockouts.toFixed(1)} days</span>}
                                                {row.stockoutsCI && <div className="text-[9px] text-slate-400">{row.stockoutsCI}</div>}
                                            </td>
                                            <td className="px-4 py-3 text-center"><button className="px-3 py-1 text-xs font-bold text-brand-gold hover:bg-brand-gold/10 rounded transition-colors">{t ? t('view') : 'View'} ‚Üí</button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };



        // --- MAIN APP ---
        const App = () => {
            // File & Data State
            const [file, setFile] = useState(null);
            const [availableCols, setAvailableCols] = useState([]);
            const [columnMapping, setColumnMapping] = useState({});
            const [paramsLockState, setParamsLockState] = useState({}); // Track which params are locked from file
            const [isMappingModalOpen, setIsMappingModalOpen] = useState(false);
            const [fileMetadata, setFileMetadata] = useState({}); // Stores detected file format metadata (forecast_horizon, header_row_index)
            const fileInputRef = useRef(null);

            // Multi-SKU State
            const [skuList, setSkuList] = useState([]);
            const [currentSku, setCurrentSku] = useState(null);
            const [skuDataMap, setSkuDataMap] = useState({}); // { sku: forecastData[] }
            const [skuParamsMap, setSkuParamsMap] = useState({}); // { sku: {initialStock, leadTime, ...} } - per-SKU params from template
            const [manualParamsMap, setManualParamsMap] = useState({}); // { sku: params } - manually configured params per SKU
            const [simResults, setSimResults] = useState({}); // { sku: simResult }

            // Simulation Parameters
            const [params, setParams] = useState({
                initialStock: 500,
                // New Lead Time Configuration
                leadTimeConfig: {
                    type: 'deterministic',  // 'deterministic' | 'value' | 'poisson' | 'binomial' | 'uniform'
                    deterministicValue: 14,
                    // For 'value' type: array of {value, probability}
                    values: [{ value: 14, probability: 1.0 }],
                    // For 'poisson' type
                    poissonLambda: 14,
                    // For 'binomial' type
                    binomialN: 20,
                    binomialP: 0.7,
                    // For 'uniform' type
                    uniformMin: 7,
                    uniformMax: 21
                },
                reviewPeriod: 7,
                serviceLevel: 0.95,
                safetyFactor: 1.0,  // œÉ multiplier: 1.0 = normal, 1.5 = +50%, 2.0 = +100%
                moqValue: 0         // Min Order Quantity (0 = no minimum)
            });

            // Simulation State (current SKU)
            const [currentDay, setCurrentDay] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [speed, setSpeed] = useState(200); // ms per step
            const [viewMode, setViewMode] = useState('individual'); // 'individual' or 'summary'
            const [chartTableView, setChartTableView] = useState('chart'); // 'chart' or 'table' for individual SKU view

            // Mode Toggle: 'optimize' vs 'whatif'
            const [simulationMode, setSimulationMode] = useState('optimize');

            // Optimization State
            const [isOptimizing, setIsOptimizing] = useState(false);
            const [isReloading, setIsReloading] = useState(false); // Quick single simulation reload
            const [optimizationResults, setOptimizationResults] = useState({}); // { sku: PolicyOptimizationResult }

            // Monte Carlo State
            const [mcResults, setMcResults] = useState({}); // { sku: { alpha, beta, avgInventory, stockoutDays } }
            const [isRunningMC, setIsRunningMC] = useState(false);

            // Export State
            const [isExporting, setIsExporting] = useState(false);

            // Toast Notification State
            const [toast, setToast] = useState({ isVisible: false, message: '', type: 'error' });
            const showToast = (message, type = 'error') => setToast({ isVisible: true, message, type });
            const hideToast = () => setToast(prev => ({ ...prev, isVisible: false }));

            // Get current SKU's simulation result
            const simResult = currentSku ? simResults[currentSku] : null;
            const mcResult = currentSku ? mcResults[currentSku] : null;
            const optimResult = currentSku ? optimizationResults[currentSku] : null;
            const forecastData = currentSku ? skuDataMap[currentSku] : null;
            const hasAllResults = skuList.length > 0 && skuList.every(sku => simResults[sku]);

            // UI State
            const [theme, setTheme] = useState(() => localStorage.getItem('inv-theme') || 'system');
            const [isDark, setIsDark] = useState(false);
            const [language, setLanguage] = useState(() => localStorage.getItem('inv-lang') || 'en');

            // API URL State & Auto-Detection
            const [apiUrl, setApiUrl] = useState(API_ENDPOINTS.LOCAL);
            const [connectionStatus, setConnectionStatus] = useState('checking'); // checking, local, cloud

            // Auto-detect API connection (LOCAL or CLOUD)
            useEffect(() => {
                const checkConnection = async () => {
                    // Check if we are running in a local environment
                    const isLocal = window.location.hostname === 'localhost' ||
                        window.location.hostname === '127.0.0.1' ||
                        window.location.protocol === 'file:';

                    if (!isLocal) {
                        // If on a production domain, default to Cloud API
                        setApiUrl(API_ENDPOINTS.PROD);
                        setConnectionStatus('cloud');
                        return;
                    }

                    setConnectionStatus('checking');
                    try {
                        // Try to connect to Local API with a short timeout
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 2000);

                        const res = await fetch(`${API_ENDPOINTS.LOCAL}/`, {
                            method: 'GET',
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);

                        if (res.ok || res.status === 404) {
                            setApiUrl(API_ENDPOINTS.LOCAL);
                            setConnectionStatus('local');
                            console.log("Connected to Local API (inventory_engine)");
                        } else {
                            throw new Error('Local API error');
                        }
                    } catch (e) {
                        // Fallback to PROD
                        setApiUrl(API_ENDPOINTS.PROD);
                        setConnectionStatus('cloud');
                        console.log("Local API unreachable, using Cloud API");
                    }
                };

                checkConnection();
            }, []);

            // Translation helper
            const t = (key) => translations[language]?.[key] || translations.en[key] || key;

            // Language Effect
            useEffect(() => {
                localStorage.setItem('inv-lang', language);
            }, [language]);

            // Theme Effect
            useEffect(() => {
                const applyTheme = () => {
                    const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const isD = theme === 'dark' || (theme === 'system' && sysDark);
                    setIsDark(isD);
                    if (isD) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                    localStorage.setItem('inv-theme', theme);
                };
                applyTheme();
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
            }, [theme]);

            // Track previous SKU for saving params before switch
            const prevSkuRef = React.useRef(null);

            // Save current params when switching away from a SKU, load params when switching to a new SKU
            useEffect(() => {
                // Save params of the previous SKU before switching (only if not file-locked)
                if (prevSkuRef.current && prevSkuRef.current !== currentSku) {
                    setManualParamsMap(prev => ({
                        ...prev,
                        [prevSkuRef.current]: { ...params }
                    }));
                    console.log(`Saved params for ${prevSkuRef.current}:`, params);
                }

                // Load params for the new SKU
                if (currentSku) {
                    // Priority: 1. manualParamsMap (user configured), 2. skuParamsMap (from file), 3. current defaults
                    const manualParams = manualParamsMap[currentSku];
                    const fileParams = skuParamsMap[currentSku];

                    if (manualParams) {
                        // User has previously configured this SKU - restore their settings
                        setParams(manualParams);
                        console.log(`Restored manual params for ${currentSku}:`, manualParams);
                    } else if (fileParams) {
                        // No manual config, but file has params - use file defaults
                        setParams(prev => ({
                            ...prev,
                            initialStock: fileParams.initialStock ?? prev.initialStock,
                            leadTimeConfig: fileParams.leadTime
                                ? { ...prev.leadTimeConfig, type: 'deterministic', deterministicValue: fileParams.leadTime }
                                : prev.leadTimeConfig,
                            reviewPeriod: fileParams.reviewPeriod ?? prev.reviewPeriod,
                            serviceLevel: fileParams.serviceLevel ?? prev.serviceLevel,
                            moqValue: fileParams.moqValue ?? prev.moqValue
                        }));
                        console.log(`Loaded file params for ${currentSku}:`, fileParams);
                    }
                    // If neither manual nor file params exist, keep current params as-is (global defaults)
                }

                // Update ref to track current SKU for next switch
                prevSkuRef.current = currentSku;
            }, [currentSku]);

            // Sync current params to manualParamsMap whenever user edits them
            useEffect(() => {
                if (currentSku) {
                    setManualParamsMap(prev => ({
                        ...prev,
                        [currentSku]: { ...params }
                    }));
                }
            }, [params, currentSku]);

            // Playback Effect
            useEffect(() => {
                if (!isPlaying || !simResult) return;

                const interval = setInterval(() => {
                    setCurrentDay(prev => {
                        if (prev >= simResult.timeline.length - 1) {
                            setIsPlaying(false);
                            return prev;
                        }
                        return prev + 1;
                    });
                }, speed);

                return () => clearInterval(interval);
            }, [isPlaying, speed, simResult]);

            // File Upload Handler
            const handleFileChange = (e) => {
                const f = e.target.files[0];
                if (!f) return;

                // Reset file input value to allow re-uploading the same file
                e.target.value = '';

                setFile(f);
                setSimResults({});
                setSkuList([]);
                setSkuDataMap({});
                setCurrentSku(null);
                setViewMode('individual');

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary', cellStyles: true });
                        const ws = wb.Sheets[wb.SheetNames[0]];

                        // Try to detect Operartis Forecast Report format
                        // Check for "OPERARTIS FORECAST REPORT" in row 2-3
                        const rawData = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
                        let isOperartisForecast = false;
                        let forecastHorizon = 0;
                        let headerRowIndex = 0;

                        // Search for Operartis signature in first 10 rows
                        for (let i = 0; i < Math.min(10, rawData.length); i++) {
                            const rowStr = (rawData[i] || []).join(' ').toLowerCase();
                            if (rowStr.includes('operartis') && rowStr.includes('forecast')) {
                                isOperartisForecast = true;
                            }
                            // Check for "Forecast Horizon: X periods" pattern
                            if (rowStr.includes('forecast horizon')) {
                                const match = rowStr.match(/(\d+)\s*periods?/i);
                                if (match) {
                                    forecastHorizon = parseInt(match[1]);
                                    console.log('Detected forecast horizon:', forecastHorizon);
                                }
                            }
                        }

                        // Find header row (row with SKU and Resid_Std)
                        if (isOperartisForecast) {
                            for (let i = 0; i < Math.min(20, rawData.length); i++) {
                                const row = rawData[i] || [];
                                const hasSkuHeader = row.some(cell => String(cell).toLowerCase() === 'sku');
                                const hasResidStd = row.some(cell => String(cell).toLowerCase() === 'resid_std');
                                if (hasSkuHeader && hasResidStd) {
                                    headerRowIndex = i;
                                    console.log('Found header row at index:', headerRowIndex);
                                    break;
                                }
                            }
                        }

                        let headers;
                        if (isOperartisForecast && headerRowIndex > 0) {
                            // Use the detected header row
                            headers = rawData[headerRowIndex].filter(h => h !== null && h !== undefined);
                            console.log('Operartis format detected. Headers from row', headerRowIndex + 1, ':', headers);
                            // Store metadata in state for later processing
                            setFileMetadata({
                                isOperartisForecast: true,
                                headerRowIndex,
                                forecastHorizon
                            });
                        } else {
                            // Standard format - use first row as headers
                            headers = XLSX.utils.sheet_to_json(ws, { header: 1 })[0];
                            // Clear any previous file metadata
                            setFileMetadata({});
                        }

                        console.log('File headers:', headers);
                        if (headers?.length) {
                            // Store workbook and worksheet for later use in mapping confirm
                            ws.__workbook = wb;
                            setAvailableCols(headers);
                            setIsMappingModalOpen(true);
                        } else {
                            // Show error toast instead of alert
                            showToast(t('noHeadersFound'), 'error');
                            // Reset file state to allow re-upload
                            setFile(null);
                        }
                    } catch (err) {
                        console.error('Error reading file:', err);
                        showToast(`${t('fileReadError')}: ${err.message}`, 'error');
                        // Reset file state to allow re-upload
                        setFile(null);
                    }
                };
                reader.readAsBinaryString(f);
            };

            const handleMappingConfirm = (mapping) => {
                // Extract lockedParams from mapping
                const { lockedParams, ...restMapping } = mapping;
                setColumnMapping(restMapping);
                setParamsLockState(lockedParams || {});
                setIsMappingModalOpen(false);

                // Parse file data with SKU grouping
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary', cellDates: true });
                        const ws = wb.Sheets[wb.SheetNames[0]];

                        let data;

                        // Helper to check if a value is a valid SKU (not a copyright notice or footer text)
                        const isValidSku = (val) => {
                            if (val === null || val === undefined || val === '') return false;
                            const str = String(val).toLowerCase().trim();
                            // Exclude copyright notices, footer text, and other non-SKU patterns
                            const invalidPatterns = [
                                /^¬©/,                           // Starts with copyright symbol
                                /copyright/i,                   // Contains "copyright"
                                /all rights reserved/i,         // Contains "all rights reserved"
                                /operartis analytics/i,         // Contains company name as footer
                                /^\d{4}\s+operartis/i,          // Year followed by company name
                                /^generated\s+(by|on|at)/i,     // Generated by/on/at notices
                                /^report\s+generated/i,         // Report generated notices
                                /^page\s+\d+/i,                 // Page numbers
                                /^total[:\s]/i,                 // Total row
                                /^sum[:\s]/i,                   // Sum row
                                /^average[:\s]/i,               // Average row
                            ];
                            return !invalidPatterns.some(p => p.test(str));
                        };

                        // Helper to normalize header names (handles Date objects, etc.)
                        const normalizeHeader = (h) => {
                            if (h === null || h === undefined) return '';
                            if (h instanceof Date) {
                                // Format as YYYY-MM-DD
                                return h.toISOString().split('T')[0];
                            }
                            return String(h);
                        };

                        // For Operartis format, we need to skip to the header row
                        if (mapping.format === 'operartis_residual') {
                            // Read raw data as 2D array
                            const rawData = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });

                            // Find header row (row with SKU and Resid_Std)
                            let headerRowIndex = mapping.header_row_index || 0;
                            if (headerRowIndex === 0) {
                                // Fallback: detect header row
                                for (let i = 0; i < Math.min(20, rawData.length); i++) {
                                    const row = rawData[i] || [];
                                    const rowLower = row.map(c => String(c || '').toLowerCase());
                                    if (rowLower.includes('sku') && rowLower.some(h => h === 'resid_std' || h === 'residstd')) {
                                        headerRowIndex = i;
                                        console.log('Found Operartis header row at index:', headerRowIndex);
                                        break;
                                    }
                                }
                            }

                            // Get headers from the correct row and normalize them
                            const rawHeaders = rawData[headerRowIndex] || [];
                            const headers = rawHeaders.map(normalizeHeader).filter(h => h !== '');

                            console.log('Raw headers:', rawHeaders);
                            console.log('Normalized headers:', headers);

                            // Create a mapping from column index to header name
                            const colIndexToHeader = {};
                            rawHeaders.forEach((h, idx) => {
                                const normalized = normalizeHeader(h);
                                if (normalized) {
                                    colIndexToHeader[idx] = normalized;
                                }
                            });

                            // Convert remaining rows to objects using the headers
                            data = [];
                            for (let i = headerRowIndex + 1; i < rawData.length; i++) {
                                const row = rawData[i];
                                if (!row || row.every(c => c === null || c === undefined || c === '')) continue;

                                const obj = {};
                                Object.entries(colIndexToHeader).forEach(([colIdx, header]) => {
                                    const value = row[parseInt(colIdx)];
                                    if (value !== undefined && value !== null) {
                                        obj[header] = value;
                                    }
                                });

                                // Only add row if it has valid SKU data (not copyright notices or footer text)
                                const skuVal = obj[mapping.sku_id];
                                if (skuVal !== undefined && skuVal !== null && skuVal !== '' && isValidSku(skuVal)) {
                                    data.push(obj);
                                }
                            }

                            console.log('Operartis format: Parsed', data.length, 'data rows');
                            console.log('Headers:', headers);
                            if (data.length > 0) console.log('Sample row:', data[0]);
                        } else {
                            // Standard format - use regular sheet_to_json
                            data = XLSX.utils.sheet_to_json(ws, { raw: false, dateNF: 'yyyy-mm-dd' });
                        }

                        console.log('Parsed data rows:', data.length);
                        console.log('Sample row:', data[0]);
                        console.log('Mapping:', mapping);

                        const isHorizontal = mapping.format === 'horizontal';
                        const grouped = {};
                        const skuParams = {};

                        if (isHorizontal) {
                            // === HORIZONTAL FORMAT ===
                            // Each row is a SKU with P50_D1...P50_DN, P90_D1...P90_DN columns
                            console.log('Processing HORIZONTAL format');

                            const p50Cols = mapping.p50_columns || [];
                            const p90Cols = mapping.p90_columns || [];

                            // Get start date from data or use today
                            const startDateStr = data[0] && mapping.start_date ? data[0][mapping.start_date] : null;
                            const startDate = startDateStr ? new Date(startDateStr) : new Date();

                            data.forEach((row, rowIdx) => {
                                const rawSkuId = row[mapping.sku_id];
                                // Skip rows with invalid SKU values (copyright notices, footer text, etc.)
                                if (!isValidSku(rawSkuId)) return;

                                const skuId = String(rawSkuId || `SKU_${rowIdx + 1}`);
                                grouped[skuId] = [];

                                // Parse P50 and P90 columns into time series
                                p50Cols.forEach((p50Col, dayIdx) => {
                                    const p90Col = p90Cols[dayIdx];
                                    const p50Val = row[p50Col];
                                    const p90Val = p90Col ? row[p90Col] : null;

                                    const p50 = typeof p50Val === 'number' ? p50Val : parseFloat(String(p50Val).replace(/,/g, '')) || 0;
                                    const p90 = p90Val
                                        ? (typeof p90Val === 'number' ? p90Val : parseFloat(String(p90Val).replace(/,/g, '')) || 0)
                                        : p50 * 1.3;

                                    const date = new Date(startDate);
                                    date.setDate(date.getDate() + dayIdx);
                                    const dateStr = date.toISOString().split('T')[0];

                                    if (p50 > 0 || p90 > 0) {
                                        grouped[skuId].push({ date: dateStr, p50, p90 });
                                    }
                                });

                                // Extract parameters from the same row
                                const parseNum = (col) => {
                                    if (!mapping[col]) return null;
                                    const val = row[mapping[col]];
                                    return typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, '')) || null;
                                };

                                // Normalize service level (convert percentage to decimal if > 1)
                                const rawSL = parseNum('target_service_level');
                                const normalizedSL = rawSL != null ? (rawSL > 1 ? rawSL / 100 : rawSL) : null;

                                skuParams[skuId] = {
                                    initialStock: parseNum('initial_stock'),
                                    leadTime: parseNum('lead_time_mean'),
                                    leadTimeStd: parseNum('lead_time_std') ?? 0,
                                    reviewPeriod: parseNum('review_period'),
                                    moqValue: parseNum('min_order_qty') ?? 0,
                                    serviceLevel: normalizedSL
                                };
                            });

                            console.log('Horizontal format parsed:', Object.keys(grouped).length, 'SKUs');
                        } else if (mapping.format === 'forecaster_prefixed') {
                            // === FORECASTER PREFIX-BASED FORMAT ===
                            // Columns: P50_DD.MM.YYYY, P90_DD.MM.YYYY
                            console.log('Processing FORECASTER PREFIX-BASED format');

                            const p50Cols = mapping.p50_columns || [];
                            const p90Cols = mapping.p90_columns || [];

                            // Parse date from column name like "P50_16.01.2026" -> Date
                            const parsePrefixedDate = (colName) => {
                                const match = String(colName).match(/^P(?:50|90)_(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})$/i);
                                if (match) {
                                    const day = parseInt(match[1]);
                                    const month = parseInt(match[2]) - 1;
                                    let year = parseInt(match[3]);
                                    if (year < 100) year += 2000;
                                    return new Date(year, month, day);
                                }
                                return null;
                            };

                            // Extract date string from P50 column name
                            const getDateFromCol = (colName) => {
                                const dateObj = parsePrefixedDate(colName);
                                return dateObj ? dateObj.toISOString().split('T')[0] : null;
                            };

                            data.forEach((row, rowIdx) => {
                                const rawSkuId = row[mapping.sku_id];
                                // Skip rows with invalid SKU values (copyright notices, footer text, etc.)
                                if (!isValidSku(rawSkuId)) return;

                                const skuId = String(rawSkuId || `SKU_${rowIdx + 1}`);
                                grouped[skuId] = [];

                                // Match P50 and P90 columns by date
                                p50Cols.forEach((p50Col, idx) => {
                                    const dateStr = getDateFromCol(p50Col);
                                    if (!dateStr) return;

                                    // Find corresponding P90 column
                                    const p90Col = p90Cols[idx];

                                    const p50Val = row[p50Col];
                                    const p90Val = p90Col ? row[p90Col] : null;

                                    const p50 = typeof p50Val === 'number' ? p50Val : parseFloat(String(p50Val).replace(/,/g, '')) || 0;
                                    const p90 = p90Val
                                        ? (typeof p90Val === 'number' ? p90Val : parseFloat(String(p90Val).replace(/,/g, '')) || 0)
                                        : p50 * 1.3;

                                    if (p50 > 0 || p90 > 0) {
                                        grouped[skuId].push({ date: dateStr, p50, p90 });
                                    }
                                });

                                // Sort by date
                                grouped[skuId].sort((a, b) => new Date(a.date) - new Date(b.date));

                                // Extract parameters from the same row
                                const parseNum = (col) => {
                                    if (!mapping[col]) return null;
                                    const val = row[mapping[col]];
                                    return typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, '')) || null;
                                };

                                // Normalize service level (convert percentage to decimal if > 1)
                                const rawSL = parseNum('target_service_level');
                                const normalizedSL = rawSL != null ? (rawSL > 1 ? rawSL / 100 : rawSL) : null;

                                skuParams[skuId] = {
                                    initialStock: parseNum('initial_stock'),
                                    leadTime: parseNum('lead_time_mean'),
                                    leadTimeStd: parseNum('lead_time_std') ?? 0,
                                    reviewPeriod: parseNum('review_period'),
                                    moqValue: parseNum('min_order_qty') ?? 0,
                                    serviceLevel: normalizedSL
                                };
                            });

                            console.log('Forecaster prefixed format parsed:', Object.keys(grouped).length, 'SKUs');
                        } else if (mapping.format === 'operartis_residual') {
                            // === OPERARTIS RESIDUAL-BASED FORMAT ===
                            // Each row is a SKU with Resid_Std column and date columns
                            // Forecast values are the last N date columns (N = forecast_horizon)
                            console.log('Processing OPERARTIS RESIDUAL-BASED format');

                            // Helper: Check if a string looks like a date
                            const isDateLikeHelper = (str) => {
                                const s = String(str).trim();
                                const datePatterns = [
                                    /^\d{1,2}[.\/-]\d{1,2}[.\/-]\d{2,4}$/,
                                    /^\d{4}[.\/-]\d{1,2}[.\/-]\d{1,2}$/,
                                ];
                                return datePatterns.some(p => p.test(s));
                            };

                            // Parse date column header to actual Date
                            const parseColDate = (colHeader) => {
                                const s = String(colHeader).trim();
                                // DD.MM.YYYY or DD/MM/YYYY or DD-MM-YYYY
                                let match = s.match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})$/);
                                if (match) {
                                    const day = parseInt(match[1]);
                                    const month = parseInt(match[2]) - 1;
                                    let year = parseInt(match[3]);
                                    if (year < 100) year += 2000;
                                    return new Date(year, month, day);
                                }
                                // YYYY-MM-DD or YYYY.MM.DD
                                match = s.match(/^(\d{4})[.\/-](\d{1,2})[.\/-](\d{1,2})$/);
                                if (match) {
                                    return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                                }
                                const d = new Date(s);
                                return isNaN(d.getTime()) ? null : d;
                            };

                            // Get all date columns from the actual parsed data headers
                            // This ensures we use the correct header names as they appear in the data
                            const dataHeaders = data.length > 0 ? Object.keys(data[0]) : [];
                            const actualDateColumns = dataHeaders.filter(h => isDateLikeHelper(h) || parseColDate(h) !== null);

                            // Use forecast horizon from mapping
                            const forecastHorizon = mapping.forecast_horizon || actualDateColumns.length;

                            // The last N columns are forecast values
                            const forecastColumns = actualDateColumns.slice(-forecastHorizon);

                            console.log('All date columns in data:', actualDateColumns.length, actualDateColumns);
                            console.log('Forecast horizon:', forecastHorizon);
                            console.log('Forecast columns:', forecastColumns);

                            data.forEach((row, rowIdx) => {
                                const rawSkuId = row[mapping.sku_id];
                                // Skip rows with invalid SKU values (copyright notices, footer text, etc.)
                                if (!isValidSku(rawSkuId)) return;

                                const skuId = String(rawSkuId || `SKU_${rowIdx + 1}`);
                                grouped[skuId] = [];

                                // Get Resid_Std for this SKU
                                const residStdVal = row[mapping.resid_std];
                                const residStd = typeof residStdVal === 'number'
                                    ? residStdVal
                                    : parseFloat(String(residStdVal).replace(/,/g, '')) || 0;

                                // Parse each forecast date column (only the last N columns)
                                forecastColumns.forEach((colHeader, idx) => {
                                    const dateObj = parseColDate(colHeader);
                                    if (!dateObj) return;

                                    const forecastVal = row[colHeader];
                                    const p50 = typeof forecastVal === 'number'
                                        ? forecastVal
                                        : parseFloat(String(forecastVal).replace(/,/g, '')) || 0;

                                    // Horizon index h starts from 1 (first forecast day)
                                    const horizonIndex = idx + 1;

                                    // Calculate sigma_h = resid_std * sqrt(h)
                                    const sigmaH = residStd * Math.sqrt(horizonIndex);

                                    // For legacy compatibility, calculate P90 as well
                                    // P90 = P50 + 1.28 * sigma_h (assuming normal distribution)
                                    const p90 = p50 + 1.28 * sigmaH;

                                    const dateStr = dateObj.toISOString().split('T')[0];

                                    if (p50 >= 0) {
                                        grouped[skuId].push({
                                            date: dateStr,
                                            p50,
                                            p90: Math.max(p50, p90), // Ensure p90 >= p50
                                            resid_std: residStd,
                                            horizon_index: horizonIndex
                                        });
                                    }
                                });

                                // Sort by date
                                grouped[skuId].sort((a, b) => new Date(a.date) - new Date(b.date));

                                // Extract parameters from the same row
                                const parseNum = (col) => {
                                    if (!mapping[col]) return null;
                                    const val = row[mapping[col]];
                                    return typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, '')) || null;
                                };

                                // Normalize service level (convert percentage to decimal if > 1)
                                const rawSL = parseNum('target_service_level');
                                const normalizedSL = rawSL != null ? (rawSL > 1 ? rawSL / 100 : rawSL) : null;

                                skuParams[skuId] = {
                                    initialStock: parseNum('initial_stock'),
                                    leadTime: parseNum('lead_time_mean'),
                                    leadTimeStd: parseNum('lead_time_std') ?? 0,
                                    reviewPeriod: parseNum('review_period'),
                                    moqValue: parseNum('min_order_qty') ?? 0,
                                    serviceLevel: normalizedSL
                                };
                            });

                            console.log('Operartis residual format parsed:', Object.keys(grouped).length, 'SKUs');
                            if (Object.keys(grouped).length > 0) {
                                const firstSku = Object.keys(grouped)[0];
                                console.log('Sample data for', firstSku, ':', grouped[firstSku].slice(0, 3));
                            }
                        } else if (mapping.format === 'forecaster') {
                            // === ML-FORECASTER FORMAT (Legacy - P50 only, P90 calculated) ===
                            // Each row is a SKU with date columns as headers (01.01.2026, 01.02.2026, etc.)
                            console.log('Processing ML-FORECASTER format');

                            const dateColumns = mapping.date_columns || [];
                            const varianceFactor = mapping.p90_variance_factor || 1.3;

                            // Parse date column header to actual Date
                            const parseColDate = (colHeader) => {
                                const s = String(colHeader).trim();
                                // Try various date formats
                                // DD.MM.YYYY or DD/MM/YYYY or DD-MM-YYYY
                                let match = s.match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})$/);
                                if (match) {
                                    const day = parseInt(match[1]);
                                    const month = parseInt(match[2]) - 1;
                                    let year = parseInt(match[3]);
                                    if (year < 100) year += 2000;
                                    return new Date(year, month, day);
                                }
                                // YYYY-MM-DD or YYYY.MM.DD
                                match = s.match(/^(\d{4})[.\/-](\d{1,2})[.\/-](\d{1,2})$/);
                                if (match) {
                                    return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                                }
                                // Try generic Date parsing
                                const d = new Date(s);
                                return isNaN(d.getTime()) ? null : d;
                            };

                            data.forEach((row, rowIdx) => {
                                const rawSkuId = row[mapping.sku_id];
                                // Skip rows with invalid SKU values (copyright notices, footer text, etc.)
                                if (!isValidSku(rawSkuId)) return;

                                const skuId = String(rawSkuId || `SKU_${rowIdx + 1}`);
                                grouped[skuId] = [];

                                // Parse each date column
                                dateColumns.forEach(colHeader => {
                                    const dateObj = parseColDate(colHeader);
                                    if (!dateObj) return;

                                    const p50Val = row[colHeader];
                                    const p50 = typeof p50Val === 'number' ? p50Val : parseFloat(String(p50Val).replace(/,/g, '')) || 0;
                                    const p90 = p50 * varianceFactor;

                                    const dateStr = dateObj.toISOString().split('T')[0];

                                    if (p50 > 0) {
                                        grouped[skuId].push({ date: dateStr, p50, p90 });
                                    }
                                });

                                // Sort by date
                                grouped[skuId].sort((a, b) => new Date(a.date) - new Date(b.date));

                                // Extract parameters from the same row if available
                                const parseNum = (col) => {
                                    if (!mapping[col]) return null;
                                    const val = row[mapping[col]];
                                    return typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, '')) || null;
                                };

                                // Normalize service level (convert percentage to decimal if > 1)
                                const rawSL = parseNum('target_service_level');
                                const normalizedSL = rawSL != null ? (rawSL > 1 ? rawSL / 100 : rawSL) : null;

                                skuParams[skuId] = {
                                    initialStock: parseNum('initial_stock'),
                                    leadTime: parseNum('lead_time_mean'),
                                    leadTimeStd: parseNum('lead_time_std') ?? 0,
                                    reviewPeriod: parseNum('review_period'),
                                    moqValue: parseNum('min_order_qty') ?? 0,
                                    serviceLevel: normalizedSL
                                };
                            });

                            console.log('Forecaster format parsed:', Object.keys(grouped).length, 'SKUs');
                        } else {
                            // === VERTICAL FORMAT ===
                            // Each row is a date with P50, P90 columns, grouped by SKU
                            console.log('Processing VERTICAL format');

                            const hasSku = mapping.sku_id && mapping.sku_id !== '';

                            data.forEach((row, idx) => {
                                const rawSkuId = hasSku ? row[mapping.sku_id] : 'ALL_DATA';
                                // Skip rows with invalid SKU values (copyright notices, footer text, etc.)
                                if (hasSku && !isValidSku(rawSkuId)) return;

                                const skuId = hasSku ? String(rawSkuId || 'DEFAULT') : 'ALL_DATA';
                                if (!grouped[skuId]) grouped[skuId] = [];

                                const p50Val = row[mapping.p50];
                                const p90Val = row[mapping.p90];
                                const dateVal = row[mapping.date];


                                const p50 = typeof p50Val === 'number' ? p50Val : parseFloat(String(p50Val).replace(/,/g, '')) || 0;
                                const p90 = typeof p90Val === 'number' ? p90Val : parseFloat(String(p90Val).replace(/,/g, '')) || 0;

                                let dateStr = dateVal;
                                if (dateVal instanceof Date) {
                                    dateStr = dateVal.toISOString().split('T')[0];
                                } else if (typeof dateVal === 'number') {
                                    const excelDate = new Date((dateVal - 25569) * 86400 * 1000);
                                    dateStr = excelDate.toISOString().split('T')[0];
                                }

                                if (p50 > 0 || p90 > 0) {
                                    grouped[skuId].push({
                                        date: dateStr,
                                        p50: p50,
                                        p90: p90 || p50 * 1.3
                                    });
                                }
                            });

                            // Sort each SKU's data by date
                            Object.keys(grouped).forEach(sku => {
                                grouped[sku].sort((a, b) => new Date(a.date) - new Date(b.date));
                            });
                        }

                        console.log('Grouped SKUs:', Object.keys(grouped));
                        Object.keys(grouped).forEach(k => console.log(`  ${k}: ${grouped[k].length} rows`));

                        const skus = Object.keys(grouped).filter(k => grouped[k].length > 0);
                        console.log('Valid SKUs:', skus);

                        if (skus.length === 0) {
                            console.error('No valid data found! Check column mapping.');
                            showToast(t('noValidDataFound'), 'error');
                            // Reset file state to allow re-upload
                            setFile(null);
                            return;
                        }

                        setSkuDataMap(grouped);
                        setSkuList(skus);
                        setCurrentSku(skus[0] || null);
                        setSimResults({});

                        // For vertical format, extract per-SKU parameters from optional columns
                        if (!isHorizontal) {
                            const hasOptionalMappings = mapping.initial_stock || mapping.lead_time_mean || mapping.review_period;
                            const hasSku = mapping.sku_id && mapping.sku_id !== '';

                            if (hasOptionalMappings) {
                                data.forEach(row => {
                                    const skuId = hasSku ? String(row[mapping.sku_id] || 'DEFAULT') : 'ALL_DATA';
                                    if (!skuParams[skuId]) {
                                        const parseNum = (col) => {
                                            if (!mapping[col]) return null;
                                            const val = row[mapping[col]];
                                            return typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, '')) || null;
                                        };

                                        // Normalize service level (convert percentage to decimal if > 1)
                                        const rawSL = parseNum('target_service_level');
                                        const normalizedSL = rawSL != null ? (rawSL > 1 ? rawSL / 100 : rawSL) : null;

                                        skuParams[skuId] = {
                                            initialStock: parseNum('initial_stock'),
                                            leadTime: parseNum('lead_time_mean'),
                                            leadTimeStd: parseNum('lead_time_std') ?? 0,
                                            reviewPeriod: parseNum('review_period'),
                                            moqValue: parseNum('min_order_qty') ?? 0,
                                            serviceLevel: normalizedSL
                                        };
                                    }
                                });
                            }
                        }

                        // If we have per-SKU params (from either format), store and auto-populate
                        if (Object.keys(skuParams).length > 0) {
                            console.log('Extracted SKU parameters:', skuParams);
                            setSkuParamsMap(skuParams);

                            const firstSku = skus[0];
                            if (firstSku && skuParams[firstSku]) {
                                const p = skuParams[firstSku];
                                setParams(prev => ({
                                    ...prev,
                                    initialStock: p.initialStock ?? prev.initialStock,
                                    leadTimeConfig: p.leadTime
                                        ? { ...prev.leadTimeConfig, type: 'deterministic', deterministicValue: p.leadTime }
                                        : prev.leadTimeConfig,
                                    reviewPeriod: p.reviewPeriod ?? prev.reviewPeriod,
                                    serviceLevel: p.serviceLevel ?? prev.serviceLevel,
                                    moqValue: p.moqValue ?? prev.moqValue
                                }));
                                console.log('Auto-populated sidebar with params from', firstSku);
                            }
                        }
                    } catch (err) {
                        console.error('Parse error:', err);
                        showToast(`${t('fileParseError')}: ${err.message}`, 'error');
                        // Reset file state to allow re-upload
                        setFile(null);
                    }
                };
                reader.readAsBinaryString(file);
            };

            // Run Simulation for current SKU (Hybrid: quick preview + Monte Carlo)
            const runSimulation = async () => {
                if (!currentSku || !skuDataMap[currentSku]) return;
                const data = skuDataMap[currentSku];

                try {
                    // Phase 1: Quick deterministic preview via API
                    setIsRunningMC(true);
                    const result = await callTimelineSimulation(currentSku, data, params, apiUrl);
                    setSimResults(prev => ({ ...prev, [currentSku]: result }));
                    setCurrentDay(0);
                    setIsPlaying(false);

                    // Phase 2: Monte Carlo in background
                    const mcResult = await callMonteCarloSimulation(currentSku, data, params, 500, apiUrl);
                    setMcResults(prev => ({ ...prev, [currentSku]: mcResult }));
                    console.log(`Simulation complete for ${currentSku}:`, { timeline: result.metrics, mc: mcResult });
                } catch (error) {
                    console.error('Simulation error:', error);
                    let paramsMsg = error.message;
                    if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                        const isMixedContent = window.location.protocol === 'https:' && apiUrl.startsWith('http:');
                        if (isMixedContent) {
                            paramsMsg = `Mixed Content Blocked: HTTPS frontend cannot access HTTP backend (${apiUrl}). Please use HTTPS backend or run frontend locally (http).`;
                        } else {
                            paramsMsg = `Connection failed to ${apiUrl}. Check backend status.`;
                        }
                    } else if (error.message && error.message.includes('Not Found')) {
                        paramsMsg = `Endpoint verify failed (404). The backend might be running an older version.`;
                    }
                    showToast(`Simulation failed: ${paramsMsg}`, 'error');
                } finally {
                    setIsRunningMC(false);
                }
            };

            // Quick Reload - Run ONLY a single timeline simulation (no Monte Carlo)
            // This is fast for testing different random demand scenarios
            const quickReloadSimulation = async () => {
                if (!currentSku || !skuDataMap[currentSku]) return;
                const data = skuDataMap[currentSku];

                try {
                    setIsReloading(true);
                    setIsPlaying(false);

                    // Get the current effective params
                    // In optimize mode, use the optimal safety factor if available
                    const effectiveParams = { ...params };
                    if (simulationMode === 'optimize' && optimizationResults[currentSku]) {
                        effectiveParams.safetyFactor = optimizationResults[currentSku].optimalSafetyFactor;
                    }

                    // Run single simulation (fast - no Monte Carlo)
                    const result = await callTimelineSimulation(currentSku, data, effectiveParams, apiUrl);
                    setSimResults(prev => ({ ...prev, [currentSku]: result }));
                    setCurrentDay(0);

                    console.log(`Quick reload complete for ${currentSku}`);
                } catch (error) {
                    console.error('Quick reload error:', error);
                    showToast(`Reload failed: ${error.message}`, 'error');
                } finally {
                    setIsReloading(false);
                }
            };

            // Run Optimization for current SKU (Find optimal policy for target Œ±)
            const runOptimization = async () => {
                if (!currentSku || !skuDataMap[currentSku]) return;
                const data = skuDataMap[currentSku];

                try {
                    setIsOptimizing(true);
                    console.log(`Starting optimization for ${currentSku}, target Œ± = ${params.serviceLevel}`);

                    const result = await callPolicyOptimization(currentSku, data, params, apiUrl);

                    // Store optimization result
                    setOptimizationResults(prev => ({ ...prev, [currentSku]: result }));

                    // Also set the simulation result for visualization
                    if (result.timeline) {
                        setSimResults(prev => ({
                            ...prev, [currentSku]: {
                                skuId: result.skuId,
                                timeline: result.timeline,
                                metrics: result.metrics
                            }
                        }));
                        setCurrentDay(0);
                        setIsPlaying(false);
                    }

                    console.log(`Optimization complete for ${currentSku}:`, result);
                } catch (error) {
                    console.error('Optimization error:', error);
                    let paramsMsg = error.message;
                    if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                        const isMixedContent = window.location.protocol === 'https:' && apiUrl.startsWith('http:');
                        if (isMixedContent) {
                            paramsMsg = `Mixed Content Blocked: HTTPS frontend cannot access HTTP backend (${apiUrl}). Please use HTTPS backend or run frontend locally (http).`;
                        } else {
                            paramsMsg = `Connection failed to ${apiUrl}. Check backend status.`;
                        }
                    } else if (error.message && error.message.includes('Not Found')) {
                        paramsMsg = `Endpoint verify failed (404). The backend might be running an older version.`;
                    }
                    showToast(`Optimization failed: ${paramsMsg}`, 'error');
                } finally {
                    setIsOptimizing(false);
                }
            };

            // Run Optimization for ALL SKUs (Parallel via Backend)
            const runAllOptimizations = async () => {
                try {
                    setIsOptimizing(true);
                    console.log(`Starting batch optimization for ${skuList.length} SKUs...`);

                    // Default params template - use current sidebar values as fallback
                    const defaultParams = {
                        initialStock: params.initialStock,
                        leadTimeConfig: params.leadTimeConfig,
                        reviewPeriod: params.reviewPeriod,
                        serviceLevel: params.serviceLevel,
                        safetyFactor: params.safetyFactor,
                        moqValue: params.moqValue
                    };

                    // Build batch request with all SKU params
                    const skuParamsList = [];
                    for (const sku of skuList) {
                        if (skuDataMap[sku]) {
                            // Priority: 1. manualParamsMap (user's sidebar for this SKU), 2. skuParamsMap (from file), 3. defaults
                            const manualParams = manualParamsMap[sku];
                            const fileParams = skuParamsMap[sku] || {};

                            // Get the effective params for this SKU
                            const skuParams = manualParams ? {
                                // User has configured this SKU via sidebar - use their values
                                initialStock: manualParams.initialStock ?? defaultParams.initialStock,
                                leadTimeConfig: manualParams.leadTimeConfig ?? defaultParams.leadTimeConfig,
                                reviewPeriod: manualParams.reviewPeriod ?? defaultParams.reviewPeriod,
                                serviceLevel: manualParams.serviceLevel ?? defaultParams.serviceLevel,
                                safetyFactor: manualParams.safetyFactor ?? defaultParams.safetyFactor,
                                moqValue: manualParams.moqValue ?? defaultParams.moqValue
                            } : {
                                // No manual config - use file params with defaults as fallback
                                ...defaultParams,
                                initialStock: fileParams.initialStock ?? defaultParams.initialStock,
                                leadTimeConfig: fileParams.leadTime != null
                                    ? { ...defaultParams.leadTimeConfig, type: 'deterministic', deterministicValue: fileParams.leadTime }
                                    : defaultParams.leadTimeConfig,
                                reviewPeriod: fileParams.reviewPeriod ?? defaultParams.reviewPeriod,
                                serviceLevel: fileParams.serviceLevel ?? defaultParams.serviceLevel,
                                moqValue: fileParams.moqValue ?? defaultParams.moqValue
                            };

                            // Debug log per-SKU params
                            console.log(`[Optimize] ${sku}: serviceLevel=${skuParams.serviceLevel} (manual=${manualParams?.serviceLevel}, file=${fileParams?.serviceLevel}, default=${defaultParams.serviceLevel})`);

                            // Build lead_time_config for API
                            const ltConfig = skuParams.leadTimeConfig || { type: 'deterministic', deterministicValue: 14 };
                            const apiLeadTimeConfig = {
                                type: ltConfig.type,
                                deterministic_value: ltConfig.deterministicValue || 14,
                                values: ltConfig.type === 'value' ? ltConfig.values?.map(v => ({ value: v.value, probability: v.probability })) : null,
                                poisson_lambda: ltConfig.poissonLambda,
                                binomial_n: ltConfig.binomialN,
                                binomial_p: ltConfig.binomialP,
                                uniform_min: ltConfig.uniformMin,
                                uniform_max: ltConfig.uniformMax
                            };

                            skuParamsList.push({
                                sku_id: sku,
                                initial_stock: skuParams.initialStock,
                                lead_time_config: apiLeadTimeConfig,
                                lead_time_days: ltConfig.deterministicValue || 14,
                                lead_time_std: 0,
                                review_period: skuParams.reviewPeriod,
                                target_service_level: skuParams.serviceLevel,
                                forecast_data: skuDataMap[sku].map(d => ({
                                    date: d.date,
                                    p50: d.p50,
                                    p90: d.p90,
                                    resid_std: d.resid_std ?? null,
                                    horizon_index: d.horizon_index ?? null
                                })),
                                min_order_qty: skuParams.moqValue > 0 ? skuParams.moqValue : null,
                                tolerance: 0.01,
                                max_iterations: 15,
                                num_simulation_runs: 500
                            });
                        }
                    }

                    // Call batch optimization endpoint
                    const response = await fetch(`${apiUrl}/inventory/optimize-batch`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sku_params: skuParamsList })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Batch optimization failed');
                    }

                    const batchResult = await response.json();
                    console.log(`Batch optimization complete: ${batchResult.successful}/${batchResult.total_skus} successful (${batchResult.workers_used} workers)`);

                    // Process results
                    const newResults = {};
                    const newSimResults = {};

                    for (const [skuId, result] of Object.entries(batchResult.results)) {
                        if (result.success) {
                            // Transform to frontend format
                            const frontendResult = {
                                skuId: result.sku_id,
                                targetAlpha: result.target_alpha,
                                achievedAlpha: result.achieved_alpha,
                                achievedBeta: result.achieved_beta,
                                optimalSafetyFactor: result.optimal_safety_factor,
                                avgSt: result.avg_s_t,
                                avgST: result.avg_S_t,
                                recommendedInitialStock: result.recommended_initial_stock,
                                iterationsUsed: result.iterations_used,
                                convergenceAchieved: result.convergence_achieved,
                                mcAvgInventory: result.mc_avg_inventory,
                                mcAvgStockoutDays: result.mc_avg_stockout_days,
                                timeline: result.timeline?.map(t => ({
                                    day: t.day,
                                    date: t.date,
                                    p50: t.p50,
                                    p90: t.p90,
                                    s_t: t.s_t,
                                    S_t: t.S_t,
                                    actualDemand: t.actual_demand,
                                    invBeforeDemand: t.inv_before_demand,
                                    invAfterDemand: t.inv_after_demand,
                                    shortage: t.shortage,
                                    orderPlaced: t.order_placed,
                                    orderQty: t.order_qty,
                                    arrived: t.arrived,
                                    arrivedQty: t.arrived_qty,
                                    backlog: t.backlog,
                                    stockoutEvent: t.stockout_event,
                                    pipelineOrders: t.pipeline_orders,
                                    inventoryPosition: t.inventory_position,
                                    inTransit: t.in_transit,
                                    undershoot: t.undershoot,
                                    isReviewDay: t.is_review_day
                                })),
                                metrics: result.metrics ? {
                                    alpha: result.metrics.alpha,
                                    beta: result.metrics.beta,
                                    avgInventory: result.metrics.avg_inventory,
                                    totalStockouts: result.metrics.total_stockouts,
                                    totalDays: result.metrics.total_days,
                                    alpha_steady: result.metrics.alpha_steady,
                                    beta_steady: result.metrics.beta_steady,
                                    warmup_days: result.metrics.warmup_days,
                                    warmup_stockout_days: result.metrics.warmup_stockout_days,
                                    steady_state_days: result.metrics.steady_state_days
                                } : null
                            };

                            newResults[skuId] = frontendResult;

                            if (frontendResult.timeline) {
                                newSimResults[skuId] = {
                                    skuId: frontendResult.skuId,
                                    timeline: frontendResult.timeline,
                                    metrics: frontendResult.metrics
                                };
                            }
                        } else {
                            console.warn(`SKU ${skuId} optimization failed: ${result.error}`);
                        }
                    }

                    setOptimizationResults(newResults);
                    setSimResults(newSimResults);
                    setCurrentDay(0);
                    setIsPlaying(false);
                    setViewMode('summary');

                    console.log('All optimizations processed');
                } catch (error) {
                    console.error('Batch optimization error:', error);
                    showToast(`Optimization failed: ${error.message}`, 'error');
                } finally {
                    setIsOptimizing(false);
                }
            };

            // Run Simulation for ALL SKUs (Hybrid)
            const runAllSimulations = async () => {
                try {
                    setIsRunningMC(true);

                    // Default params template - use current sidebar values as fallback
                    const defaultParams = {
                        initialStock: params.initialStock,
                        leadTimeConfig: params.leadTimeConfig,
                        reviewPeriod: params.reviewPeriod,
                        serviceLevel: params.serviceLevel,
                        safetyFactor: params.safetyFactor,
                        moqValue: params.moqValue
                    };

                    // Helper function to get params for a SKU
                    const getSkuParams = (sku) => {
                        // Priority: 1. manualParamsMap (user's sidebar for this SKU), 2. skuParamsMap (from file), 3. defaults
                        const manualParams = manualParamsMap[sku];
                        const fileParams = skuParamsMap[sku] || {};

                        return manualParams ? {
                            initialStock: manualParams.initialStock ?? defaultParams.initialStock,
                            leadTimeConfig: manualParams.leadTimeConfig ?? defaultParams.leadTimeConfig,
                            reviewPeriod: manualParams.reviewPeriod ?? defaultParams.reviewPeriod,
                            serviceLevel: manualParams.serviceLevel ?? defaultParams.serviceLevel,
                            safetyFactor: manualParams.safetyFactor ?? defaultParams.safetyFactor,
                            moqValue: manualParams.moqValue ?? defaultParams.moqValue
                        } : {
                            ...defaultParams,
                            initialStock: fileParams.initialStock ?? defaultParams.initialStock,
                            leadTimeConfig: fileParams.leadTime != null
                                ? { ...defaultParams.leadTimeConfig, type: 'deterministic', deterministicValue: fileParams.leadTime }
                                : defaultParams.leadTimeConfig,
                            reviewPeriod: fileParams.reviewPeriod ?? defaultParams.reviewPeriod,
                            serviceLevel: fileParams.serviceLevel ?? defaultParams.serviceLevel,
                            moqValue: fileParams.moqValue ?? defaultParams.moqValue
                        };
                    };

                    // Phase 1: Run timeline simulations for all SKUs
                    const newResults = {};
                    for (const sku of skuList) {
                        if (skuDataMap[sku]) {
                            const skuParams = getSkuParams(sku);
                            console.log(`Simulating ${sku} with params:`, skuParams);
                            const result = await callTimelineSimulation(sku, skuDataMap[sku], skuParams);
                            newResults[sku] = result;
                        }
                    }
                    setSimResults(newResults);
                    setCurrentDay(0);
                    setIsPlaying(false);
                    setViewMode('summary');

                    // Phase 2: Run Monte Carlo for all SKUs
                    const newMcResults = {};
                    for (const sku of skuList) {
                        if (skuDataMap[sku]) {
                            const skuParams = getSkuParams(sku);
                            const mcResult = await callMonteCarloSimulation(sku, skuDataMap[sku], skuParams, 500, apiUrl);
                            newMcResults[sku] = mcResult;
                        }
                    }
                    setMcResults(newMcResults);
                    console.log('All simulations complete:', Object.keys(newMcResults));
                } catch (error) {
                    console.error('Batch simulation error:', error);
                    showToast(`Simulation failed: ${error.message}`, 'error');
                } finally {
                    setIsRunningMC(false);
                }
            };

            // Export Report - Generate Excel report with all simulation results
            const handleExportReport = async () => {
                if (isExporting) return;
                if (Object.keys(simResults).length === 0) {
                    showToast(t('exportError') + ': No simulation results to export', 'warning');
                    return;
                }

                try {
                    setIsExporting(true);

                    // Build export request with all SKU results
                    const skuResultsList = skuList.map(sku => {
                        const simRes = simResults[sku];
                        const mcRes = mcResults[sku];
                        const optRes = optimizationResults[sku];
                        const skuParams = skuParamsMap[sku] || params;
                        const forecastData = skuDataMap[sku] || [];

                        // Build lead time config object
                        const ltConfig = skuParams.leadTimeConfig || params.leadTimeConfig;

                        // Calculate average s_t and S_t from timeline
                        let avgSt = null, avgStCap = null;
                        if (simRes?.timeline?.length > 0) {
                            const stValues = simRes.timeline.map(t => t.s_t).filter(v => v != null);
                            const stCapValues = simRes.timeline.map(t => t.S_t).filter(v => v != null);
                            if (stValues.length > 0) avgSt = stValues.reduce((a, b) => a + b, 0) / stValues.length;
                            if (stCapValues.length > 0) avgStCap = stCapValues.reduce((a, b) => a + b, 0) / stCapValues.length;
                        }

                        return {
                            sku_id: sku,
                            initial_stock: skuParams.initialStock ?? params.initialStock,
                            lead_time_config: {
                                type: ltConfig?.type || 'deterministic',
                                deterministic_value: ltConfig?.deterministicValue || 14,
                                values: ltConfig?.values?.map(v => ({ value: v.value, probability: v.probability })) || null,
                                poisson_lambda: ltConfig?.poissonLambda || null,
                                binomial_n: ltConfig?.binomialN || null,
                                binomial_p: ltConfig?.binomialP || null,
                                uniform_min: ltConfig?.uniformMin || null,
                                uniform_max: ltConfig?.uniformMax || null
                            },
                            review_period: skuParams.reviewPeriod ?? params.reviewPeriod,
                            target_service_level: skuParams.serviceLevel ?? params.serviceLevel,
                            safety_factor: optRes?.optimalSafetyFactor ?? skuParams.safetyFactor ?? params.safetyFactor,
                            min_order_qty: skuParams.moqValue ?? params.moqValue,
                            // Simulation metrics - Use optimization result's achieved values (shown in sidebar)
                            // NOT the single simulation run values (shown in top-right panel)
                            achieved_alpha: optRes?.achievedAlpha ?? simRes?.metrics?.alpha ?? 0,
                            achieved_beta: optRes?.achievedBeta ?? simRes?.metrics?.beta ?? 0,
                            avg_inventory: simRes?.metrics?.avgInventory ?? 0,
                            total_stockouts: simRes?.metrics?.totalStockouts ?? 0,
                            total_days: simRes?.metrics?.totalDays ?? simRes?.timeline?.length ?? 0,
                            // Monte Carlo metrics (from optimization result if available, otherwise from separate MC run)
                            mc_alpha_mean: optRes?.achievedAlpha ?? mcRes?.alpha?.mean ?? null,
                            mc_alpha_p5: mcRes?.alpha?.p5 ?? null,
                            mc_alpha_p95: mcRes?.alpha?.p95 ?? null,
                            mc_beta_mean: optRes?.achievedBeta ?? mcRes?.beta?.mean ?? null,
                            mc_beta_p5: mcRes?.beta?.p5 ?? null,
                            mc_beta_p95: mcRes?.beta?.p95 ?? null,
                            // Monte Carlo avg inventory and stockout days (from optimization's 500 runs)
                            mc_avg_inventory_mean: optRes?.mcAvgInventory ?? mcRes?.avgInventory?.mean ?? null,
                            mc_stockout_days_mean: optRes?.mcAvgStockoutDays ?? mcRes?.stockoutDays?.mean ?? null,
                            // Steady-state metrics
                            alpha_steady: simRes?.metrics?.alpha_steady ?? null,
                            beta_steady: simRes?.metrics?.beta_steady ?? null,
                            warmup_days: simRes?.metrics?.warmup_days ?? null,
                            // Policy values
                            avg_s_t: avgSt,
                            avg_S_t: avgStCap,
                            // Timeline data (convert camelCase to snake_case for backend)
                            timeline: simRes?.timeline?.map(t => ({
                                day: t.day,
                                date: t.date,
                                p50: t.p50,
                                p90: t.p90,
                                s_t: t.s_t,
                                S_t: t.S_t,
                                actual_demand: t.actualDemand,
                                inv_after_demand: t.invAfterDemand,
                                in_transit: t.inTransit,
                                inventory_position: t.inventoryPosition,
                                order_placed: t.orderPlaced,
                                arrived_qty: t.arrivedQty,
                                stockout_event: t.stockoutEvent,
                                backlog: t.backlog
                            })) || null,
                            // Forecast data - strip calculated p90 when using residual-based format
                            forecast_data: forecastData.map(d => {
                                // If data has residual-based uncertainty fields, only export those (not the calculated p90)
                                if (d.resid_std !== undefined && d.horizon_index !== undefined) {
                                    return { date: d.date, p50: d.p50, resid_std: d.resid_std, horizon_index: d.horizon_index };
                                }
                                // Legacy quantile-based format - include p90
                                return { date: d.date, p50: d.p50, p90: d.p90 };
                            })
                        };
                    }).filter(r => r.achieved_alpha > 0 || r.timeline); // Only include SKUs with results

                    const exportRequest = {
                        input_filename: file?.name || 'Inventory_Data',
                        sku_results: skuResultsList,
                        simulation_mode: simulationMode,
                        num_monte_carlo_runs: 500,
                        language: language
                    };

                    console.log('Export request:', exportRequest);

                    // Call export API
                    const response = await fetch(`${apiUrl}/inventory/export-report`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(exportRequest)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Export failed');
                    }

                    // Get filename from response headers
                    let filename = `Operartis_Inventory_Report.xlsx`;
                    const disposition = response.headers.get('Content-Disposition');
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) {
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }

                    // Download the file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    console.log('Export complete:', filename);
                } catch (error) {
                    console.error('Export error:', error);
                    showToast(`${t('exportError')}: ${error.message}`, 'error');
                } finally {
                    setIsExporting(false);
                }
            };

            // SKU Navigation
            const cycleSku = (dir) => {
                if (!skuList.length || !currentSku) return;
                const idx = skuList.indexOf(currentSku);
                let newIdx = idx + dir;
                if (newIdx < 0) newIdx = skuList.length - 1;
                if (newIdx >= skuList.length) newIdx = 0;
                const newSku = skuList[newIdx];
                setCurrentSku(newSku);
                setCurrentDay(0);
                setIsPlaying(false);
                setChartTableView('chart'); // Reset to chart view when changing SKU
            };

            const handleReset = () => {
                setCurrentDay(0);
                setIsPlaying(false);
            };

            const currentDayData = simResult?.timeline[currentDay];
            const isMapped = forecastData && forecastData.length > 0;

            // Lock parameters logic:
            // - In Optimize mode: params are locked based on checkbox selections in mapping modal
            // - In What-If mode: ALL params are always unlocked (editable)
            const isOptimizeMode = simulationMode === 'optimize' && skuList.length > 0;
            const isParamsLocked = isOptimizeMode; // For backward compatibility

            // Individual param lock states (ONLY apply in Optimize mode)
            const isInitialStockLocked = isOptimizeMode && paramsLockState.initial_stock;
            const isLeadTimeLocked = isOptimizeMode && paramsLockState.lead_time_mean;
            const isReviewPeriodLocked = isOptimizeMode && paramsLockState.review_period;
            const isServiceLevelLocked = isOptimizeMode && paramsLockState.target_service_level;
            const isMoqLocked = isOptimizeMode && paramsLockState.min_order_qty;

            // Check if at least one parameter is locked
            const hasAnyParamLocked = isInitialStockLocked || isLeadTimeLocked || isReviewPeriodLocked || isServiceLevelLocked || isMoqLocked;

            return (
                <div className="flex h-full bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-white">
                    {/* Toast Notification */}
                    <Toast
                        message={toast.message}
                        type={toast.type}
                        isVisible={toast.isVisible}
                        onClose={hideToast}
                        t={t}
                    />

                    <MappingModal
                        headers={availableCols}
                        isOpen={isMappingModalOpen}
                        onClose={() => setIsMappingModalOpen(false)}
                        onConfirm={handleMappingConfirm}
                        t={t}
                        fileMetadata={fileMetadata}
                    />

                    {/* SIDEBAR - Glassmorphism */}
                    <div className="absolute inset-y-0 left-0 w-64 bg-white/70 dark:bg-slate-900/70 backdrop-blur-2xl border-r border-white/40 dark:border-white/10 flex flex-col shadow-2xl z-50 ring-1 ring-white/20 dark:ring-white/5 transition-transform duration-300">
                        <div className="h-16 flex items-center justify-center px-4 border-b border-white/50 dark:border-white/10 gap-2 bg-white/50 dark:bg-white/5 relative">
                            <a href="https://operartis.vercel.app/terminal.html">
                                <img src="./icononly_transparent_nobuffer.png" className="h-8 w-8 md:h-10 md:w-10 object-contain cursor-pointer transition-transform hover:scale-110" onError={(e) => e.target.style.display = 'none'} />
                            </a>
                            <h1 className="font-bold text-slate-800 dark:text-slate-100 tracking-tight text-base">OPERARTIS</h1>
                        </div>

                        <div className="flex-1 overflow-y-auto p-3 space-y-4 scroller">
                            {/* Data Source */}
                            <div>
                                <div className="flex items-center gap-2 mb-3">
                                    <h3 className={`text-xs font-bold uppercase tracking-widest ${simulationMode === 'optimize' ? 'text-brand-gold' : 'text-transparent bg-clip-text bg-gradient-to-r from-emerald-500 to-teal-500'}`}>{t('dataSource')}</h3>
                                    <div className={`h-px flex-1 ${simulationMode === 'optimize' ? 'bg-brand-gold/50' : 'bg-gradient-to-r from-emerald-500/50 to-teal-500/50'}`}></div>
                                </div>

                                <div className={`relative border border-dashed rounded-lg px-3 py-4 text-center transition-colors ${file ? 'border-emerald-500 bg-emerald-50/10' : 'border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800'}`}>
                                    <input ref={fileInputRef} type="file" className="hidden" accept=".xlsx,.xls,.csv" onChange={handleFileChange} />
                                    {file ? (
                                        <div className="flex flex-col items-center gap-2">
                                            <div className="flex items-center gap-2 text-xs font-bold text-slate-700 dark:text-slate-200">
                                                <FileIcon />
                                                <span className="truncate max-w-[160px]">{file.name}</span>
                                            </div>
                                            <div className="text-[10px] text-emerald-500 font-bold uppercase">
                                                {skuList.length > 0
                                                    ? `${skuList.length} SKUs ‚Ä¢ ${Object.values(skuDataMap).reduce((sum, arr) => sum + arr.length, 0)} days`
                                                    : 'Mapping required'}
                                            </div>
                                            <div className="flex items-center gap-3">
                                                {/* Change File Icon */}
                                                <button
                                                    onClick={() => fileInputRef.current.click()}
                                                    className="p-1.5 rounded-full text-slate-400 hover:text-brand-gold hover:bg-slate-100 dark:hover:bg-slate-800 transition-all"
                                                    title="Change file"
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                                        <polyline points="17 8 12 3 7 8" />
                                                        <line x1="12" y1="3" x2="12" y2="15" />
                                                    </svg>
                                                </button>
                                                {/* Re-map Columns Icon */}
                                                <button
                                                    onClick={() => setIsMappingModalOpen(true)}
                                                    className="p-1.5 rounded-full text-slate-400 hover:text-cyan-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all"
                                                    title="Re-map columns"
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                        <rect x="3" y="3" width="7" height="7" />
                                                        <rect x="14" y="3" width="7" height="7" />
                                                        <rect x="14" y="14" width="7" height="7" />
                                                        <rect x="3" y="14" width="7" height="7" />
                                                        <path d="M10 7h4" />
                                                        <path d="M17 10v4" />
                                                        <path d="M10 17h4" />
                                                        <path d="M7 10v4" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div onClick={() => fileInputRef.current.click()} className="cursor-pointer flex flex-col items-center gap-2">
                                            <UploadIcon className="w-8 h-8 text-slate-300 dark:text-slate-600" />
                                            <div className="text-xs text-slate-500 font-medium">{t('uploadInputData')}</div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Mode Toggle */}
                            <div className="mb-4">
                                <div className="flex bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm rounded-xl p-1 gap-1 border border-white/30 dark:border-white/5 ring-1 ring-white/10">
                                    <button
                                        onClick={() => setSimulationMode('optimize')}
                                        className={`flex-1 py-2 px-3 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-2 ${simulationMode === 'optimize'
                                            ? 'bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg'
                                            : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'
                                            }`}
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8" /><path d="m21 21-4.35-4.35" /></svg>
                                        {t('optimizeMode')}
                                    </button>
                                    <button
                                        onClick={() => setSimulationMode('whatif')}
                                        className={`flex-1 py-2 px-3 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-2 ${simulationMode === 'whatif'
                                            ? 'bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-lg'
                                            : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'
                                            }`}
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></svg>
                                        {t('whatIfMode')}
                                    </button>
                                </div>
                                <p className="text-[9px] text-slate-400 mt-2 text-center">
                                    {simulationMode === 'optimize'
                                        ? t('optimizeModeDesc')
                                        : t('whatIfModeDesc')
                                    }
                                </p>
                            </div>

                            {/* Interface Section - View Mode Toggle */}
                            <div className="mb-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <h3 className={`text-xs font-bold uppercase tracking-widest ${simulationMode === 'optimize' ? 'text-brand-gold' : 'text-transparent bg-clip-text bg-gradient-to-r from-emerald-500 to-teal-500'}`}>{t('interface')}</h3>
                                    <div className={`h-px flex-1 ${simulationMode === 'optimize' ? 'bg-brand-gold/50' : 'bg-gradient-to-r from-emerald-500/50 to-teal-500/50'}`}></div>
                                </div>
                                <div className="flex bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm rounded-xl p-1 gap-1 border border-white/30 dark:border-white/5 ring-1 ring-white/10">
                                    <button
                                        onClick={() => setViewMode('summary')}
                                        className={`flex-1 py-2 px-3 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-2 ${viewMode === 'summary'
                                            ? (simulationMode === 'optimize' ? 'bg-gradient-to-r from-amber-500 to-orange-500' : 'bg-gradient-to-r from-emerald-500 to-teal-500') + ' text-white shadow-lg'
                                            : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'
                                            }`}
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></svg>
                                        {t('summary')}
                                    </button>
                                    <button
                                        onClick={() => setViewMode('individual')}
                                        className={`flex-1 py-2 px-3 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-2 ${viewMode === 'individual'
                                            ? (simulationMode === 'optimize' ? 'bg-gradient-to-r from-amber-500 to-orange-500' : 'bg-gradient-to-r from-emerald-500 to-teal-500') + ' text-white shadow-lg'
                                            : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'
                                            }`}
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3v18h18" /><path d="m19 9-5 5-4-4-3 3" /></svg>
                                        {t('individual')}
                                    </button>
                                </div>
                            </div>


                            {/* Inventory Policy Section */}
                            <div className="mb-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <h3 className={`text-xs font-bold uppercase tracking-widest ${simulationMode === 'optimize' ? 'text-brand-gold' : 'text-transparent bg-clip-text bg-gradient-to-r from-emerald-500 to-teal-500'}`}>{t('inventoryPolicy')}</h3>
                                    <div className={`h-px flex-1 ${simulationMode === 'optimize' ? 'bg-brand-gold/50' : 'bg-gradient-to-r from-emerald-500/50 to-teal-500/50'}`}></div>
                                </div>
                                <div className="px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-xs font-bold text-black dark:text-white uppercase text-center border border-slate-200 dark:border-slate-700">
                                    {t('stochasticPolicy')}
                                </div>
                            </div>

                            {/* Parameters */}
                            <div className="space-y-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <h3 className={`text-xs font-bold uppercase tracking-widest ${simulationMode === 'optimize' ? 'text-brand-gold' : 'text-transparent bg-clip-text bg-gradient-to-r from-emerald-500 to-teal-500'}`}>{t('parameters')}</h3>
                                    <div className={`h-px flex-1 ${simulationMode === 'optimize' ? 'bg-brand-gold/50' : 'bg-gradient-to-r from-emerald-500/50 to-teal-500/50'}`}></div>
                                    {Object.keys(skuParamsMap).length > 0 && (
                                        <span className="text-[8px] font-bold text-emerald-600 bg-emerald-100 dark:bg-emerald-900/30 px-1.5 py-0.5 rounded" title="Parameters loaded from template file">
                                            AUTO
                                        </span>
                                    )}
                                    {hasAnyParamLocked && (
                                        <span className="text-[8px] font-bold text-amber-600 bg-amber-100 dark:bg-amber-900/30 px-1.5 py-0.5 rounded flex items-center gap-1" title="Switch to What-If mode to edit parameters">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></svg>
                                            LOCKED
                                        </span>
                                    )}
                                </div>

                                {/* Lock notice - only show when at least one param is locked */}
                                {hasAnyParamLocked && (
                                    <div className="text-[9px] text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded px-2 py-1.5 flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></svg>
                                        <span dangerouslySetInnerHTML={{ __html: t('parametersLocked') }} />
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-3">
                                    {/* Initial Stock / Current Stock */}
                                    <div className={isInitialStockLocked ? 'opacity-60' : ''}>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">
                                            {simulationMode === 'optimize' ? t('initialStock').replace('(units)', '') : t('initialStock')}
                                            {isInitialStockLocked && <span className="ml-1 text-emerald-500">üîí</span>}
                                        </label>
                                        <input
                                            type="number"
                                            value={params.initialStock}
                                            onChange={e => {
                                                const val = e.target.value;
                                                setParams({ ...params, initialStock: val === '' ? '' : Math.max(0, Number(val)) });
                                            }}
                                            disabled={isInitialStockLocked}
                                            className={`w-full bg-slate-100 dark:bg-slate-800 rounded px-3 py-2 text-sm font-sans border-0 focus:ring-1 focus:ring-brand-gold outline-none dark:text-white custom-input ${isInitialStockLocked ? 'cursor-not-allowed' : ''}`}
                                        />
                                        {isInitialStockLocked && <span className="text-[8px] text-emerald-500">üîí from file</span>}
                                    </div>

                                    {/* Min Order Quantity - simple input, 0 = no minimum */}
                                    <div className={isMoqLocked ? 'opacity-60' : ''}>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">
                                            {t('minOrderQty')}
                                            {isMoqLocked && <span className="ml-1 text-emerald-500">üîí</span>}
                                        </label>
                                        <input
                                            type="number"
                                            value={params.moqValue}
                                            onChange={e => {
                                                const val = e.target.value;
                                                setParams({ ...params, moqValue: val === '' ? '' : Math.max(0, Number(val)) });
                                            }}
                                            min="0"
                                            step="10"
                                            disabled={isMoqLocked}
                                            className={`w-full bg-slate-100 dark:bg-slate-800 rounded px-3 py-2 text-sm font-sans border-0 focus:ring-1 focus:ring-brand-gold outline-none dark:text-white custom-input ${isMoqLocked ? 'opacity-60 cursor-not-allowed' : ''}`}
                                            placeholder="0"
                                        />
                                        {isMoqLocked && <span className="text-[8px] text-emerald-500">üîí from file</span>}
                                    </div>
                                </div>

                                {/* LEAD TIME CONFIGURATION - Full Section */}
                                <div className={`border border-slate-200 dark:border-slate-700 rounded-lg p-3 ${isLeadTimeLocked ? 'opacity-60' : ''}`}>
                                    <div className="flex items-center justify-between mb-3">
                                        <label className="text-[10px] font-bold text-slate-500 uppercase">
                                            {t('leadTime')}
                                            {isLeadTimeLocked && <span className="ml-1 text-emerald-500">üîí</span>}
                                        </label>
                                    </div>

                                    {isLeadTimeLocked ? (
                                        /* LOCKED: Show simple deterministic value from file */
                                        <div className="text-[10px] font-bold text-slate-500 uppercase">
                                            {t('deterministic')}: <span className="text-brand-gold">{params.leadTimeConfig.deterministicValue} {t('days')}</span>
                                        </div>
                                    ) : (
                                        /* UNLOCKED: Show full configuration UI */
                                        <div className="space-y-3">
                                            {/* Distribution Type Selector */}
                                            <div>
                                                <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">{t('type')}</label>
                                                <select
                                                    value={params.leadTimeConfig.type}
                                                    onChange={e => setParams({
                                                        ...params,
                                                        leadTimeConfig: { ...params.leadTimeConfig, type: e.target.value }
                                                    })}
                                                    className="w-full bg-slate-100 dark:bg-slate-800 rounded px-3 py-2 text-sm font-sans border-0 dark:text-white cursor-pointer custom-select appearance-none"
                                                >
                                                    <option value="deterministic">{t('deterministicFixed')}</option>
                                                    <option value="value">{t('customDiscrete')}</option>
                                                    <option value="poisson">{t('poisson')}</option>
                                                    <option value="binomial">{t('binomial')}</option>
                                                    <option value="uniform">{t('discreteUniform')}</option>
                                                </select>
                                            </div>

                                            {/* DETERMINISTIC: Single value */}
                                            {params.leadTimeConfig.type === 'deterministic' && (
                                                <div>
                                                    <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">{t('valueDays')}</label>
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        value={params.leadTimeConfig.deterministicValue}
                                                        onChange={e => setParams({
                                                            ...params,
                                                            leadTimeConfig: { ...params.leadTimeConfig, deterministicValue: Math.max(1, +e.target.value) }
                                                        })}
                                                        className="w-full bg-slate-100 dark:bg-slate-800 rounded px-3 py-2 text-sm font-sans border-0 focus:ring-1 focus:ring-brand-gold outline-none dark:text-white custom-input"
                                                    />
                                                </div>
                                            )}

                                            {/* CUSTOM DISCRETE: Multiple values with probabilities */}
                                            {params.leadTimeConfig.type === 'value' && (
                                                <div className="space-y-2">
                                                    <div className="flex items-center justify-between">
                                                        <label className="text-[9px] font-bold text-slate-400 uppercase">{t('valuesAndProbabilities')}</label>
                                                        <button
                                                            onClick={() => {
                                                                const newValues = [...params.leadTimeConfig.values, { value: 14, probability: 0 }];
                                                                setParams({
                                                                    ...params,
                                                                    leadTimeConfig: { ...params.leadTimeConfig, values: newValues }
                                                                });
                                                            }}
                                                            className="text-[10px] font-bold text-brand-gold hover:text-brand-gold/80 flex items-center gap-1"
                                                        >
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="16" /><line x1="8" y1="12" x2="16" y2="12" /></svg>
                                                            {t('add')}
                                                        </button>
                                                    </div>

                                                    {params.leadTimeConfig.values.map((v, idx) => (
                                                        <div key={idx} className="flex items-center gap-1.5">
                                                            <input
                                                                type="number"
                                                                min="1"
                                                                value={v.value}
                                                                onChange={e => {
                                                                    const newValues = [...params.leadTimeConfig.values];
                                                                    newValues[idx] = { ...newValues[idx], value: Math.max(1, +e.target.value) };
                                                                    setParams({
                                                                        ...params,
                                                                        leadTimeConfig: { ...params.leadTimeConfig, values: newValues }
                                                                    });
                                                                }}
                                                                className="w-[45%] min-w-0 bg-slate-100 dark:bg-slate-800 rounded px-2 py-2 text-sm font-sans border-0 focus:ring-1 focus:ring-brand-gold outline-none dark:text-white custom-input"
                                                                placeholder="days"
                                                            />
                                                            {params.leadTimeConfig.values.length > 1 && (
                                                                <>
                                                                    <span className="text-[10px] text-slate-400 flex-shrink-0">P:</span>
                                                                    <input
                                                                        type="number"
                                                                        min="0"
                                                                        max="1"
                                                                        step="0.1"
                                                                        value={v.probability}
                                                                        onChange={e => {
                                                                            const newValues = [...params.leadTimeConfig.values];
                                                                            newValues[idx] = { ...newValues[idx], probability: Math.min(1, Math.max(0, +e.target.value)) };
                                                                            setParams({
                                                                                ...params,
                                                                                leadTimeConfig: { ...params.leadTimeConfig, values: newValues }
                                                                            });
                                                                        }}
                                                                        className="w-[35%] min-w-0 bg-slate-100 dark:bg-slate-800 rounded px-2 py-2 text-sm font-sans border-0 focus:ring-1 focus:ring-brand-gold outline-none dark:text-white custom-input"
                                                                        placeholder="prob"
                                                                    />
                                                                    <button
                                                                        onClick={() => {
                                                                            const newValues = params.leadTimeConfig.values.filter((_, i) => i !== idx);
                                                                            setParams({
                                                                                ...params,
                                                                                leadTimeConfig: { ...params.leadTimeConfig, values: newValues }
                                                                            });
                                                                        }}
                                                                        className="text-red-400 hover:text-red-500 flex-shrink-0"
                                                                    >
                                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>
                                                                    </button>
                                                                </>
                                                            )}
                                                        </div>
                                                    ))}

                                                    {/* Probability sum indicator */}
                                                    {params.leadTimeConfig.values.length > 1 && (() => {
                                                        const sum = params.leadTimeConfig.values.reduce((s, v) => s + v.probability, 0);
                                                        const isValid = Math.abs(sum - 1.0) < 0.01;
                                                        return (
                                                            <div className={`text-[9px] font-bold ${isValid ? 'text-emerald-500' : 'text-amber-500'}`}>
                                                                Sum: {sum.toFixed(2)} {isValid ? '‚úì' : '(should be 1.0)'}
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                            )}

                                            {/* POISSON: Lambda parameter */}
                                            {params.leadTimeConfig.type === 'poisson' && (
                                                <div>
                                                    <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Œª (Lambda / Mean)</label>
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        value={params.leadTimeConfig.poissonLambda}
                                                        onChange={e => setParams({
                                                            ...params,
                                                            leadTimeConfig: { ...params.leadTimeConfig, poissonLambda: Math.max(1, +e.target.value) }
                                                        })}
                                                        className="w-full bg-slate-100 dark:bg-slate-800 rounded px-3 py-2 text-sm font-sans border-0 focus:ring-1 focus:ring-brand-gold outline-none dark:text-white custom-input"
                                                    />
                                                    <div className="text-[9px] text-slate-400 mt-1">{t('expectedValueDays')} {params.leadTimeConfig.poissonLambda} {t('days')}</div>
                                                </div>
                                            )}

                                            {/* BINOMIAL: n and p parameters */}
                                            {params.leadTimeConfig.type === 'binomial' && (
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">n (Trials)</label>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            value={params.leadTimeConfig.binomialN}
                                                            onChange={e => setParams({
                                                                ...params,
                                                                leadTimeConfig: { ...params.leadTimeConfig, binomialN: Math.max(1, +e.target.value) }
                                                            })}
                                                            className="w-full bg-slate-100 dark:bg-slate-800 rounded px-3 py-2 text-sm font-sans border-0 focus:ring-1 focus:ring-brand-gold outline-none dark:text-white custom-input"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">p (Probability)</label>
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            max="1"
                                                            step="0.05"
                                                            value={params.leadTimeConfig.binomialP}
                                                            onChange={e => setParams({
                                                                ...params,
                                                                leadTimeConfig: { ...params.leadTimeConfig, binomialP: Math.min(1, Math.max(0, +e.target.value)) }
                                                            })}
                                                            className="w-full bg-slate-100 dark:bg-slate-800 rounded px-3 py-2 text-sm font-sans border-0 focus:ring-1 focus:ring-brand-gold outline-none dark:text-white custom-input"
                                                        />
                                                    </div>
                                                    <div className="col-span-2 text-[9px] text-slate-400">
                                                        {t('expectedValueDays')} {(params.leadTimeConfig.binomialN * params.leadTimeConfig.binomialP).toFixed(1)} {t('days')}
                                                    </div>
                                                </div>
                                            )}

                                            {/* UNIFORM: min and max */}
                                            {params.leadTimeConfig.type === 'uniform' && (
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">{t('minDays')}</label>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            value={params.leadTimeConfig.uniformMin}
                                                            onChange={e => setParams({
                                                                ...params,
                                                                leadTimeConfig: { ...params.leadTimeConfig, uniformMin: Math.max(1, +e.target.value) }
                                                            })}
                                                            className="w-full bg-slate-100 dark:bg-slate-800 rounded px-3 py-2 text-sm font-sans border-0 focus:ring-1 focus:ring-brand-gold outline-none dark:text-white custom-input"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">{t('maxDays')}</label>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            value={params.leadTimeConfig.uniformMax}
                                                            onChange={e => setParams({
                                                                ...params,
                                                                leadTimeConfig: { ...params.leadTimeConfig, uniformMax: Math.max(params.leadTimeConfig.uniformMin, +e.target.value) }
                                                            })}
                                                            className="w-full bg-slate-100 dark:bg-slate-800 rounded px-3 py-2 text-sm font-sans border-0 focus:ring-1 focus:ring-brand-gold outline-none dark:text-white custom-input"
                                                        />
                                                    </div>
                                                    <div className="col-span-2 text-[9px] text-slate-400">
                                                        {t('expectedValueDays')} {((params.leadTimeConfig.uniformMin + params.leadTimeConfig.uniformMax) / 2).toFixed(1)} {t('days')}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                <div className={isReviewPeriodLocked ? 'opacity-60' : ''}>
                                    <label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">
                                        {t('reviewPeriod')}
                                        {isReviewPeriodLocked && <span className="ml-1 text-emerald-500">üîí</span>}
                                    </label>
                                    <select
                                        value={params.reviewPeriod}
                                        onChange={e => setParams({ ...params, reviewPeriod: +e.target.value })}
                                        disabled={isReviewPeriodLocked}
                                        className={`w-full bg-slate-100 dark:bg-slate-800 rounded px-3 py-2 text-sm font-sans border-0 dark:text-white custom-select appearance-none ${isReviewPeriodLocked ? 'cursor-not-allowed' : 'cursor-pointer'}`}
                                    >
                                        <option value="1">{t('daily')}</option>
                                        <option value="7">{t('weekly')}</option>
                                        <option value="14">{t('biWeekly')}</option>
                                        <option value="30">{t('monthly')}</option>
                                    </select>
                                    {isReviewPeriodLocked && <span className="text-[8px] text-emerald-500">üîí from file</span>}
                                </div>

                                <div className={isServiceLevelLocked ? 'opacity-60' : ''}>
                                    <div className="flex justify-between text-xs mb-2">
                                        <span className="font-bold text-slate-500 uppercase text-[10px]">
                                            {t('targetServiceLevel').replace('Œ±', '').replace('Œ±', '')}<span className="normal-case">(Œ±)</span>
                                            {isServiceLevelLocked && <span className="ml-1 text-emerald-500">üîí</span>}
                                        </span>
                                        <span className="font-bold text-brand-gold">{(params.serviceLevel * 100).toFixed(1)}%</span>
                                    </div>
                                    {/* Preset buttons */}
                                    <div className="flex gap-1 mb-2">
                                        {[
                                            { value: 0.84, label: '84%', z: '1.00' },
                                            { value: 0.90, label: '90%', z: '1.28' },
                                            { value: 0.95, label: '95%', z: '1.64' },
                                            { value: 0.975, label: '97.5%', z: '1.96' },
                                            { value: 0.99, label: '99%', z: '2.33' }
                                        ].map(preset => (
                                            <button
                                                key={preset.value}
                                                onClick={() => !isServiceLevelLocked && setParams({ ...params, serviceLevel: preset.value })}
                                                disabled={isServiceLevelLocked}
                                                className={`flex-1 py-1 text-[10px] font-bold rounded transition-all ${Math.abs(params.serviceLevel - preset.value) < 0.01
                                                    ? 'bg-brand-gold text-white'
                                                    : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'
                                                    } ${isServiceLevelLocked ? 'cursor-not-allowed' : ''}`}
                                            >
                                                {preset.label}
                                            </button>
                                        ))}
                                    </div>
                                    <input
                                        type="range"
                                        min="80"
                                        max="99.5"
                                        step="0.5"
                                        value={params.serviceLevel * 100}
                                        onChange={e => setParams({ ...params, serviceLevel: e.target.value / 100 })}
                                        disabled={isServiceLevelLocked}
                                        className={`w-full h-1.5 bg-slate-200 dark:bg-slate-800 rounded-lg appearance-none accent-brand-gold ${isServiceLevelLocked ? 'cursor-not-allowed' : 'cursor-pointer'}`}
                                    />
                                </div>

                                {/* Safety Factor (œÉ Multiplier) - only in What-If mode */}
                                {simulationMode === 'whatif' && (
                                    <div className="space-y-2">
                                        <div className="flex items-center justify-between">
                                            <span className="font-bold text-slate-500 uppercase text-[10px]">{t('safetyFactor')} (œÉ√ó)</span>
                                            <span className="font-bold text-cyan-500">{params.safetyFactor.toFixed(1)}√ó</span>
                                        </div>
                                        <div className="flex gap-1">
                                            {[
                                                { label: '1.0√ó', value: 1.0 },
                                                { label: '1.5√ó', value: 1.5 },
                                                { label: '2.0√ó', value: 2.0 },
                                                { label: '3.0√ó', value: 3.0 }
                                            ].map(preset => (
                                                <button
                                                    key={preset.value}
                                                    onClick={() => setParams({ ...params, safetyFactor: preset.value })}
                                                    className={`flex-1 py-1 text-[10px] font-bold rounded transition-all ${Math.abs(params.safetyFactor - preset.value) < 0.05
                                                        ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/30'
                                                        : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'
                                                        }`}
                                                >
                                                    {preset.label}
                                                </button>
                                            ))}
                                        </div>
                                        <input type="range" min="1.0" max="4.0" step="0.1" value={params.safetyFactor} onChange={e => setParams({ ...params, safetyFactor: parseFloat(e.target.value) })} className="w-full h-1.5 bg-slate-200 dark:bg-slate-800 rounded-lg appearance-none cursor-pointer accent-cyan-500" />
                                        <div className="text-[9px] text-slate-400 mt-1 text-center">
                                            {params.safetyFactor > 1.0 ? `+${((params.safetyFactor - 1) * 100).toFixed(0)}% extra buffer on œÉ` : 'No extra buffer (default)'}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Result Section */}
                            {simulationMode === 'optimize' && optimResult && (
                                <div className="space-y-4">
                                    <div className="flex items-center gap-2 mb-2">
                                        <h3 className="text-xs font-bold text-brand-gold uppercase tracking-widest">{t('result')}</h3>
                                        <div className="h-px bg-brand-gold/50 flex-1"></div>
                                    </div>

                                    <div className="p-4 bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-slate-900 dark:to-slate-800 rounded-2xl border border-emerald-300 dark:border-emerald-500/30 shadow-lg shadow-emerald-500/10">
                                        <div className="flex items-center gap-2 mb-4">
                                            <div className="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgb(16,185,129)]"></div>
                                            <h4 className="text-xs font-black text-emerald-600 dark:text-emerald-400 uppercase tracking-wide">
                                                {optimResult.convergenceAchieved ? t('optimalPolicyFound') : t('bestPolicyFound')}
                                            </h4>
                                        </div>

                                        <div className="space-y-3 text-xs font-medium">
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-500 dark:text-slate-400">{t('targetAlpha')}</span>
                                                <span className="text-slate-800 dark:text-white font-bold">{parseFloat((optimResult.targetAlpha * 100).toFixed(2))}%</span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-500 dark:text-slate-400">{t('achievedAlpha')}</span>
                                                <span className={`font-bold ${optimResult.achievedAlpha >= optimResult.targetAlpha - 0.02 ? 'text-emerald-600 dark:text-emerald-400' : 'text-amber-600 dark:text-amber-400'}`}>
                                                    {(optimResult.achievedAlpha * 100).toFixed(1)}%
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-500 dark:text-slate-400">{t('achievedBeta')}</span>
                                                <span className="font-bold text-blue-600 dark:text-blue-400">{(optimResult.achievedBeta * 100).toFixed(1)}%</span>
                                            </div>

                                            <div className="h-px bg-emerald-300 dark:bg-emerald-500/20 my-2"></div>

                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-500 dark:text-slate-400">{t('safetyFactor')}</span>
                                                <span className="font-bold text-cyan-600 dark:text-cyan-400">{typeof optimResult.optimalSafetyFactor === 'number' ? optimResult.optimalSafetyFactor.toFixed(2) : optimResult.optimalSafetyFactor}√ó</span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-500 dark:text-slate-400">{t('avgReorderPoint')}</span>
                                                <span className="font-bold text-orange-600 dark:text-orange-400 font-mono">{optimResult.avgSt?.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })}</span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-500 dark:text-slate-400">{t('avgOrderUpTo')}</span>
                                                <span className="font-bold text-red-600 dark:text-red-400 font-mono">{optimResult.avgST?.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })}</span>
                                            </div>

                                            {/* MC Avg Inventory and Stockout Days - from optimization result */}
                                            {(optimResult.mcAvgInventory != null || optimResult.mcAvgStockoutDays != null) && (
                                                <>
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-slate-500 dark:text-slate-400">{t('avgInv')}</span>
                                                        <span className="font-bold text-purple-600 dark:text-purple-400 font-mono">{optimResult.mcAvgInventory?.toLocaleString(undefined, { maximumFractionDigits: 0 })}</span>
                                                    </div>
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-slate-500 dark:text-slate-400">{t('avgStockoutDays')}</span>
                                                        <span className="font-bold text-rose-600 dark:text-rose-400 font-mono">{optimResult.mcAvgStockoutDays?.toFixed(1)}</span>
                                                    </div>
                                                </>
                                            )}

                                            <div className="h-px bg-emerald-300 dark:bg-emerald-500/20 my-2"></div>

                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-500 dark:text-slate-400">{t('recommendedInitialStock')}</span>
                                                <span className="font-bold text-emerald-600 dark:text-emerald-400 text-sm font-mono">{optimResult.recommendedInitialStock?.toLocaleString()}</span>
                                            </div>
                                        </div>

                                        <div className="mt-4 text-[10px] text-slate-400 dark:text-slate-500 text-center font-medium">
                                            {t('foundInIterations').replace('{0}', optimResult.iterationsUsed)}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* SKU Navigator */}
                            {skuList.length > 0 && (
                                <div className="space-y-3">
                                    <div className="flex items-center gap-2 mb-2">
                                        <h3 className={`text-xs font-bold uppercase tracking-widest ${simulationMode === 'optimize' ? 'text-brand-gold' : 'text-transparent bg-clip-text bg-gradient-to-r from-emerald-500 to-teal-500'}`}>{t('skuNavigator')}</h3>
                                        <div className={`h-px flex-1 ${simulationMode === 'optimize' ? 'bg-brand-gold/50' : 'bg-gradient-to-r from-emerald-500/50 to-teal-500/50'}`}></div>
                                    </div>
                                    <div className="flex items-center gap-2 overflow-hidden">
                                        <button onClick={() => cycleSku(-1)} className="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6" /></svg>
                                        </button>
                                        <div className="flex-1 min-w-0 h-8 bg-slate-100 dark:bg-slate-800 rounded flex items-center relative">
                                            <select
                                                value={currentSku || ''}
                                                onChange={e => { setCurrentSku(e.target.value); setCurrentDay(0); setIsPlaying(false); }}
                                                className="w-full h-full bg-transparent px-2 pr-7 text-xs font-bold border-0 cursor-pointer dark:text-white text-center truncate appearance-none"
                                                style={{ textAlignLast: 'center' }}
                                            >
                                                {skuList.map(sku => <option key={sku} value={sku}>{sku}</option>)}
                                            </select>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="absolute right-2 pointer-events-none text-slate-500 dark:text-white"><path d="M6 9l6 6 6-6" /></svg>
                                        </div>
                                        <button onClick={() => cycleSku(1)} className="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6" /></svg>
                                        </button>
                                    </div>
                                    <div className="text-center text-[10px] text-slate-400">
                                        {skuList.indexOf(currentSku) + 1} of {skuList.length} SKUs ‚Ä¢ {forecastData?.length || 0} days
                                    </div>
                                </div>
                            )}

                            {/* Action Buttons - at bottom of scrollable content */}
                            <div className="pt-4 space-y-2">
                                {simulationMode === 'optimize' ? (
                                    <>
                                        <button
                                            onClick={runOptimization}
                                            disabled={!currentSku || isOptimizing}
                                            className="w-full py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl shadow-lg shadow-amber-500/20 hover:shadow-amber-500/40 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2 uppercase tracking-wide text-xs disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                                        >
                                            {isOptimizing ? (
                                                <>
                                                    <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                    {t('optimizing')}
                                                </>
                                            ) : (
                                                <>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8" /><path d="m21 21-4.35-4.35" /></svg>
                                                    {t('findOptimalPolicy')}
                                                </>
                                            )}
                                        </button>
                                        {skuList.length > 1 && (
                                            <button onClick={runAllOptimizations} disabled={isOptimizing} className="w-full py-2 text-xs font-bold text-slate-500 hover:text-amber-500 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-amber-500 transition-colors disabled:opacity-50">
                                                {t('optimizeAll')} ({skuList.length} SKUs)
                                            </button>
                                        )}
                                    </>
                                ) : (
                                    <>
                                        <button
                                            onClick={runSimulation}
                                            disabled={!currentSku || isRunningMC}
                                            className="w-full py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2 uppercase tracking-wide text-xs disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                                        >
                                            {isRunningMC ? (
                                                <>
                                                    <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                    {t('simulating')}
                                                </>
                                            ) : (
                                                <>
                                                    <RefreshIcon />
                                                    {t('runSimulation')}
                                                </>
                                            )}
                                        </button>
                                        {skuList.length > 1 && (
                                            <button onClick={runAllSimulations} disabled={isRunningMC} className="w-full py-2 text-xs font-bold text-slate-500 hover:text-emerald-500 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-emerald-500 transition-colors disabled:opacity-50">
                                                {t('simulateAll')} ({skuList.length} SKUs)
                                            </button>
                                        )}
                                    </>

                                )}

                                <div className="pt-2 border-t border-slate-100 dark:border-slate-800/50 mt-2">
                                    <button
                                        onClick={() => {
                                            // Reset all state to initial values
                                            setFile(null);
                                            setSkuList([]);
                                            setCurrentSku(null);
                                            setSkuDataMap({});
                                            setSkuParamsMap({});
                                            setSimResults({});
                                            setOptimizationResults({});
                                            setMcResults({});
                                            setParamsLockState({});
                                            setParams({
                                                initialStock: 500,
                                                leadTimeConfig: {
                                                    type: 'deterministic',
                                                    deterministicValue: 14,
                                                    values: [{ value: 14, probability: 1.0 }],
                                                    poissonLambda: 14,
                                                    binomialN: 20,
                                                    binomialP: 0.7,
                                                    uniformMin: 7,
                                                    uniformMax: 21
                                                },
                                                reviewPeriod: 7,
                                                serviceLevel: 0.95,
                                                safetyFactor: 1.0,
                                                moqValue: 0,
                                                reorderPoint: 0,
                                                orderUpToLevel: 0
                                            });
                                            setCurrentDay(0);
                                            setIsPlaying(false);
                                            setViewMode('individual');
                                        }}
                                        className="w-full py-2 text-xs font-bold text-slate-400 hover:text-red-500 border border-transparent hover:border-red-200 dark:hover:border-red-900/30 rounded-lg transition-colors flex items-center justify-center gap-2"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" /><path d="M3 3v9h9" /></svg>
                                        {t('resetAll')}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Sidebar Footer */}
                        <div className="p-4 border-t border-white/20 dark:border-white/10 bg-white/50 dark:bg-white/5 text-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)] z-10">
                            <p className="text-xs font-bold text-slate-700 dark:text-slate-200 uppercase tracking-wide">Operartis Analytics</p>
                            <p className="text-[10px] text-brand-gold mt-1 font-medium italic">Optimizing Today, Growing Tomorrow</p>
                        </div>
                    </div>

                    {/* MAIN CONTENT - Padded left to accommodate fixed sidebar */}
                    <div className="flex-1 flex flex-col overflow-hidden relative bg-slate-50/50 dark:bg-black/20 pl-64 transition-all duration-300">
                        {/* Header - Glassmorphism */}
                        <div className="h-16 bg-white/60 dark:bg-slate-900/60 backdrop-blur-2xl border-b border-white/50 dark:border-white/10 flex items-center justify-between px-6 z-10 ring-1 ring-white/20 dark:ring-white/5 shadow-sm relative">
                            {/* Centered Title */}
                            <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-brand-gold to-brand-dark uppercase tracking-widest whitespace-nowrap">
                                INVENTORY OPTIMIZER
                            </div>
                            <div className="flex items-center gap-3">
                                <div className={`w-2 h-2 rounded-full ${isPlaying ? 'bg-emerald-500 animate-pulse' : simResult ? 'bg-amber-500' : 'bg-slate-400'}`}></div>
                                <span className="text-xs font-bold uppercase tracking-widest text-slate-500">
                                    {isPlaying ? (t ? t('statusSimulating') : 'Simulating...') : simResult ? (t ? t('statusReadyToPlay') : 'Ready to Play') : (t ? t('statusAwaitingSetup') : 'Awaiting Setup')}
                                </span>
                            </div>
                            <div className="flex items-center gap-4">
                                {/* Connection Status Indicator */}
                                <div className={`flex items-center gap-1.5 px-2 py-1 rounded-md border ${connectionStatus === 'local' ? 'bg-emerald-50 text-emerald-600 border-emerald-200 dark:bg-emerald-900/20 dark:text-emerald-400 dark:border-emerald-800' : 'bg-sky-50 text-sky-600 border-sky-200 dark:bg-sky-900/20 dark:text-sky-400 dark:border-sky-800'}`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="20" height="8" x="2" y="2" rx="2" ry="2" /><rect width="20" height="8" x="2" y="14" rx="2" ry="2" /><line x1="6" x2="6.01" y1="6" y2="6" /><line x1="6" x2="6.01" y1="18" y2="18" /></svg>
                                    <span className="text-[10px] font-bold uppercase">{connectionStatus === 'local' ? 'LOCAL' : connectionStatus === 'cloud' ? 'CLOUD' : '...'}</span>
                                </div>
                                {/* Export Report Button */}
                                {Object.keys(simResults).length > 0 && (
                                    <button
                                        onClick={handleExportReport}
                                        disabled={isExporting}
                                        className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-all ${isExporting
                                            ? 'bg-slate-100 text-slate-400 border-slate-200 cursor-wait dark:bg-slate-800 dark:text-slate-500 dark:border-slate-700'
                                            : 'bg-brand-gold/10 text-brand-gold border-brand-gold/30 hover:bg-brand-gold/20 hover:border-brand-gold/50'
                                            }`}
                                        title={t('exportReport')}
                                    >
                                        {isExporting ? (
                                            <LoaderIcon />
                                        ) : (
                                            <DownloadIcon />
                                        )}
                                        <span className="text-xs font-bold">{isExporting ? t('exporting') : t('exportReport')}</span>
                                    </button>
                                )}
                                {/* Language Toggle */}
                                <button
                                    onClick={() => setLanguage(language === 'en' ? 'vi' : 'en')}
                                    className="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 transition-colors flex items-center gap-1"
                                    title={language === 'en' ? 'Switch to Vietnamese' : 'Chuy·ªÉn sang Ti·∫øng Anh'}
                                >
                                    <GlobeIcon />
                                    <span className="text-[10px] font-bold uppercase">{language === 'en' ? 'üá¨üáß EN' : 'üáªüá≥ VI'}</span>
                                </button>
                                {/* Theme Toggle */}
                                <button onClick={() => setTheme(isDark ? 'light' : 'dark')} className="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 transition-colors">
                                    {isDark ? <SunIcon /> : <MoonIcon />}
                                </button>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="flex-1 p-6 overflow-hidden flex flex-col gap-4">
                            {/* Loading state takes priority - always show when processing */}
                            {(isOptimizing || isRunningMC) ? (
                                <div className="flex-1 flex flex-col items-center justify-center text-slate-300 dark:text-slate-600">
                                    <div className="relative w-28 h-28 flex items-center justify-center mb-8">
                                        {/* Dynamic Dashed Cycle Effect */}
                                        {/* Layer 1: Grey base dashed ring - Slow spin */}
                                        <div className="absolute inset-0 rounded-full border-4 border-dashed border-slate-300 dark:border-slate-700 animate-[spin_10s_linear_infinite]"></div>

                                        {/* Layer 2: Colored dashed segment - Fast spin (Gold for optimize, Emerald for what-if) */}
                                        <div className={`absolute inset-0 rounded-full border-4 border-dashed border-t-transparent border-l-transparent opacity-80 animate-spin ${isOptimizing ? 'border-brand-gold' : 'border-emerald-500'}`}></div>

                                        {/* Rolling Box Effect */}
                                        <div className="animate-[spin_3s_linear_infinite_reverse]">
                                            <svg xmlns="http://www.w3.org/2000/svg" className={`w-14 h-14 ${isOptimizing ? 'text-brand-gold' : 'text-emerald-500'}`} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                            </svg>
                                        </div>
                                    </div>
                                    <h2 className={`text-2xl font-black uppercase tracking-widest text-transparent bg-clip-text animate-pulse ${isOptimizing ? 'bg-gradient-to-r from-brand-gold to-brand-dark' : 'bg-gradient-to-r from-emerald-500 to-teal-500'}`}>
                                        {isOptimizing ? t('optimizing') : t('simulating')}
                                    </h2>
                                </div>
                            ) : viewMode === 'summary' && hasAllResults ? (
                                <SummaryDashboard
                                    skuList={skuList}
                                    simResults={simResults}
                                    mcResults={mcResults}
                                    optimizationResults={optimizationResults}
                                    simulationMode={simulationMode}
                                    onSelectSku={(sku) => { setCurrentSku(sku); setViewMode('individual'); setCurrentDay(0); }}
                                    isDark={isDark}
                                    isRunningMC={isRunningMC}
                                    t={t}
                                />
                            ) : !simResult ? (
                                <div className="flex-1 flex flex-col items-center justify-center text-slate-300 dark:text-slate-600">
                                    <div className="w-24 h-24 border-4 border-dashed rounded-full flex items-center justify-center mb-6 opacity-30">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="w-14 h-14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                        </svg>
                                    </div>
                                    <h2 className="text-2xl font-black uppercase tracking-widest text-slate-400 dark:text-slate-500">{t('readyToSimulate')}</h2>
                                    <p className="text-sm text-slate-400 mt-2">{t('loadDataPrompt')}</p>
                                </div>
                            ) : (
                                <>
                                    {/* Real-Time Status Panel */}
                                    <RealTimePanel currentDayData={currentDayData} params={params} isPlaying={isPlaying} t={t} />

                                    {/* Chart/Table Container - Glassmorphism with Slide Transition */}
                                    <div className="flex-1 bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl rounded-2xl border border-white/50 dark:border-white/10 shadow-lg ring-1 ring-white/50 dark:ring-white/5 p-4 min-h-0 overflow-hidden relative">
                                        {/* Slide Container - 200% width to hold both views side by side */}
                                        <div
                                            className="flex h-full transition-transform duration-500 ease-in-out"
                                            style={{
                                                width: '200%',
                                                transform: chartTableView === 'table' ? 'translateX(-50%)' : 'translateX(0)'
                                            }}
                                        >
                                            {/* Chart View - 50% of slide container = 100% of visible area */}
                                            <div className="w-1/2 h-full flex-shrink-0 flex flex-col pr-4">
                                                <div className="flex justify-between items-center mb-3 relative">
                                                    {/* Left: SKU Name + Date */}
                                                    <div className="flex items-center gap-3">
                                                        {/* SKU Name - Glassmorphism Box */}
                                                        <div className="flex items-center gap-2 bg-slate-100/80 dark:bg-slate-800/50 backdrop-blur-md px-3 py-1.5 rounded-xl border border-slate-200 dark:border-white/10 shadow">
                                                            {skuList.length > 1 && (
                                                                <button onClick={() => cycleSku(-1)} className="p-0.5 hover:bg-white/50 dark:hover:bg-slate-700/50 rounded text-slate-400 transition-colors">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6" /></svg>
                                                                </button>
                                                            )}
                                                            <h3 className="font-bold text-slate-800 dark:text-slate-100">{currentSku || t('liveInventorySimulation')}</h3>
                                                            {skuList.length > 1 && (
                                                                <button onClick={() => cycleSku(1)} className="p-0.5 hover:bg-white/50 dark:hover:bg-slate-700/50 rounded text-slate-400 transition-colors">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6" /></svg>
                                                                </button>
                                                            )}
                                                        </div>

                                                        {/* Date & Day - Glassmorphism Box */}
                                                        <div className="bg-slate-100/80 dark:bg-slate-800/50 backdrop-blur-md px-3 py-1.5 rounded-xl border border-slate-200 dark:border-white/10 shadow">
                                                            <span className="text-xs font-medium text-slate-600 dark:text-slate-300">
                                                                {currentDayData?.date} ‚Ä¢ <span className="text-brand-gold font-bold">{t('day')} {currentDay + 1}</span>
                                                            </span>
                                                        </div>
                                                    </div>

                                                    {/* Center: Live Inventory Simulation Title - Glassmorphism Box */}
                                                    <div className="absolute left-1/2 transform -translate-x-1/2 bg-slate-100/80 dark:bg-slate-800/50 backdrop-blur-md px-3 py-1.5 rounded-xl border border-slate-200 dark:border-white/10 shadow">
                                                        <span className="text-xs font-bold text-brand-gold uppercase tracking-wide">{t('liveInventorySimulation')}</span>
                                                    </div>

                                                    {/* Right: Metrics */}
                                                    {simResult && (
                                                        <div className="flex gap-3 text-xs bg-slate-100/80 dark:bg-slate-800/50 backdrop-blur-md px-4 py-2 rounded-xl border border-slate-200 dark:border-white/10 shadow">
                                                            <div className="text-center border-r border-slate-300/50 dark:border-slate-600/50 pr-3">
                                                                <div className="text-[9px] text-slate-500 dark:text-slate-400 mb-0.5">{t('alphaFull')}</div>
                                                                <div className={`font-bold ${simResult.metrics.alpha >= 0.9 ? 'text-emerald-500' : simResult.metrics.alpha >= 0.7 ? 'text-amber-500' : 'text-red-500'}`}>
                                                                    {(simResult.metrics.alpha * 100).toFixed(1)}%
                                                                </div>
                                                            </div>
                                                            <div className="text-center border-r border-slate-300/50 dark:border-slate-600/50 pr-3">
                                                                <div className="text-[9px] text-slate-500 dark:text-slate-400 mb-0.5">{t('betaFull')}</div>
                                                                <div className={`font-bold ${simResult.metrics.beta >= 0.9 ? 'text-emerald-500' : simResult.metrics.beta >= 0.7 ? 'text-amber-500' : 'text-red-500'}`}>
                                                                    {(simResult.metrics.beta * 100).toFixed(1)}%
                                                                </div>
                                                            </div>
                                                            {simResult.metrics.alpha_steady !== undefined && (
                                                                <>
                                                                    <div className="text-center border-r border-slate-300/50 dark:border-slate-600/50 pr-3">
                                                                        <div className="text-[9px] text-blue-400 mb-0.5">{t('alphaSteady')}</div>
                                                                        <div className={`font-bold ${simResult.metrics.alpha_steady >= 0.9 ? 'text-emerald-500' : simResult.metrics.alpha_steady >= 0.7 ? 'text-amber-500' : 'text-red-500'}`}>
                                                                            {(simResult.metrics.alpha_steady * 100).toFixed(1)}%
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-center border-r border-slate-300/50 dark:border-slate-600/50 pr-3">
                                                                        <div className="text-[9px] text-blue-400 mb-0.5">{t('betaSteady')}</div>
                                                                        <div className={`font-bold ${simResult.metrics.beta_steady >= 0.9 ? 'text-emerald-500' : simResult.metrics.beta_steady >= 0.7 ? 'text-amber-500' : 'text-red-500'}`}>
                                                                            {(simResult.metrics.beta_steady * 100).toFixed(1)}%
                                                                        </div>
                                                                    </div>
                                                                </>
                                                            )}
                                                            <div className="text-center">
                                                                <div className="text-[9px] text-slate-500 dark:text-slate-400 mb-0.5">{t('avgInv')}</div>
                                                                <div className="font-bold text-slate-700 dark:text-slate-300">{Math.round(simResult.metrics.avgInventory).toLocaleString()}</div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Stockout Warning */}
                                                {simResult?.metrics?.warmup_stockout_days > 0 && (
                                                    <div className="mb-2 text-xs text-amber-600 dark:text-amber-400 flex items-center gap-1">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></svg>
                                                        {t('warmupStockoutWarning').replace('{0}', simResult.metrics.warmup_stockout_days).replace('{1}', simResult.metrics.warmup_days || 21)}
                                                    </div>
                                                )}

                                                {/* Chart */}
                                                <div className="flex-1 min-h-0 relative">
                                                    <LiveSimulationChart
                                                        timeline={simResult.timeline}
                                                        currentDay={currentDay}
                                                        isDark={isDark}
                                                        reviewPeriod={params.reviewPeriod}
                                                        t={t}
                                                    />
                                                </div>
                                            </div>

                                            {/* Table View - 50% of slide container = 100% of visible area */}
                                            <div className="w-1/2 h-full flex-shrink-0 pl-4">
                                                <StatisticalTable
                                                    simResult={simResult}
                                                    currentDay={currentDay}
                                                    onBack={() => setChartTableView('chart')}
                                                    t={t}
                                                />
                                            </div>
                                        </div>

                                        {/* Toggle Button - Fixed on Right Edge */}
                                        <button
                                            onClick={() => setChartTableView(chartTableView === 'chart' ? 'table' : 'chart')}
                                            className={`absolute right-0 top-1/2 -translate-y-1/2 z-20 p-3 rounded-l-xl transition-all shadow-lg ${chartTableView === 'chart'
                                                ? 'bg-brand-gold hover:bg-brand-dark text-white'
                                                : 'bg-slate-700 hover:bg-slate-600 text-white'
                                                }`}
                                            title={chartTableView === 'chart' ? (t ? t('viewTable') : 'View Statistical Table') : (t ? t('viewChart') : 'View Chart')}
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className={`transition-transform duration-300 ${chartTableView === 'table' ? 'rotate-180' : ''}`}>
                                                <polyline points="9 18 15 12 9 6" />
                                            </svg>
                                        </button>
                                    </div>

                                    {/* Playback Controls */}
                                    <PlaybackControls
                                        isPlaying={isPlaying}
                                        setIsPlaying={setIsPlaying}
                                        speed={speed}
                                        setSpeed={setSpeed}
                                        currentDay={currentDay}
                                        setCurrentDay={setCurrentDay}
                                        maxDays={simResult.timeline.length}
                                        onReset={handleReset}
                                        onReload={quickReloadSimulation}
                                        isReloading={isReloading}
                                        t={t}
                                    />
                                </>
                            )}
                        </div>
                    </div>
                </div >
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>