<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERARTIS | Sales Forecaster</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Google Fonts (Inter for a modern look) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 3. React & Libraries -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/1.8.5/Recharts.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles for Gradients and Fonts -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* The Perartis Gold Gradient for Buttons */
        .btn-gold {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            color: white;
            transition: all 0.3s ease;
        }
        .btn-gold:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
        }
        .btn-gold:disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
        }

        /* Soft Card Styling */
        .glass-card {
            background: white;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            border-radius: 1rem;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

    <div id="root" class="flex-grow"></div>

    <!-- Elegant Footer -->
    <footer class="bg-white border-t border-slate-100 py-6 mt-12">
        <div class="max-w-6xl mx-auto px-6 flex justify-between items-center">
            <div class="text-xs text-slate-400 font-medium">
                &copy; 2025 OPERARTIS. All rights reserved.
            </div>
            <div class="text-xs text-slate-300 font-mono">
                System Version 2.1
            </div>
        </div>
    </footer>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const Recharts = window.Recharts || {};
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Area, AreaChart, ComposedChart } = Recharts;

        // --- CUSTOM DOTS ---
        const CustomForecastDot = (props) => {
            const { cx, cy, payload } = props;
            if (payload && payload.name && payload.name.includes("(fc)")) {
                return <circle cx={cx} cy={cy} r={3} stroke="#10b981" strokeWidth={2} fill="white" />;
            }
            return null;
        };

        const CustomFittedDot = (props) => {
            const { cx, cy, payload } = props;
            if (payload && payload.forecast !== undefined && !payload.name.includes("(fc)")) {
                 return <circle cx={cx} cy={cy} r={3} stroke="#8b5cf6" strokeWidth={2} fill="white" />;
            }
            return null;
        };

        // --- CUSTOM TOOLTIP ---
        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                const isFuture = label && label.includes("(fc)");
                return (
                    <div className="bg-white p-4 border border-slate-100 shadow-xl rounded-xl text-sm opacity-95">
                        <p className="font-bold mb-3 text-slate-800 border-b border-slate-100 pb-2">{label}</p>
                        {payload.map((entry, index) => {
                            if (entry.name === "Forecast" && !isFuture) return null;
                            return (
                                <p key={index} style={{ color: entry.color }} className="flex items-center gap-3 mb-1.5 last:mb-0 font-medium">
                                    <span className="w-2.5 h-2.5 rounded-full shadow-sm" style={{ backgroundColor: entry.color }}></span>
                                    <span className="uppercase text-xs tracking-wider text-slate-500 w-20">{entry.name}</span> 
                                    <span className="text-base">{entry.value}</span>
                                </p>
                            );
                        })}
                    </div>
                );
            }
            return null;
        };

        // --- MODERN ICONS ---
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 text-amber-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>;
        const IconFile = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>;
        const IconActivity = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 text-emerald-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;

        const App = () => {
            const [file, setFile] = useState(null);
            const [modelType, setModelType] = useState("auto");
            const [isLoading, setIsLoading] = useState(false);
            const [resultData, setResultData] = useState(null);
            const [error, setError] = useState(null);
            const [isDragging, setIsDragging] = useState(false);

            // --- Handlers (Same as before) ---
            const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
            const handleDragLeave = () => { setIsDragging(false); };
            const handleDrop = (e) => { e.preventDefault(); setIsDragging(false); if (e.dataTransfer.files[0]) validateAndSetFile(e.dataTransfer.files[0]); };
            const handleFileSelect = (e) => { if (e.target.files[0]) validateAndSetFile(e.target.files[0]); };

            const validateAndSetFile = (uploadedFile) => {
                setError(null);
                setResultData(null);
                const validExtensions = /\.(xlsx|xls)$/i;
                if (!uploadedFile.name.match(validExtensions)) {
                    setError("Invalid file type. Please upload an Excel file (.xlsx or .xls).");
                    return;
                }
                setFile(uploadedFile);
            };

            const clearFile = (e) => { e.stopPropagation(); setFile(null); setResultData(null); setError(null); document.getElementById('fileInput').value = ''; };

            const handleProcess = async () => {
                if (!file) return;
                setIsLoading(true);
                setError(null);
                const formData = new FormData();
                formData.append('file', file);
                formData.append('model_type', modelType);

                try {
                    const LOCAL_API = 'http://127.0.0.1:8000/predict';
                    const PROD_API = 'https://sales-forecaster-backend.onrender.com/predict';
                    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
                    const apiUrl = isLocal ? LOCAL_API : PROD_API;

                    const response = await fetch(apiUrl, { method: 'POST', body: formData });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.detail || "Failed to process file.");
                    setResultData(data);
                } catch (err) {
                    console.error("Upload Error:", err);
                    if (err.message === "The uploaded file does not satisfy the requirements above") setError(err.message);
                    else setError(err.message + " (Check Connection)");
                    setResultData(null);
                } finally { setIsLoading(false); }
            };

            return (
                <div className="max-w-7xl mx-auto w-full">
                    
                    {/* --- HEADER WITH LOGO --- */}
                    <header className="bg-white shadow-sm border-b border-slate-100 py-4 px-6 md:px-8 mb-10 rounded-b-2xl mx-4 md:mx-0">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            
                            {/* Logo Section */}
                            <div className="flex items-center gap-4">
                                <div className="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                    {/* MAKE SURE YOUR FILE IS NAMED EXACTLY THIS */}
                                    <img src="./fulllogo_transparent.png" alt="Perartis Logo" className="h-12 md:h-14 object-contain" />
                                </div>
                                <div className="hidden md:block h-10 w-px bg-slate-200 mx-2"></div>
                                <div className="flex flex-col justify-center">
                                    <h1 className="text-xl font-bold text-slate-800 tracking-tight">Sales Forecaster</h1>
                                    <p className="text-xs font-semibold text-amber-500 tracking-wide uppercase">OPTIMIZING TODAY, GROWING TOMORROW</p>
                                </div>
                            </div>

                            {/* Status Badge */}
                            <div className="flex items-center gap-2 bg-emerald-50 text-emerald-700 px-4 py-2 rounded-full border border-emerald-100 shadow-sm">
                                <span className="relative flex h-2.5 w-2.5">
                                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                  <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span>
                                </span>
                                <span className="text-xs font-bold tracking-wide">SYSTEM READY</span>
                            </div>
                        </div>
                    </header>

                    {/* --- MAIN CONTENT --- */}
                    <div className="px-4 md:px-0 grid lg:grid-cols-12 gap-8">
                        
                        {/* LEFT SIDEBAR (Controls) */}
                        <div className="lg:col-span-4 space-y-6">
                            
                            {/* CARD 1: UPLOAD */}
                            <div className={`glass-card p-6 relative overflow-hidden ${error ? 'border-red-200 bg-red-50/30' : ''}`}>
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        <span className="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-xs text-slate-500">1</span>
                                        Upload Data
                                    </h2>
                                    <IconFile />
                                </div>
                                
                                <div 
                                    className={`border-2 border-dashed rounded-xl p-8 text-center transition-all cursor-pointer group
                                        ${isDragging ? 'border-amber-500 bg-amber-50' : 'border-slate-200 hover:border-amber-300 hover:bg-slate-50'}
                                        ${file ? 'bg-emerald-50 border-emerald-200' : ''}
                                    `}
                                    onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop} onClick={() => document.getElementById('fileInput').click()}
                                >
                                    <input id="fileInput" type="file" className="hidden" accept=".xlsx,.xls" onChange={handleFileSelect} />
                                    
                                    {file ? (
                                        <div className="animate-in fade-in zoom-in duration-300">
                                            <IconCheck />
                                            <p className="font-bold text-slate-700 break-all line-clamp-1">{file.name}</p>
                                            <p className="text-xs text-slate-400 mt-1">{(file.size / 1024).toFixed(1)} KB</p>
                                            <button onClick={clearFile} className="text-xs font-bold text-red-500 hover:text-red-700 mt-3 py-1 px-3 bg-white rounded border border-red-100 shadow-sm">Change File</button>
                                        </div>
                                    ) : (
                                        <div className="group-hover:translate-y-[-2px] transition-transform">
                                            <IconUpload />
                                            <p className="font-medium text-slate-600">Click to upload Excel</p>
                                            <p className="text-xs text-slate-400 mt-2">.xlsx or .xls files</p>
                                        </div>
                                    )}
                                </div>

                                {error && (
                                    <div className="mt-4 p-4 bg-white border border-red-100 text-red-600 text-xs rounded-lg flex items-start gap-3 shadow-sm animate-in slide-in-from-top-2">
                                        <IconAlert />
                                        <div>
                                            <p className="font-bold">Validation Error</p>
                                            <p className="mt-1 opacity-90">{error}</p>
                                        </div>
                                    </div>
                                )}
                                
                                {!error && (
                                    <div className="mt-4 p-3 bg-slate-50 text-slate-500 text-xs rounded-lg border border-slate-100">
                                        <p className="font-semibold mb-1 text-slate-700">Template Requirements:</p>
                                        <ul className="list-disc pl-4 space-y-1">
                                            <li>Column: <strong>Period</strong> (Date)</li>
                                            <li>Column: <strong>Sales_quantity</strong> (Number)</li>
                                        </ul>
                                    </div>
                                )}
                            </div>

                            {/* CARD 2: SETTINGS */}
                            <div className="glass-card p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        <span className="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-xs text-slate-500">2</span>
                                        Configuration
                                    </h2>
                                    <IconSettings />
                                </div>
                                
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Forecasting Engine</label>
                                <div className="relative">
                                    <select 
                                        value={modelType} 
                                        onChange={(e) => setModelType(e.target.value)}
                                        className="w-full p-3 pl-4 pr-10 border border-slate-200 rounded-xl bg-slate-50 text-slate-700 font-medium focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none appearance-none transition-all cursor-pointer hover:bg-white"
                                    >
                                        <option value="auto">‚ú® Automatic (AI Best Fit)</option>
                                        <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                                        <option value="ses">1Ô∏è‚É£ SES</option>
                                        <option value="des">2Ô∏è‚É£ DES</option>
                                        <option value="tes">3Ô∏è‚É£ TES</option>
                                        <option value="prophet">4Ô∏è‚É£ PRO</option>
                                        <option value="arima">5Ô∏è‚É£ ARI</option>
                                    </select>
                                    <div className="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={handleProcess} 
                                    disabled={!file || isLoading || error} 
                                    className={`w-full mt-6 py-4 px-6 rounded-xl font-bold text-sm uppercase tracking-wider shadow-lg flex items-center justify-center gap-3 btn-gold ${!file || isLoading || error ? 'opacity-50 cursor-not-allowed' : ''}`}
                                >
                                    {isLoading ? (
                                        <><span className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span> Running Analysis...</>
                                    ) : (
                                        <>Run Forecast <span className="text-lg">‚Üí</span></>
                                    )}
                                </button>
                            </div>
                        </div>

                        {/* RIGHT COLUMN (RESULTS) */}
                        <div className="lg:col-span-8">
                            <div className="glass-card p-6 h-full min-h-[600px] flex flex-col relative">
                                <div className="flex justify-between items-start mb-8">
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                            <IconActivity /> 
                                            Forecast Analytics
                                        </h2>
                                        <p className="text-sm text-slate-400 mt-1">Visualizing historical data and future trends</p>
                                    </div>
                                    
                                    {resultData && (
                                        <div className="flex flex-col items-end animate-in fade-in slide-in-from-right-4">
                                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Selected Model</span>
                                            <span className={`text-sm font-bold px-3 py-1 rounded-full border ${resultData.mode === 'auto' ? 'bg-purple-50 text-purple-700 border-purple-200' : 'bg-blue-50 text-blue-700 border-blue-200'}`}>
                                                {resultData.mode === 'auto' ? `üèÜ Winner: ${resultData.model_name}` : `‚öôÔ∏è ${resultData.model_name}`}
                                            </span>
                                        </div>
                                    )}
                                </div>

                                <div className="flex-grow bg-slate-50 rounded-2xl border border-slate-100 p-4 flex flex-col justify-center relative">
                                    {!resultData && !isLoading && (
                                        <div className="text-center opacity-40">
                                            <img src="./grayscale_transparent.png" className="h-16 mx-auto mb-4 opacity-50 grayscale" />
                                            <p className="text-slate-500 font-medium">Ready for analysis</p>
                                        </div>
                                    )}

                                    {isLoading && (
                                        <div className="text-center">
                                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-amber-100 border-t-amber-500 mb-4"></div>
                                            <p className="text-slate-500 font-medium animate-pulse">Crunching numbers...</p>
                                        </div>
                                    )}

                                    {resultData && (
                                        <div className="w-full h-[450px] animate-in fade-in zoom-in duration-500">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <ComposedChart data={[...resultData.history, ...resultData.forecast]} margin={{ top: 20, right: 30, left: 0, bottom: 0 }}>
                                                    <defs>
                                                        <linearGradient id="colorActual" x1="0" y1="0" x2="0" y2="1">
                                                            <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.1}/>
                                                            <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                                                        </linearGradient>
                                                    </defs>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                    <XAxis 
                                                        dataKey="name" 
                                                        axisLine={false} 
                                                        tickLine={false} 
                                                        tick={{fill: '#64748b', fontSize: 11, fontWeight: 500}} 
                                                        dy={10}
                                                    />
                                                    <YAxis 
                                                        axisLine={false} 
                                                        tickLine={false} 
                                                        tick={{fill: '#64748b', fontSize: 11, fontWeight: 500}} 
                                                    />
                                                    <Tooltip content={<CustomTooltip />} cursor={{stroke: '#cbd5e1', strokeWidth: 1}} />
                                                    <Legend verticalAlign="top" height={36} iconType="circle" />
                                                    
                                                    <Area type="monotone" dataKey="actual" name="Actual Sales" stroke="#3b82f6" strokeWidth={2} fillOpacity={1} fill="url(#colorActual)" />
                                                    
                                                    <Line 
                                                        connectNulls={true}
                                                        type="monotone" 
                                                        dataKey="fitted" 
                                                        name="Model Fit" 
                                                        stroke="#8b5cf6" 
                                                        strokeWidth={2} 
                                                        strokeDasharray="6 6" 
                                                        dot={<CustomFittedDot />} 
                                                    />
                                                    
                                                    <Line 
                                                        type="monotone" 
                                                        dataKey="forecast" 
                                                        name="Forecast" 
                                                        stroke="#10b981" 
                                                        strokeWidth={3} 
                                                        strokeDasharray="0" 
                                                        dot={<CustomForecastDot />} 
                                                        activeDot={{ r: 6, strokeWidth: 0 }}
                                                    />
                                                </ComposedChart>
                                            </ResponsiveContainer>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>