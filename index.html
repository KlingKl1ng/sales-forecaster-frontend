<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Forecaster</title>
    
    <!-- 1. Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React 17 (Stable) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.development.js"></script>
    
    <!-- 3. Helper for Charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    
    <!-- 4. Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/1.8.5/Recharts.min.js"></script>
    
    <!-- 5. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans p-4 md:p-8">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const Recharts = window.Recharts || {};
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Area, AreaChart, ComposedChart } = Recharts;

        // --- 1. CUSTOM FORECAST DOT (Green) ---
        const CustomForecastDot = (props) => {
            const { cx, cy, payload } = props;
            if (payload && payload.name && payload.name.includes("(fc)")) {
                return <circle cx={cx} cy={cy} r={3} stroke="#10b981" strokeWidth={2} fill="white" />;
            }
            return null;
        };

        // --- 2. CUSTOM FITTED DOT (Purple) ---
        const CustomFittedDot = (props) => {
            const { cx, cy, payload } = props;
            if (payload && payload.forecast !== undefined && !payload.name.includes("(fc)")) {
                 return <circle cx={cx} cy={cy} r={3} stroke="#8b5cf6" strokeWidth={2} fill="white" />;
            }
            return null;
        };

        // --- CUSTOM TOOLTIP ---
        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                const isFuture = label && label.includes("(fc)");
                return (
                    <div className="bg-white p-3 border border-slate-200 shadow-lg rounded-lg text-sm opacity-95">
                        <p className="font-bold mb-2 text-slate-700">{label}</p>
                        {payload.map((entry, index) => {
                            if (entry.name === "Forecast" && !isFuture) return null;
                            
                            return (
                                <p key={index} style={{ color: entry.color }} className="flex items-center gap-2 mb-1 last:mb-0">
                                    <span className="w-2 h-2 rounded-full" style={{ backgroundColor: entry.color }}></span>
                                    <span className="font-medium">{entry.name}:</span> 
                                    <span>{entry.value}</span>
                                </p>
                            );
                        })}
                    </div>
                );
            }
            return null;
        };

        // --- ICONS ---
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-10 w-10 text-slate-400 mx-auto mb-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const IconFile = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-600 h-5 w-5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>;
        const IconActivity = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-600 h-8 w-8"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-10 w-10 text-green-500 mx-auto mb-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 flex-shrink-0 mt-0.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>;
        const IconInfo = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>;

        const App = () => {
            const [file, setFile] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [resultData, setResultData] = useState(null);
            const [error, setError] = useState(null);
            const [isDragging, setIsDragging] = useState(false);

            const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
            const handleDragLeave = () => { setIsDragging(false); };
            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) validateAndSetFile(e.dataTransfer.files[0]);
            };
            const handleFileSelect = (e) => {
                if (e.target.files && e.target.files[0]) validateAndSetFile(e.target.files[0]);
            };

            const validateAndSetFile = (uploadedFile) => {
                setError(null);
                setResultData(null);
                const validExtensions = /\.(xlsx|xls)$/i;
                if (!uploadedFile.name.match(validExtensions)) {
                    setError("Invalid file type. Please upload an Excel file (.xlsx or .xls).");
                    return;
                }
                setFile(uploadedFile);
            };

            const clearFile = (e) => {
                if (e) e.stopPropagation();
                setFile(null);
                setResultData(null);
                setError(null);
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.value = '';
            };

            const handleProcess = async () => {
                if (!file) return;
                setIsLoading(true);
                setError(null);
                const formData = new FormData();
                formData.append('file', file);

                try {
                    // IMPORTANT: IF YOU DEPLOY TO RENDER, CHANGE THIS URL
                    // Example: https://sales-forecaster-xyz.onrender.com/predict
                    const response = await fetch('https://sales-forecaster-backend.onrender.com/predict', {
                        method: 'POST',
                        body: formData,
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.detail || "Failed to process file.");
                    setResultData(data);
                } catch (err) {
                    console.error("Upload Error:", err);
                    setError(err.message + " (Check Connection)");
                    setResultData(null);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="max-w-6xl mx-auto">
                    <header className="mb-10 text-center">
                        <h1 className="text-3xl md:text-4xl font-bold text-slate-800 mb-1 flex items-center justify-center gap-3">
                            <IconActivity />
                            Sales Forecaster
                        </h1>
                        <p className="text-sm text-slate-400 font-medium mb-2">Copyright by Operatis</p>
                        <div className="mt-4 inline-flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-full text-xs font-medium border border-green-200">
                            <IconInfo />
                            Ready to Forecast
                        </div>
                    </header>

                    <div className="grid md:grid-cols-3 gap-6">
                        <div className="md:col-span-1 space-y-4">
                            <div className={`bg-white rounded-xl shadow-sm border transition-colors p-6 ${error ? 'border-red-200' : 'border-slate-200'}`}>
                                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2"><IconFile /> 1. Upload Data</h2>
                                <div 
                                    className={`border-2 border-dashed rounded-lg p-8 text-center transition-all cursor-pointer relative ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-slate-300 hover:border-blue-400 hover:bg-slate-50'} ${file ? 'bg-green-50 border-green-400' : ''} ${error ? 'bg-red-50 border-red-300' : ''}`}
                                    onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop} onClick={() => document.getElementById('fileInput').click()}
                                >
                                    <input id="fileInput" type="file" className="hidden" accept=".xlsx,.xls" onChange={handleFileSelect} />
                                    {file ? (
                                        <div className="animate-in fade-in zoom-in duration-300"><IconCheck /><p className="font-medium text-slate-700 break-all">{file.name}</p><button onClick={clearFile} className="text-xs text-red-500 underline mt-2 hover:text-red-700 z-10 relative">Remove</button></div>
                                    ) : (
                                        <React.Fragment>
                                            <IconUpload />
                                            <p className="font-medium text-slate-700">Click to upload</p>
                                            <p className="text-sm text-slate-500 mt-1">.xlsx or .xls only</p>
                                        </React.Fragment>
                                    )}
                                </div>
                                {error && <div className="mt-4 p-4 bg-red-50 border border-red-100 text-red-700 text-sm rounded-lg flex items-start gap-3"><IconX /><div><p className="font-semibold">Upload Failed</p><p className="text-red-600 mt-1">{error}</p></div></div>}
                                {!error && <div className="mt-4 p-3 bg-blue-50 text-blue-700 text-xs rounded-lg border border-blue-100"><strong>Required Columns:</strong><br/>1. Period (Date)<br/>2. Sales_quantity (Number)</div>}
                                <button onClick={handleProcess} disabled={!file || isLoading || error} className={`w-full mt-6 py-3 px-4 rounded-lg font-medium text-white flex items-center justify-center gap-2 transition-all ${!file || isLoading || error ? 'bg-slate-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-lg'}`}>{isLoading ? 'Processing...' : 'Run Forecast'}</button>
                            </div>
                        </div>
                        <div className="md:col-span-2">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 h-full min-h-[500px]">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-lg font-semibold flex items-center gap-2"><IconActivity /> 2. Forecast Results</h2>
                                    {resultData && <span className="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded border border-purple-200">Winner: {resultData.model_name}</span>}
                                </div>
                                {!resultData && !isLoading && <div className="h-96 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-100 rounded-xl"><p>Uploadddddd a file and click Runnnnnnn.</p></div>}
                                {isLoading && <div className="h-96 flex flex-col items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-600 mb-4"></div><p className="text-slate-500 animate-pulse">Running Analytics And Choosing Best Model...</p></div>}
                                {resultData && (
                                    <div className="h-[400px] w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <ComposedChart data={[...resultData.history, ...resultData.forecast]} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                                                <defs>
                                                    <linearGradient id="colorActual" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#3b82f6" stopOpacity={0.1}/><stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/></linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#64748b', fontSize: 12}} />
                                                <YAxis axisLine={false} tickLine={false} tick={{fill: '#64748b', fontSize: 12}} />
                                                
                                                <Tooltip content={<CustomTooltip />} />
                                                <Legend verticalAlign="top" height={36}/>
                                                
                                                {/* 1. Actual (Area) */}
                                                <Area type="monotone" dataKey="actual" name="Actual Sales" stroke="#3b82f6" strokeWidth={2} fillOpacity={1} fill="url(#colorActual)" />
                                                
                                                {/* 2. Fitted (Purple - Dashed) */}
                                                <Line 
                                                    connectNulls={true}
                                                    type="monotone" 
                                                    dataKey="fitted" 
                                                    name="Model Fit" 
                                                    stroke="#8b5cf6" 
                                                    strokeWidth={3} 
                                                    strokeDasharray="10 10" 
                                                    dot={<CustomFittedDot />} 
                                                />
                                                
                                                {/* 3. Forecast (Green - Dotted - Green Dots) */}
                                                <Line 
                                                    type="monotone" 
                                                    dataKey="forecast" 
                                                    name="Forecast" 
                                                    stroke="#10b981" 
                                                    strokeWidth={3} 
                                                    strokeDasharray="4 4" 
                                                    dot={<CustomForecastDot />} 
                                                />
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
